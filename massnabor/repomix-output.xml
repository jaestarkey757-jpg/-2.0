This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
App.tsx
components/Chest.tsx
components/CoinSystem.tsx
components/DevMenuModal.tsx
components/Experience.tsx
components/GameModals.tsx
components/ImageCropper.tsx
components/Overlay.tsx
components/Sidebar.tsx
components/SoundManager.ts
components/SpecialItem.tsx
components/ui/GlassCard.tsx
favicon.ico
hooks/useGameSounds.ts
index.html
index.tsx
Massonabor.png
metadata.json
package.json
pages/Calories.tsx
pages/Habits.tsx
pages/History.tsx
pages/Inventory.tsx
pages/Profile.tsx
pages/Sport.tsx
pages/Store.tsx
pages/Tasks.tsx
README.md
services/ai.ts
services/repository.ts
start.bat
start.txt
tsconfig.json
types.ts
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="App.tsx">
import React, { useState, useEffect } from 'react';
import { repo } from './services/repository';
import { Sidebar } from './components/Sidebar';
import { SoundManager } from './components/SoundManager';
import { TasksPage } from './pages/Tasks';
import { CaloriesPage } from './pages/Calories';
import { SportPage } from './pages/Sport';
import { HabitsPage } from './pages/Habits';
import { ProfilePage } from './pages/Profile';
import { HistoryPage } from './pages/History';
import { StorePage } from './pages/Store';
import { InventoryPage } from './pages/Inventory';
import { RankUpModal } from './components/GameModals';
import { Task, FoodEntry, SportEntry, UserProfile, HABITS, RANKS } from './types';
import { Toaster, toast } from 'react-hot-toast';
import confetti from 'canvas-confetti';
import { DevMenuModal } from './components/DevMenuModal';

const ToastContainer = ({ toasts }: { toasts: { id: number, msg: string, type: string }[] }) => (
    <div className="fixed bottom-5 right-5 z-50 flex flex-col gap-2">
        {toasts.map(t => (
            <div key={t.id} className={`px-4 py-3 rounded-xl shadow-lg border backdrop-blur-md animate-in slide-in-from-bottom-5 duration-300 ${
                t.type === 'achievement' ? 'bg-yellow-500/20 border-yellow-500 text-yellow-200' :
                t.type === 'success' ? 'bg-green-500/20 border-green-500 text-green-200' :
                'bg-slate-800/90 border-white/10 text-white'
            }`}>
                {t.msg}
            </div>
        ))}
    </div>
);

const HISTORY_TAB = 99;
const PROFILE_TAB = 100;

const App: React.FC = () => {
  const [currentTab, setCurrentTab] = useState(0);
  const [previousTab, setPreviousTab] = useState(0); 
  const [dataVersion, setDataVersion] = useState(0); 
  const [toasts, setToasts] = useState<{ id: number, msg: string, type: string }[]>([]);
  
  const [showRankUp, setShowRankUp] = useState<number | null>(null);
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
  const [showDevMenu, setShowDevMenu] = useState(false); 

  const today = new Date().toISOString().split('T')[0];
  
  const profile = { ...repo.getProfile() }; 
  const tasks = repo.getTasks();
  const foodEntries = repo.getFoodEntries(today);
  const sportEntries = repo.getSportEntries(today);
  const water = repo.getWater(today);
  const habits = repo.getHabits(today);
  const weightHistory = repo.getWeightHistory();
  const achievements = repo.getData().achievements;

  const refresh = () => {
      setDataVersion(v => v + 1);
      
      const currentRankIndex = RANKS.findIndex(r => r.title === RANKS.reduce((prev, curr) => (repo.getProfile().xp >= curr.threshold ? curr : prev), RANKS[0]).title);
      if (currentRankIndex > repo.getProfile().last_seen_rank_index) {
          setShowRankUp(currentRankIndex);
      }
  };

  useEffect(() => {
    try {
        localStorage.setItem('__test__', '1');
        localStorage.removeItem('__test__');
    } catch (e) {
        toast.error("–í–ù–ò–ú–ê–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ! –í–∫–ª—é—á–∏—Ç–µ cookie/localStorage.", { duration: 10000 });
    }

    SoundManager.setNotifier((msg, type = 'info') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, msg, type }]);
        setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 5000);
    });
    
    repo.checkDailyReset(); 
    repo.checkStreak();
    refresh();
    
    if ("Notification" in window && Notification.permission !== "granted") {
        Notification.requestPermission();
    }

    const unlockAudio = () => {
        SoundManager.init();
        document.removeEventListener('click', unlockAudio);
    };
    document.addEventListener('click', unlockAudio);

    const handleKeyDown = (e: KeyboardEvent) => {
        const tag = (e.target as HTMLElement).tagName;
        if (tag === 'INPUT' || tag === 'TEXTAREA') {
            SoundManager.playTypingSound();
        }
    };
    window.addEventListener('keydown', handleKeyDown);

    const handleMouseMove = (e: MouseEvent) => {
        setMousePos({ 
            x: (e.clientX / window.innerWidth) * 2 - 1, 
            y: (e.clientY / window.innerHeight) * 2 - 1 
        });
    };
    window.addEventListener('mousemove', handleMouseMove);

    return () => {
        document.removeEventListener('click', unlockAudio);
        window.removeEventListener('keydown', handleKeyDown);
        window.removeEventListener('mousemove', handleMouseMove);
    };
  }, []);

  const triggerConfetti = () => {
      const duration = 3000;
      const end = Date.now() + duration;

      (function frame() {
        confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#22d3ee', '#f472b6', '#fbbf24'] });
        confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#22d3ee', '#f472b6', '#fbbf24'] });
        if (Date.now() < end) requestAnimationFrame(frame);
      }());
  };

  const switchTo = (tab: number) => {
    setPreviousTab(currentTab);
    setCurrentTab(tab);
  };

  const goBack = () => {
    if (previousTab === HISTORY_TAB || previousTab === PROFILE_TAB) setCurrentTab(0);
    else setCurrentTab(previousTab);
  };

  // --- Actions ---
  const handleAddTask = (t: Omit<Task, 'id'>) => { repo.addTask(t); repo.addXp(10); SoundManager.playSuccess(); refresh(); };
  const handleUpdateTask = (t: Task) => { repo.updateTask(t); refresh(); };
  const handleDeleteTask = (id: number) => { repo.deleteTask(id); repo.addXp(-10); refresh(); };
  const handleCompleteTask = (id: number) => { 
      repo.completeTask(id, today); 
      SoundManager.playSuccess("–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! +15 XP"); 
      triggerConfetti();
      refresh(); 
  };

  const handleAddFood = (f: Omit<FoodEntry, 'id'>) => {
    const prevTotal = repo.getFoodEntries(today).reduce((a,b) => a + b.kcal, 0);
    repo.addFood(f);
    const newTotal = repo.getFoodEntries(today).reduce((a,b) => a + b.kcal, 0);
    repo.addXp(5);
    SoundManager.playSuccess();
    
    if (prevTotal < 3000 && newTotal >= 3000) { triggerConfetti(); SoundManager.playGoal(); }
    if (newTotal >= 4000) checkAchievement('burnout');
    refresh();
  };

  const handleUpdateWater = (amount: number) => {
    const prevWater = repo.getWater(today);
    repo.setWater(today, amount);
    const diff = amount - prevWater;
    
    if (Math.abs(diff) >= 1) {
        const xpChange = Math.floor(diff / 250) * 2;
        if (xpChange !== 0) repo.addXp(xpChange);
    }
    if (prevWater < 3000 && amount >= 3000) { triggerConfetti(); SoundManager.playGoal(); }
    if (amount >= 4000) checkAchievement('hydro_homie');
    refresh();
  };
  
  const handleResetWater = () => {
      const prevWater = repo.getWater(today);
      if (prevWater > 0) {
          repo.setWater(today, 0);
          const xpToRemove = Math.floor(prevWater / 250) * 2;
          if (xpToRemove > 0) repo.addXp(-xpToRemove);
          refresh();
      }
  };

  // –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–ü–û–†–¢–ê: –¢–ï–ü–ï–†–¨ –ò–ù–¢–ï–ù–°–ò–í–ù–û–°–¢–¨ –î–ê–ï–¢ –†–ê–ó–ù–´–ô XP!
  const handleAddSport = (s: Omit<SportEntry, 'id'>) => {
    repo.addSport(s); 
    
    // –°–º–æ—Ç—Ä–∏–º, –∫–∞–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Å–ø—Ä—è—Ç–∞–Ω–∞ –≤ –¥–µ—Ç–∞–ª—è—Ö
    let sportXp = 15; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (–°—Ä–µ–¥–Ω—è—è)
    if (s.details.includes('[–¢—è–∂–µ–ª–∞—è]')) sportXp = 25;
    else if (s.details.includes('[–õ–µ–≥–∫–∞—è]')) sportXp = 10;
    
    repo.addXp(sportXp); 
    SoundManager.playSuccess();
    
    if (repo.getSportEntries(today).length >= 5) checkAchievement('iron_temple');
    refresh();
  };

  const handleToggleHabit = (habit: string) => {
    const added = repo.toggleHabit(today, habit);
    if (added) {
        repo.addXp(10); SoundManager.playSuccess();
        if (repo.getHabits(today).length >= HABITS.length) { triggerConfetti(); checkAchievement('habit_god'); }
    } else {
        repo.addXp(-10);
    }
    refresh();
  };

  const handleUpdateProfile = (p: Partial<UserProfile>) => { repo.updateProfile(p); refresh(); };

  const handleBuyFreeze = () => {
    const success = repo.buyFreeze(500); 
    if (success) { SoundManager.playSuccess('–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞!'); refresh(); }
    return success;
  };
  
  const handleBuyGoldenDay = () => {
      const success = repo.buyGoldenDay(5000);
      if (success) { SoundManager.playSuccess('–ó–æ–ª–æ—Ç—ã–µ —Å—É—Ç–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã!'); triggerConfetti(); refresh(); }
      return success;
  }

  const checkAchievement = (code: string) => {
    if (repo.unlockAchievement(code)) { SoundManager.playAchievement(); triggerConfetti(); }
    if (repo.getProfile().xp >= 10000) checkAchievement('giga_chad');
    if (repo.getProfile().streak >= 30) checkAchievement('monk_mode');
  };

  useEffect(() => {
    const interval = setInterval(() => {
        repo.checkDailyReset(); 

        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeStr = `${hours}:${minutes}`;

        const currentTasks = repo.getTasks();
        const currentDayMask = 1 << (now.getDay() === 0 ? 6 : now.getDay() - 1);

        currentTasks.forEach(t => {
            if (!t.enabled || t.last_notified === today || ((t.days_mask & currentDayMask) === 0)) return;
            if (t.t_hhmm === timeStr) {
                t.last_notified = today;
                repo.updateTask(t);
                SoundManager.playNotification(t.title);
                toast(`‚è∞ ${t.title}`, { duration: 5000, icon: '‚è∞' });
                refresh();
            }
        });
    }, 5000);
    return () => clearInterval(interval);
  }, [today]);

  return (
    <div className="flex h-screen w-full bg-[#0f172a] text-slate-100 overflow-hidden font-sans perspective-1000">
      <Sidebar 
        currentTab={currentTab} 
        onSwitch={(idx) => { setPreviousTab(idx); setCurrentTab(idx); }} 
        onProfileClick={() => switchTo(PROFILE_TAB)}
        profile={profile} 
        onSecretClick={() => setShowDevMenu(true)}
      />
      
      <main className="flex-1 p-6 relative overflow-hidden">
        {/* Parallax Background Blobs */}
        <div className="absolute top-[-20%] right-[-10%] w-[500px] h-[500px] bg-cyan-500/10 rounded-full blur-[120px] pointer-events-none transition-transform duration-100 ease-out" style={{ transform: `translate(${mousePos.x * -20}px, ${mousePos.y * -20}px)` }} />
        <div className="absolute bottom-[-20%] left-[-10%] w-[500px] h-[500px] bg-blue-600/10 rounded-full blur-[120px] pointer-events-none transition-transform duration-100 ease-out" style={{ transform: `translate(${mousePos.x * -30}px, ${mousePos.y * -30}px)` }} />
        <div className="absolute top-[40%] left-[40%] w-[300px] h-[300px] bg-purple-500/5 rounded-full blur-[100px] pointer-events-none transition-transform duration-100 ease-out" style={{ transform: `translate(${mousePos.x * 40}px, ${mousePos.y * 40}px)` }} />
        
        <div className="relative z-10 h-full">
            {currentTab === 0 && <TasksPage tasks={tasks} onAdd={handleAddTask} onUpdate={handleUpdateTask} onDelete={handleDeleteTask} onComplete={handleCompleteTask} />}
            {currentTab === 1 && <CaloriesPage entries={foodEntries} water={water} onAddFood={handleAddFood} onDeleteFood={(id) => { repo.deleteFood(id); repo.addXp(-5); refresh(); }} onUpdateWater={handleUpdateWater} onResetWater={handleResetWater} onGoToHistory={() => switchTo(HISTORY_TAB)} />}
            {currentTab === 2 && <SportPage entries={sportEntries} onAdd={handleAddSport} onDelete={(id) => { repo.deleteSport(id); repo.addXp(-15); refresh(); }} onGoToHistory={() => switchTo(HISTORY_TAB)} />}
            {currentTab === 3 && <HabitsPage completedHabits={habits} onToggle={handleToggleHabit} />}
            {currentTab === 4 && <StorePage profile={profile} onBuyFreeze={handleBuyFreeze} onBuyGoldenHour={handleBuyGoldenDay} />}
            {currentTab === 5 && <InventoryPage profile={profile} onRefresh={refresh} />}
            {currentTab === HISTORY_TAB && <HistoryPage onBack={goBack} />}
            {currentTab === PROFILE_TAB && <ProfilePage profile={profile} weightHistory={weightHistory} achievements={achievements} onUpdateProfile={handleUpdateProfile} onLogWeight={(w) => repo.logWeight(today, w)} onBack={goBack} />}
        </div>
      </main>
      
      {showRankUp !== null && (
          <RankUpModal 
             newRankIndex={showRankUp} 
             onClose={() => { repo.updateLastSeenRank(showRankUp); setShowRankUp(null); }} 
          />
      )}
      
      <ToastContainer toasts={toasts} />
      <Toaster position="top-center" />
      {showDevMenu && (
          <DevMenuModal 
              profile={profile} 
              onClose={() => setShowDevMenu(false)} 
              onRefresh={refresh} 
          />
      )}
    </div>
  );
};
export default App;
</file>

<file path="components/Chest.tsx">
import React, { useRef, useState, useMemo, useEffect } from 'react';
import { useSpring, animated, config } from '@react-spring/three';
import { RoundedBox } from '@react-three/drei';
import { AppState, ChestType } from '../types';
import * as THREE from 'three';

interface ChestProps {
  appState: AppState;
  type: ChestType;
  onOpen: () => void;
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à
let cachedImperfectionTexture: THREE.CanvasTexture | null = null;

// –ì–∏–ø–µ—Ä-–±—ã—Å—Ç—Ä—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç—É—Ä—ã
const generateImperfectionTexture = () => {
    if (cachedImperfectionTexture) return cachedImperfectionTexture;

    const canvas = document.createElement('canvas');
    // –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–æ 128x128 (—ç—Ç–æ–≥–æ –±–æ–ª–µ–µ —á–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–∞–º–ø-–º–∞–ø—ã)
    canvas.width = 128;
    canvas.height = 128;
    const ctx = canvas.getContext('2d');
    if (!ctx) return null;

    ctx.fillStyle = '#808080';
    ctx.fillRect(0, 0, 128, 128);

    // –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏—è –ø–∏–∫—Å–µ–ª—è–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ ~100 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –≤—ã–∑–æ–≤—ã fillRect
    const imgData = ctx.getImageData(0, 0, 128, 128);
    const data = imgData.data;
    for (let i = 0; i < data.length; i += 4) {
        if (Math.random() > 0.8) {
            const shade = Math.floor(Math.random() * 255);
            data[i] = data[i+1] = data[i+2] = shade;
        }
    }
    ctx.putImageData(imgData, 0, 0);
    
    // –¶–∞—Ä–∞–ø–∏–Ω—ã
    ctx.strokeStyle = 'rgba(0,0,0,0.15)';
    ctx.lineWidth = 1;
    for(let i=0; i< 30; i++) {
        ctx.beginPath();
        const x = Math.random() * 128;
        const y = Math.random() * 128;
        ctx.moveTo(x, y);
        ctx.lineTo(x + (Math.random() - 0.5) * 40, y + (Math.random() - 0.5) * 40);
        ctx.stroke();
    }

    const texture = new THREE.CanvasTexture(canvas);
    texture.wrapS = THREE.RepeatWrapping;
    texture.wrapT = THREE.RepeatWrapping;
    texture.repeat.set(4, 4); // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –º–∞–ª–µ–Ω—å–∫—É—é —Ç–µ–∫—Å—Ç—É—Ä—É
    
    cachedImperfectionTexture = texture;
    return texture;
};

export const Chest: React.FC<ChestProps> = ({ appState, type, onOpen }) => {
  const [hovered, setHovered] = useState(false);
  const group = useRef<THREE.Group>(null);
  const [roughnessMap, setRoughnessMap] = useState<THREE.Texture | null>(null);

  useEffect(() => {
    const tex = generateImperfectionTexture();
    setRoughnessMap(tex);
  }, []);

  const { lidRotation } = useSpring({
    lidRotation: appState !== AppState.IDLE && appState !== AppState.MENU ? -Math.PI / 1.5 : 0,
    config: { mass: 1, tension: 170, friction: 14 },
  });

  const { scale } = useSpring({
    scale: hovered && appState === AppState.IDLE ? 1.05 : 1,
    config: config.wobbly,
  });

  const materials = useMemo(() => {
    let bodyColor = '#5d4037';
    let trimColor = '#9e9e9e'; 
    let trimMetalness = 0.6;
    let trimRoughness = 0.4;
    
    switch (type) {
      case ChestType.COMMON:
        bodyColor = '#3E2723'; 
        trimColor = '#455A64'; 
        trimMetalness = 0.4;
        break;
      case ChestType.RARE:
        bodyColor = '#1565C0'; 
        trimColor = '#EEEEEE'; 
        trimMetalness = 0.9;
        trimRoughness = 0.3;
        break;
      case ChestType.EPIC:
        bodyColor = '#4A148C'; 
        trimColor = '#FFD700'; 
        trimMetalness = 1.0;
        trimRoughness = 0.25;
        break;
    }

    const commonProps = {
        roughnessMap: roughnessMap,
        bumpMap: roughnessMap,
        bumpScale: 0.005,
    };

    return {
      body: new THREE.MeshStandardMaterial({ 
        color: bodyColor, 
        roughness: 0.8, 
        metalness: 0.05,
        ...commonProps
      }),
      trim: new THREE.MeshStandardMaterial({ 
        color: trimColor, 
        roughness: trimRoughness, 
        metalness: trimMetalness,
        envMapIntensity: 1.2,
        ...commonProps
      }),
      lock: new THREE.MeshStandardMaterial({
        color: type === ChestType.EPIC ? '#ff0000' : '#263238',
        roughness: 0.4,
        metalness: 0.8,
        emissive: type === ChestType.EPIC ? '#500000' : '#000000',
        ...commonProps
      }),
      inside: new THREE.MeshStandardMaterial({
        color: '#0f0500', 
        roughness: 1,
        side: THREE.DoubleSide
      })
    };
  }, [type, roughnessMap]);

  const BoxPart = ({ args, radius = 0.02, smoothness = 4, material, ...props }: any) => (
    <RoundedBox args={args} radius={radius} smoothness={smoothness} {...props} material={material} />
  );

  return (
    <animated.group 
      ref={group} 
      scale={scale}
      onClick={(e) => {
        e.stopPropagation();
        if (appState === AppState.IDLE) {
          onOpen();
        }
      }}
      onPointerOver={() => setHovered(true)}
      onPointerOut={() => setHovered(false)}
    >
      <group position={[0, 0.5, 0]}>
        <BoxPart position={[0, -0.45, 0]} args={[1.8, 0.1, 1.2]} material={materials.body} castShadow receiveShadow />
        <BoxPart position={[0, 0, 0.55]} args={[1.8, 0.8, 0.1]} material={materials.body} castShadow receiveShadow />
        <BoxPart position={[0, 0, -0.55]} args={[1.8, 0.8, 0.1]} material={materials.body} castShadow receiveShadow />
        <BoxPart position={[-0.85, 0, 0]} args={[0.1, 0.8, 1.0]} material={materials.body} castShadow receiveShadow />
        <BoxPart position={[0.85, 0, 0]} args={[0.1, 0.8, 1.0]} material={materials.body} castShadow receiveShadow />
        <mesh position={[0, -0.4, 0]} material={materials.inside}>
            <boxGeometry args={[1.6, 0.05, 1.0]} />
        </mesh>
        <BoxPart position={[-0.86, 0, 0.56]} args={[0.14, 0.82, 0.14]} radius={0.01} material={materials.trim} castShadow />
        <BoxPart position={[0.86, 0, 0.56]} args={[0.14, 0.82, 0.14]} radius={0.01} material={materials.trim} castShadow />
        <BoxPart position={[-0.86, 0, -0.56]} args={[0.14, 0.82, 0.14]} radius={0.01} material={materials.trim} castShadow />
        <BoxPart position={[0.86, 0, -0.56]} args={[0.14, 0.82, 0.14]} radius={0.01} material={materials.trim} castShadow />
      </group>

      <animated.group position={[0, 0.9, -0.5]} rotation-x={lidRotation}>
        <group position={[0, 0, 0.5]}> 
          <BoxPart position={[0, 0.15, 0]} args={[1.8, 0.3, 1.2]} radius={0.04} material={materials.body} castShadow receiveShadow />
          <BoxPart position={[0, 0.35, 0]} args={[1.6, 0.1, 1.0]} radius={0.03} material={materials.body} castShadow receiveShadow />
          <BoxPart position={[0, 0.15, 0]} args={[0.22, 0.32, 1.22]} radius={0.01} material={materials.trim} castShadow />
          <BoxPart position={[0, 0.15, 0.6]} args={[1.82, 0.22, 0.12]} radius={0.01} material={materials.trim} castShadow />
        </group>
      </animated.group>

      <BoxPart position={[0, 0.6, 0.6]} args={[0.3, 0.3, 0.15]} radius={0.02} material={materials.lock} castShadow />
    </animated.group>
  );
};
</file>

<file path="components/CoinSystem.tsx">
import React, { useRef, useMemo, useEffect } from 'react';
import { useFrame } from '@react-three/fiber';
import * as THREE from 'three';
import { AppState, CoinData } from '../types';

interface CoinSystemProps {
  appState: AppState;
  count: number;
}

export const CoinSystem: React.FC<CoinSystemProps> = ({ appState, count }) => {
  const meshRef = useRef<THREE.InstancedMesh>(null);
  
  // Coin geometry - Cylinder
  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ Three.js —Ü–∏–ª–∏–Ω–¥—Ä –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ (–æ—Å—å Y).
  // –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ—Å–ª–∏ Rotation = [0,0,0], –º–æ–Ω–µ—Ç–∞ –ª–µ–∂–∏—Ç –ü–õ–ê–®–ú–Ø –∫—Ä—É–≥–ª–æ–π —Å—Ç–æ—Ä–æ–Ω–æ–π –≤–≤–µ—Ä—Ö.
  const geometry = useMemo(() => new THREE.CylinderGeometry(0.12, 0.12, 0.03, 32), []);
  
  const material = useMemo(() => new THREE.MeshStandardMaterial({
    color: '#ffd700',
    metalness: 0.8,
    roughness: 0.35,
    emissive: '#b8860b',
    emissiveIntensity: 0.05,
  }), []);

  // Store static state for each coin
  const coins = useRef<CoinData[]>([]);
  const dummy = useMemo(() => new THREE.Object3D(), []);

  // Initialize coins when chest opens
  useEffect(() => {
    if (appState === AppState.OPENING) {
      const newCoins: CoinData[] = [];
      
      const baseHeight = 0.05; // –ß—É—Ç—å –Ω–∏–∂–µ, –ø—Ä—è–º–æ —É –¥–Ω–∞
      const spreadFactor = Math.min(1, Math.max(0.25, Math.pow(count / 200, 0.6)));
      const maxSpreadX = 1.4 * spreadFactor;
      const maxSpreadZ = 0.8 * spreadFactor;
      const maxPileHeight = 0.25 + (count * 0.0012); 

      for (let i = 0; i < count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const r = Math.sqrt(Math.random());
        
        const x = r * Math.cos(angle) * (maxSpreadX / 2);
        const z = r * Math.sin(angle) * (maxSpreadZ / 2);

        const distNorm = r; 
        const heightAtPos = maxPileHeight * Math.max(0, 1 - Math.pow(distNorm, 1.5));
        
        const yRel = heightAtPos * Math.random();
        const y = baseHeight + yRel;

        newCoins.push({
          position: [x, y, z],
          rotation: [
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±—Ä–∞–ª–∏ –ø–æ–≤–æ—Ä–æ—Ç –Ω–∞ 90 –≥—Ä–∞–¥—É—Å–æ–≤.
            // –¢–µ–ø–µ—Ä—å –±–∞–∑–æ–≤–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ [0,0,0] - —ç—Ç–æ –ª–µ–∂–∞—á–∞—è –º–æ–Ω–µ—Ç–∞.
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –Ω–∞–∫–ª–æ–Ω (tilt) –¥–æ ~30 –≥—Ä–∞–¥—É—Å–æ–≤ (0.5 —Ä–∞–¥),
            // —á—Ç–æ–±—ã –∫—É—á–∞ –≤—ã–≥–ª—è–¥–µ–ª–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –Ω–µ—Ä—è—à–ª–∏–≤–æ–π.
            (Math.random() - 0.5) * 0.8, 
            
            // –í—Ä–∞—â–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –æ—Å–∏ (–∫–∞–∫ –ø–æ–≤–µ—Ä–Ω—É—Ç "–æ—Ä–µ–ª") - –ª—é–±–æ–µ
            Math.random() * Math.PI * 2, 
            
            // –ù–∞–∫–ª–æ–Ω –ø–æ –¥—Ä—É–≥–æ–π –æ—Å–∏
            (Math.random() - 0.5) * 0.8
          ],
          scale: 0 
        });
      }
      coins.current = newCoins;
    } else if (appState === AppState.MENU) {
      coins.current = [];
    }
  }, [appState, count]);

  // Animation Loop
  useFrame((state, delta) => {
    if (!meshRef.current || coins.current.length === 0) {
        if (meshRef.current) meshRef.current.count = 0;
        return;
    }

    meshRef.current.count = coins.current.length;
    const growSpeed = delta * 4; 

    coins.current.forEach((coin, i) => {
      if (coin.scale < 1) {
        const delay = (i % 50) * 0.01 + (Math.floor(i/50) * 0.1); 
        if (state.clock.elapsedTime > delay) {
             coin.scale = Math.min(1, coin.scale + growSpeed);
        }
      }

      dummy.position.set(coin.position[0], coin.position[1], coin.position[2]);
      dummy.rotation.set(coin.rotation[0], coin.rotation[1], coin.rotation[2]);
      dummy.scale.setScalar(coin.scale);
      
      dummy.updateMatrix();
      meshRef.current!.setMatrixAt(i, dummy.matrix);
    });

    meshRef.current.instanceMatrix.needsUpdate = true;
  });

  return (
    <instancedMesh
      ref={meshRef}
      args={[geometry, material, 1000]}
      castShadow
      receiveShadow
    />
  );
};
</file>

<file path="components/DevMenuModal.tsx">
import React, { useState } from 'react';
import { GlassCard, Button } from './ui/GlassCard';
import { repo } from '../services/repository';
import { X, Settings, Plus, Trash2 } from 'lucide-react';
import { toast } from 'react-hot-toast';
import { UserProfile, ChestType, ACHIEVEMENTS_LIST } from '../types';

interface Props {
  profile: UserProfile;
  onClose: () => void;
  onRefresh: () => void;
}

export const DevMenuModal: React.FC<Props> = ({ profile, onClose, onRefresh }) => {
  // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, —Å—Ç–∞–≤–∏–º 0 –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
  const [coins, setCoins] = useState(profile?.coins || 0);
  const [xp, setXp] = useState(profile?.xp || 0);
  const [dailyXp, setDailyXp] = useState(profile?.daily_xp || 0);
  const [hasFreeze, setHasFreeze] = useState(!!profile?.has_freeze);
  const [goldenDay, setGoldenDay] = useState(!!(profile?.golden_hour_expires && profile.golden_hour_expires > Date.now()));
  const [chests, setChests] = useState<ChestType[]>(Array.isArray(profile?.chest_inventory) ? [...profile.chest_inventory] : []);
// –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∞—á–∏–≤–∫–∏
  const [achievements, setAchievements] = useState<Record<string, string>>(repo.getData().achievements || {});

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (–≤—ã–¥–∞—Ç—å/–∑–∞–±—Ä–∞—Ç—å)
  const handleToggleAchievement = (code: string) => {
    setAchievements(prev => {
      const updated = { ...prev };
      if (updated[code]) {
        delete updated[code]; // –ó–∞–±–∏—Ä–∞–µ–º –∞—á–∏–≤–∫—É
      } else {
        updated[code] = new Date().toISOString().split('T')[0]; // –í—ã–¥–∞–µ–º (—Å—Ç–∞–≤–∏–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É)
      }
      return updated;
    });
  };
  const handleSave = () => {
    repo.updateProfile({
      coins,
      xp,
      daily_xp: dailyXp,
      has_freeze: hasFreeze,
      chest_inventory: chests,
      golden_hour_expires: goldenDay ? Date.now() + (24 * 60 * 60 * 1000) : null
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    repo.setAchievements(achievements);
    
    toast.success('–ß–∏—Ç-–∫–æ–¥—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã! üë®‚Äçüíª');
    onRefresh();
    onClose();
  };

  const addChest = (type: ChestType) => setChests(prev => [...prev, type]);

  return (
    <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-in fade-in duration-200">
      <GlassCard className="w-full max-w-md bg-slate-900 border-cyan-500/50 shadow-[0_0_30px_rgba(6,182,212,0.2)] flex flex-col max-h-[90vh]">
        <div className="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
          <h2 className="text-xl font-bold text-cyan-400 flex items-center gap-2">
            <Settings size={20} /> DEV MENU
          </h2>
          <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
            <X size={24} />
          </button>
        </div>

        <div className="flex-1 overflow-y-auto space-y-4 pr-2 custom-scrollbar">
          {/* –í–∞–ª—é—Ç–∞ –∏ –û–ø—ã—Ç */}
          <div className="space-y-3 p-3 bg-slate-950/50 rounded-xl border border-white/5">
            <div>
              <label className="text-xs text-slate-500 uppercase font-bold">–ó–æ–ª–æ—Ç—ã–µ –º–æ–Ω–µ—Ç—ã</label>
              <input type="number" value={coins} onChange={(e) => setCoins(Number(e.target.value))} className="w-full bg-slate-900 border border-white/10 rounded-lg p-2 text-white outline-none focus:border-cyan-500" />
            </div>
            <div>
              <label className="text-xs text-slate-500 uppercase font-bold">–û–ø—ã—Ç (XP) - –í–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–Ω–≥</label>
              <input type="number" value={xp} onChange={(e) => setXp(Number(e.target.value))} className="w-full bg-slate-900 border border-white/10 rounded-lg p-2 text-white outline-none focus:border-cyan-500" />
            </div>
            <div>
              <label className="text-xs text-slate-500 uppercase font-bold">–î–Ω–µ–≤–Ω–æ–π –ª—É—Ç (XP)</label>
              <input type="number" value={dailyXp} onChange={(e) => setDailyXp(Number(e.target.value))} className="w-full bg-slate-900 border border-white/10 rounded-lg p-2 text-white outline-none focus:border-cyan-500" />
            </div>
          </div>

          {/* –ü—Ä–µ–¥–º–µ—Ç—ã */}
          <div className="flex justify-between p-3 bg-slate-950/50 rounded-xl border border-white/5">
            <label className="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" checked={hasFreeze} onChange={(e) => setHasFreeze(e.target.checked)} className="w-4 h-4 accent-cyan-500" />
              <span className="text-sm font-medium text-white">–ó–∞–º–æ—Ä–æ–∑–∫–∞</span>
            </label>
            <label className="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" checked={goldenDay} onChange={(e) => setGoldenDay(e.target.checked)} className="w-4 h-4 accent-yellow-500" />
              <span className="text-sm font-medium text-white">–ó–æ–ª–æ—Ç–æ–π –¥–µ–Ω—å</span>
            </label>
          </div>

{/* –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è */}
          <div className="p-3 bg-slate-950/50 rounded-xl border border-white/5">
            <label className="text-xs text-slate-500 uppercase font-bold block mb-3">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</label>
            <div className="grid grid-cols-1 gap-2 max-h-40 overflow-y-auto custom-scrollbar pr-2">
              {ACHIEVEMENTS_LIST.map(ach => {
                const hasAch = !!achievements[ach.code];
                return (
                  <label key={ach.code} className="flex items-center justify-between p-2 rounded-lg bg-slate-900 border border-white/5 cursor-pointer hover:bg-slate-800 transition-colors">
                    <div>
                        <div className="text-sm font-bold text-white">{ach.name}</div>
                        <div className="text-[10px] text-slate-500">{ach.desc}</div>
                    </div>
                    <input 
                      type="checkbox" 
                      checked={hasAch} 
                      onChange={() => handleToggleAchievement(ach.code)} 
                      className="w-4 h-4 accent-cyan-500 ml-3" 
                    />
                  </label>
                );
              })}
            </div>
          </div>

          {/* –°—É–Ω–¥—É–∫–∏ */}
          <div className="p-3 bg-slate-950/50 rounded-xl border border-white/5">
            <div className="flex justify-between items-center mb-2">
                <label className="text-xs text-slate-500 uppercase font-bold">–°—É–Ω–¥—É–∫–∏ ({chests.length})</label>
                <button onClick={() => setChests([])} className="text-xs text-red-400 hover:text-red-300 flex items-center gap-1">
                    <Trash2 size={12} /> –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
            <div className="flex gap-2">
              <Button variant="secondary" onClick={() => addChest(ChestType.COMMON)} className="flex-1 text-[10px] px-0 bg-amber-900/30 text-amber-400 border-amber-500/30 hover:bg-amber-900/50"><Plus size={12}/> –û–±—ã—á–Ω</Button>
              <Button variant="secondary" onClick={() => addChest(ChestType.RARE)} className="flex-1 text-[10px] px-0 bg-blue-900/30 text-blue-400 border-blue-500/30 hover:bg-blue-900/50"><Plus size={12}/> –†–µ–¥–∫–∏–π</Button>
              <Button variant="secondary" onClick={() => addChest(ChestType.EPIC)} className="flex-1 text-[10px] px-0 bg-purple-900/30 text-purple-400 border-purple-500/30 hover:bg-purple-900/50"><Plus size={12}/> –≠–ø–∏–∫</Button>
            </div>
          </div>
        </div>

        <div className="mt-6 pt-4 border-t border-white/10 flex gap-3">
          <Button variant="ghost" onClick={onClose} className="flex-1">–û—Ç–º–µ–Ω–∞</Button>
          <Button variant="primary" onClick={handleSave} className="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white border-none shadow-lg">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</Button>
        </div>
      </GlassCard>
    </div>
  );
};
</file>

<file path="components/Experience.tsx">
import React, { Suspense } from 'react';
import { Environment, ContactShadows, Stars, OrbitControls } from '@react-three/drei';
import { Chest } from './Chest';
import { CoinSystem } from './CoinSystem';
import { SpecialItem } from './SpecialItem';
import { AppState, ChestType, Reward, RewardType } from '../types';

interface ExperienceProps {
  appState: AppState;
  chestType: ChestType;
  reward: Reward;
  onOpen: () => void;
}

export const Experience: React.FC<ExperienceProps> = ({ appState, chestType, reward, onOpen }) => {
  return (
    <>
      <OrbitControls 
        makeDefault 
        minPolarAngle={0} 
        maxPolarAngle={Math.PI / 2.1} 
        minDistance={3}
        maxDistance={12}
        enablePan={false}
        dampingFactor={0.05}
      />

      <ambientLight intensity={0.4} />
      <pointLight position={[10, 10, 10]} intensity={1} shadow-mapSize={2048} castShadow />
      <spotLight 
        position={[0, 5, 0]} 
        intensity={2} 
        angle={0.6} 
        penumbra={1} 
        castShadow 
        color="#fbbf24" 
      />
      
      <Stars radius={100} depth={50} count={5000} factor={4} saturation={0} fade speed={1} />
      <Environment preset="city" />

      <Suspense fallback={null}>
        {appState !== AppState.MENU && (
            <group position={[0, -1, 0]}>
              <Chest appState={appState} type={chestType} onOpen={onOpen} />
              
              {/* Only show coins if reward type is COINS */}
              {reward.type === RewardType.COINS ? (
                 <CoinSystem appState={appState} count={reward.amount} />
              ) : (
                 <SpecialItem appState={appState} type={reward.type} />
              )}
              
              <ContactShadows 
                  opacity={0.6} 
                  scale={10} 
                  blur={2.5} 
                  far={4} 
                  color="#000000" 
              />
            </group>
        )}
      </Suspense>
    </>
  );
};
</file>

<file path="components/GameModals.tsx">
import React, { useState, useEffect } from 'react';
import { RANKS } from '../types';
import { GlassCard, Button } from './ui/GlassCard';
import { Crown, Sparkles, X, Gift } from 'lucide-react';
import { SoundManager } from './SoundManager';
import confetti from 'canvas-confetti';

// --- RANK UP MODAL ---

interface RankUpProps {
    newRankIndex: number;
    onClose: () => void;
}

export const RankUpModal: React.FC<RankUpProps> = ({ newRankIndex, onClose }) => {
    const rank = RANKS[newRankIndex];

    useEffect(() => {
        SoundManager.playAchievement("–ù–æ–≤—ã–π —Ä–∞–Ω–≥ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!");
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 }
        });
    }, []);

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-lg p-4 animate-in zoom-in-90 duration-300">
            <div className="absolute inset-0 overflow-hidden pointer-events-none">
                <div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-gradient-to-tr ${rank.color} opacity-20 blur-[100px] animate-pulse`}></div>
            </div>

            <GlassCard className="max-w-md w-full flex flex-col items-center text-center border-2 border-white/20 shadow-2xl relative bg-[#1a202c]">
                 <div className="absolute -top-12">
                     <div className={`w-24 h-24 rounded-full bg-slate-900 border-4 border-[#1a202c] flex items-center justify-center shadow-[0_0_30px_rgba(255,255,255,0.2)]`}>
                        <Crown className="text-yellow-400 drop-shadow-lg" size={48} />
                     </div>
                 </div>

                 <div className="mt-12 space-y-4">
                     <h2 className="text-3xl font-black uppercase tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-500 drop-shadow-sm">
                         –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω!
                     </h2>
                     <div className="py-4">
                         <div className="text-slate-400 text-sm uppercase tracking-widest mb-2">–ù–æ–≤–∞—è –∞—Ä–µ–Ω–∞</div>
                         <div className={`text-4xl font-bold bg-gradient-to-r ${rank.color} bg-clip-text text-transparent`}>
                             {rank.title}
                         </div>
                     </div>
                     <p className="text-slate-300 px-4">
                         –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –Ω–æ–≤—ã—Ö –≤—ã—Å–æ—Ç –≤ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–∏. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.
                     </p>
                 </div>

                 <Button onClick={onClose} variant="primary" className="mt-8 w-full py-3 text-lg font-bold bg-white/10 hover:bg-white/20 border-white/20">
                     –ó–ê–ë–†–ê–¢–¨ –ù–ê–ì–†–ê–î–£
                 </Button>
            </GlassCard>
        </div>
    );
};
</file>

<file path="components/ImageCropper.tsx">
import React, { useState, useRef, useCallback } from 'react';
import { GlassCard, Button } from './ui/GlassCard';
import { ZoomIn, ZoomOut, Check, X, Move, RefreshCw } from 'lucide-react';

interface Props {
  imageSrc: string;
  onCancel: () => void;
  onCrop: (base64: string) => void;
}

const CROP_SIZE = 200; // –†–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫—Ä—É–≥–∞-–º–∞—Å–∫–∏

export const ImageCropper: React.FC<Props> = ({ imageSrc, onCancel, onCrop }) => {
  const [scale, setScale] = useState(1);
  const [minAllowedScale, setMinAllowedScale] = useState(0.1);
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const [imgLayout, setImgLayout] = useState({ naturalWidth: 0, naturalHeight: 0 });
  
  const imgRef = useRef<HTMLImageElement>(null);
  const dragStart = useRef({ startX: 0, startY: 0, initialPosX: 0, initialPosY: 0 });

  // –¢–µ–ø–µ—Ä—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∂–µ—Å—Ç–∫–æ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ 200x200. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –¥–æ—Ç—è–Ω—É—Ç—å –ª—é–±–æ–π –∫—Ä–∞–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–æ –≥—Ä–∞–Ω–∏—Ü—ã –∫—Ä—É–≥–∞.
  const clampPosition = useCallback((x: number, y: number, currentScale: number, width: number, height: number) => {
    if (!width || !height) return { x, y };

    const renderWidth = width * currentScale;
    const renderHeight = height * currentScale;

    // –°—á–∏—Ç–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ö–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∫—Ä—É–≥–∞ (CROP_SIZE)
    const boundX = Math.max(0, (renderWidth - CROP_SIZE) / 2);
    const boundY = Math.max(0, (renderHeight - CROP_SIZE) / 2);

    return {
        x: Math.min(Math.max(x, -boundX), boundX),
        y: Math.min(Math.max(y, -boundY), boundY)
    };
  }, []);

  const onImageLoad = (e: React.SyntheticEvent<HTMLImageElement>) => {
    const { naturalWidth, naturalHeight } = e.currentTarget;
    setImgLayout({ naturalWidth, naturalHeight });

    // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ–º –ø–æ –≤–∏–¥–∏–º–æ–º—É –∫—Ä—É–≥—É, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Å–∏ –ª–∏—à–Ω–∏–π —Ä–∞–∑
    const minS = Math.max(CROP_SIZE / naturalWidth, CROP_SIZE / naturalHeight);
    setMinAllowedScale(minS);
    setScale(minS);
    setPosition({ x: 0, y: 0 });
  };

  const handleStart = (clientX: number, clientY: number) => {
    setIsDragging(true);
    dragStart.current = {
        startX: clientX,
        startY: clientY,
        initialPosX: position.x,
        initialPosY: position.y
    };
  };

  const handleMove = useCallback((clientX: number, clientY: number) => {
    if (!isDragging) return;
    
    const dx = clientX - dragStart.current.startX;
    const dy = clientY - dragStart.current.startY;
    
    const newX = dragStart.current.initialPosX + dx;
    const newY = dragStart.current.initialPosY + dy;

    setPosition(clampPosition(newX, newY, scale, imgLayout.naturalWidth, imgLayout.naturalHeight));
  }, [isDragging, scale, imgLayout, clampPosition]);

  const handleEnd = () => setIsDragging(false);

  const onMouseDown = (e: React.MouseEvent) => handleStart(e.clientX, e.clientY);
  const onMouseMove = (e: React.MouseEvent) => handleMove(e.clientX, e.clientY);
  const onTouchStart = (e: React.TouchEvent) => handleStart(e.touches[0].clientX, e.touches[0].clientY);
  const onTouchMove = (e: React.TouchEvent) => handleMove(e.touches[0].clientX, e.touches[0].clientY);

  const handleScaleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      const newScale = parseFloat(e.target.value);
      setScale(newScale);
      // –°—Ä–∞–∑—É –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é, –µ—Å–ª–∏ –ø—Ä–∏ –∑—É–º–µ –Ω–∞—Ä—É—à–∏–ª–∏—Å—å –≥—Ä–∞–Ω–∏—Ü—ã
      setPosition(prev => clampPosition(prev.x, prev.y, newScale, imgLayout.naturalWidth, imgLayout.naturalHeight));
  };

  const handleReset = () => {
    setScale(minAllowedScale);
    setPosition({ x: 0, y: 0 });
  };

  const handleSave = () => {
    if (!imgRef.current) return;

    const canvas = document.createElement('canvas');
    canvas.width = CROP_SIZE;
    canvas.height = CROP_SIZE;
    const ctx = canvas.getContext('2d');
    
    if (ctx) {
        ctx.fillStyle = '#0f172a';
        ctx.fillRect(0, 0, CROP_SIZE, CROP_SIZE);
        
        const renderWidth = imgLayout.naturalWidth * scale;
        const renderHeight = imgLayout.naturalHeight * scale;
        
        // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –¥–ª—è Canvas (–ø–µ—Ä–µ–Ω–æ—Å —Ü–µ–Ω—Ç—Ä–∞ UI –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã Canvas 200x200)
        const drawX = (CROP_SIZE / 2) + position.x - (renderWidth / 2);
        const drawY = (CROP_SIZE / 2) + position.y - (renderHeight / 2);
        
        ctx.drawImage(imgRef.current, drawX, drawY, renderWidth, renderHeight);
        onCrop(canvas.toDataURL('image/jpeg', 0.9));
    }
  };

  const renderWidth = imgLayout.naturalWidth * scale;
  const renderHeight = imgLayout.naturalHeight * scale;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/95 backdrop-blur-md p-4 animate-in fade-in duration-300">
      <GlassCard className="w-full max-w-md flex flex-col items-center border-white/20 shadow-2xl">
        <h3 className="text-xl font-bold text-white mb-6">–†–µ–¥–∞–∫—Ç–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞</h3>
        
        {/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫—Ä–æ–ø–ø–µ—Ä–∞ */}
        <div 
          className="relative w-64 h-64 bg-slate-950 rounded-2xl overflow-hidden mb-8 cursor-move touch-none border border-white/10"
          onMouseDown={onMouseDown}
          onMouseMove={onMouseMove}
          onMouseUp={handleEnd}
          onMouseLeave={handleEnd}
          onTouchStart={onTouchStart}
          onTouchMove={onTouchMove}
          onTouchEnd={handleEnd}
        >
           {/* –ú–∞—Å–∫–∞ (–∫—Ä—É–≥) */}
           <div className="absolute inset-0 pointer-events-none z-20 border-[28px] border-slate-950/80 rounded-full ring-1 ring-white/20"></div>
           <div className="absolute inset-0 pointer-events-none z-20 border border-white/5 rounded-2xl"></div>
           
           {/* –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */}
           <div className="w-full h-full flex items-center justify-center pointer-events-none relative">
             <img 
               ref={imgRef}
               src={imageSrc} 
               alt="Crop target"
               onLoad={onImageLoad}
               draggable={false}
               style={{ 
                 width: imgLayout.naturalWidth ? `${renderWidth}px` : 'auto',
                 height: imgLayout.naturalHeight ? `${renderHeight}px` : 'auto',
                 transform: `translate(${position.x}px, ${position.y}px)`,
                 transition: isDragging ? 'none' : 'transform 0.1s cubic-bezier(0.2, 0, 0.2, 1)',
                 maxWidth: 'none',
                 position: 'absolute'
               }}
               className="select-none object-cover" 
             />
           </div>

           <div className="absolute bottom-3 right-3 z-30 text-white/30 pointer-events-none flex items-center gap-1 text-[10px] uppercase font-bold tracking-widest bg-black/20 px-2 py-1 rounded">
             <Move size={12} /> Drag
           </div>
        </div>

        {/* –°–ª–∞–π–¥–µ—Ä –º–∞—Å—à—Ç–∞–±–∞ */}
        <div className="w-full px-4 mb-8">
           <div className="flex items-center gap-4 bg-slate-900/50 p-3 rounded-xl border border-white/5">
              <ZoomOut size={18} className="text-slate-500" />
              <input 
                type="range" 
                min={minAllowedScale} 
                max={Math.max(minAllowedScale * 5, 5)} 
                step="0.01" 
                value={scale} 
                onChange={handleScaleChange}
                className="flex-1 accent-cyan-500 h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer"
              />
              <ZoomIn size={18} className="text-slate-500" />
              <button onClick={handleReset} className="ml-2 p-1.5 hover:bg-white/10 rounded-lg text-slate-400 transition-colors" title="–°–±—Ä–æ—Å–∏—Ç—å">
                <RefreshCw size={16} />
              </button>
           </div>
        </div>

        {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
        <div className="flex gap-4 w-full">
            <Button onClick={onCancel} variant="ghost" className="flex-1 py-3 text-slate-400">
                <X size={18} /> –û—Ç–º–µ–Ω–∞
            </Button>
            <Button onClick={handleSave} variant="primary" className="flex-1 py-3 shadow-lg shadow-cyan-500/20">
                <Check size={18} /> –ì–æ—Ç–æ–≤–æ
            </Button>
        </div>
      </GlassCard>
    </div>
  );
};
</file>

<file path="components/Overlay.tsx">
import React, { useEffect, useState } from 'react';
import { AppState, ChestType, Reward, RewardType } from '../types';
import { Coins, RotateCcw, Package, Settings, Snowflake, Zap } from 'lucide-react';
import { useGameSounds } from '../hooks/useGameSounds';

interface OverlayProps {
  appState: AppState;
  reward: Reward;
  onReset: () => void;
  onSelectChest: (type: ChestType) => void;
  debugOverride: RewardType | null;
  setDebugOverride: (type: RewardType | null) => void;
}

export const Overlay: React.FC<OverlayProps> = ({ 
  appState, 
  reward, 
  onReset, 
  onSelectChest, 
  debugOverride, 
  setDebugOverride 
}) => {
  const [displayedCoins, setDisplayedCoins] = useState(0);
  const { playHover, playClick } = useGameSounds();

  useEffect(() => {
    if (appState === AppState.OPENED && reward.type === RewardType.COINS) {
      // Counter animation
      let start = 0;
      const end = reward.amount;
      const duration = 1500;
      const startTime = performance.now();

      const animate = (currentTime: number) => {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Ease out quart
        const ease = 1 - Math.pow(1 - progress, 4);
        
        setDisplayedCoins(Math.floor(start + (end - start) * ease));

        if (progress < 1) {
          requestAnimationFrame(animate);
        }
      };
      
      requestAnimationFrame(animate);
    } else if (appState === AppState.IDLE) {
      setDisplayedCoins(0);
    }
  }, [appState, reward]);

  // --- DEBUG PANEL ---
  const renderDebugPanel = () => {
      // Only show in MENU or IDLE
      if (appState !== AppState.MENU && appState !== AppState.IDLE) return null;

      return (
          <div className="absolute top-4 left-4 z-50 bg-black/60 backdrop-blur-md p-3 rounded-lg border border-white/10 shadow-xl">
              <div className="flex items-center gap-2 mb-2 text-white/50 text-[10px] font-bold uppercase tracking-wider">
                  <Settings className="w-3 h-3" />
                  –ú–µ–Ω—é —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
              </div>
              <div className="flex gap-2">
                  <button 
                    onClick={() => { playClick(); setDebugOverride(null); }}
                    onMouseEnter={() => playHover()}
                    className={`px-3 py-1.5 rounded text-xs font-bold transition-all ${debugOverride === null ? 'bg-white text-black' : 'bg-white/10 text-white hover:bg-white/20'}`}
                  >
                      –†–∞–Ω–¥–æ–º
                  </button>
                  <button 
                    onClick={() => { playClick(); setDebugOverride(RewardType.FREEZE); }}
                    onMouseEnter={() => playHover()}
                    className={`px-3 py-1.5 rounded text-xs font-bold transition-all flex items-center gap-1 ${debugOverride === RewardType.FREEZE ? 'bg-cyan-500 text-white' : 'bg-cyan-500/10 text-cyan-400 hover:bg-cyan-500/20'}`}
                  >
                      <Snowflake className="w-3 h-3" />
                      –§—Ä–∏–∑
                  </button>
                  <button 
                    onClick={() => { playClick(); setDebugOverride(RewardType.LIGHTNING); }}
                    onMouseEnter={() => playHover()}
                    className={`px-3 py-1.5 rounded text-xs font-bold transition-all flex items-center gap-1 ${debugOverride === RewardType.LIGHTNING ? 'bg-yellow-500 text-black' : 'bg-yellow-500/10 text-yellow-400 hover:bg-yellow-500/20'}`}
                  >
                      <Zap className="w-3 h-3" />
                      –î–µ–Ω—å
                  </button>
              </div>
          </div>
      );
  };

  // --- MENU STATE ---
  if (appState === AppState.MENU) {
    return (
      <div className="absolute inset-0 z-20 bg-slate-900/90 backdrop-blur-sm flex flex-col items-center justify-center p-6">
        {renderDebugPanel()}
        <h1 className="text-4xl md:text-5xl font-black text-white mb-8 tracking-widest uppercase drop-shadow-lg text-center">
          –í–´–ë–ï–†–ò–¢–ï –°–£–ù–î–£–ö
        </h1>
        
        <div className="flex flex-col md:flex-row gap-6 w-full max-w-4xl justify-center items-stretch">
          
          {/* COMMON */}
          <button 
            onClick={() => onSelectChest(ChestType.COMMON)}
            onMouseEnter={() => playHover()}
            className="group relative flex flex-col items-center p-8 bg-slate-800 border-2 border-slate-600 rounded-xl hover:border-slate-400 hover:bg-slate-700 transition-all duration-300 hover:-translate-y-2"
          >
            <div className="w-20 h-20 bg-[#5d4037] rounded-lg mb-4 shadow-lg flex items-center justify-center border-4 border-slate-500">
               <Package className="text-slate-300 w-10 h-10" />
            </div>
            <h2 className="text-2xl font-bold text-slate-300 mb-2">–û–ë–´–ß–ù–´–ô</h2>
            <div className="text-slate-400 text-xs font-medium space-y-1">
              <p>10 - 50 –ú–æ–Ω–µ—Ç</p>
              <p className="text-cyan-400">1% –ó–∞–º–æ—Ä–æ–∑–∫–∞</p>
              <p className="text-yellow-400">0.2% –ó–æ–ª–æ—Ç–æ–π –¥–µ–Ω—å</p>
            </div>
          </button>

          {/* RARE */}
          <button 
            onClick={() => onSelectChest(ChestType.RARE)}
            onMouseEnter={() => playHover()}
            className="group relative flex flex-col items-center p-8 bg-blue-950 border-2 border-blue-700 rounded-xl hover:border-blue-400 hover:bg-blue-900 transition-all duration-300 hover:-translate-y-2"
          >
             <div className="absolute -inset-1 bg-blue-500/20 blur-lg rounded-xl opacity-0 group-hover:opacity-100 transition-opacity" />
             <div className="w-20 h-20 bg-[#1e3a8a] rounded-lg mb-4 shadow-lg flex items-center justify-center border-4 border-blue-300 relative z-10">
               <Package className="text-blue-100 w-10 h-10" />
             </div>
            <h2 className="text-2xl font-bold text-blue-300 mb-2 relative z-10">–†–ï–î–ö–ò–ô</h2>
            <div className="text-blue-400 text-xs font-medium relative z-10 space-y-1">
              <p>60 - 120 –ú–æ–Ω–µ—Ç</p>
              <p className="text-cyan-300">2% –ó–∞–º–æ—Ä–æ–∑–∫–∞</p>
              <p className="text-yellow-300">0.5% –ó–æ–ª–æ—Ç–æ–π –¥–µ–Ω—å</p>
            </div>
          </button>

          {/* EPIC */}
          <button 
            onClick={() => onSelectChest(ChestType.EPIC)}
            onMouseEnter={() => playHover()}
            className="group relative flex flex-col items-center p-8 bg-purple-950 border-2 border-purple-700 rounded-xl hover:border-yellow-400 hover:bg-purple-900 transition-all duration-300 hover:-translate-y-2"
          >
            <div className="absolute -inset-1 bg-purple-500/30 blur-lg rounded-xl opacity-0 group-hover:opacity-100 transition-opacity" />
            <div className="w-20 h-20 bg-[#4c1d95] rounded-lg mb-4 shadow-lg flex items-center justify-center border-4 border-yellow-400 relative z-10">
               <Package className="text-yellow-200 w-10 h-10" />
            </div>
            <h2 className="text-2xl font-bold text-yellow-400 mb-2 relative z-10">–≠–ü–ò–ß–ï–°–ö–ò–ô</h2>
            <div className="text-purple-300 text-xs font-medium relative z-10 space-y-1">
              <p>140 - 500 –ú–æ–Ω–µ—Ç</p>
              <p className="text-cyan-200">4% –ó–∞–º–æ—Ä–æ–∑–∫–∞</p>
              <p className="text-yellow-200">1% –ó–æ–ª–æ—Ç–æ–π –¥–µ–Ω—å</p>
            </div>
            <span className="absolute top-2 right-2 text-[10px] bg-yellow-500 text-black font-bold px-2 py-0.5 rounded-full">–õ–£–ß–®–ò–ô –í–´–ë–û–†</span>
          </button>

        </div>
      </div>
    );
  }

  // --- REWARD RENDERER ---
  const renderReward = () => {
    switch (reward.type) {
      case RewardType.FREEZE:
        return (
          <div className="relative flex flex-col items-center">
            {/* Icons removed as requested, 3D model takes focus */}
            <div className="absolute -inset-20 bg-cyan-500/20 blur-3xl rounded-full animate-pulse" />
            
            {/* Added a spacer to push text down so it doesn't overlap the 3D model */}
            <div className="h-32"></div> 

            <div className="text-4xl font-black text-white drop-shadow-lg mt-12 tracking-wider uppercase">
               –ó–∞–º–æ—Ä–æ–∑–∫–∞
            </div>
            <div className="text-cyan-300 font-bold mt-2 uppercase text-sm tracking-widest">–†–µ–¥–∫–∏–π –ø—Ä–µ–¥–º–µ—Ç!</div>
          </div>
        );
      case RewardType.LIGHTNING:
        return (
          <div className="relative flex flex-col items-center">
             <div className="absolute -inset-20 bg-yellow-500/20 blur-3xl rounded-full animate-pulse" />
            
             <div className="h-32"></div>

            <div className="text-4xl font-black text-white drop-shadow-lg mt-12 tracking-wider uppercase">
               –ó–æ–ª–æ—Ç–æ–π –¥–µ–Ω—å
            </div>
             <div className="text-yellow-400 font-bold mt-2 uppercase text-sm tracking-widest">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞!</div>
          </div>
        );
      case RewardType.COINS:
      default:
        return (
          <div className="relative flex flex-col items-center">
              <div className="absolute -inset-20 bg-yellow-500/20 blur-3xl rounded-full animate-pulse" />
              <div className="flex items-center space-x-4">
                  <Coins className="w-16 h-16 text-yellow-400 drop-shadow-lg" />
                  <span className="text-8xl font-black text-white drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)]">
                      {displayedCoins}
                  </span>
              </div>
              <div className="text-2xl font-bold text-yellow-400 uppercase tracking-widest mt-2">
                  –ó–æ–ª–æ—Ç—ã—Ö –º–æ–Ω–µ—Ç
              </div>
          </div>
        );
    }
  };

  // --- GAME UI ---
  return (
    <div className="absolute inset-0 pointer-events-none flex flex-col items-center justify-between p-12 z-10">
      
      {/* Dev Panel (Visible in Idle too) */}
      {renderDebugPanel()}

      {/* Header */}
      <div className="text-center mt-8">
        <h1 className="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] tracking-wider uppercase">
          –¢–∞–π–Ω—ã–π –°—É–Ω–¥—É–∫
        </h1>
        <p className="text-yellow-200/60 mt-2 font-medium tracking-widest text-sm">
          {appState === AppState.IDLE ? "–ù–ê–ñ–ú–ò–¢–ï –ù–ê –°–£–ù–î–£–ö" : appState === AppState.OPENED ? "–ù–ê–ì–†–ê–î–ê –ü–û–õ–£–ß–ï–ù–ê" : "–û–¢–ö–†–´–í–ê–ï–ú..."}
        </p>
      </div>

      {/* Center Reward Display */}
      <div className={`transition-all duration-700 transform ${appState === AppState.OPENED ? 'scale-100 opacity-100 translate-y-0' : 'scale-50 opacity-0 translate-y-10'}`}>
        {renderReward()}
      </div>

      {/* Footer / Reset Button */}
      <div className={`transition-opacity duration-500 ${appState === AppState.OPENED ? 'opacity-100 pointer-events-auto' : 'opacity-0'}`}>
        <button 
          onClick={() => { playClick(); onReset(); }}
          onMouseEnter={() => playHover()}
          className="flex items-center space-x-2 bg-slate-800/80 hover:bg-slate-700 text-white px-8 py-4 rounded-full backdrop-blur-md border border-slate-600 shadow-xl transition-all hover:scale-105 active:scale-95 group"
        >
          <RotateCcw className="w-5 h-5 group-hover:-rotate-180 transition-transform duration-500" />
          <span className="font-bold tracking-wide">–í–´–ë–†–ê–¢–¨ –°–ù–û–í–ê</span>
        </button>
      </div>

       {/* Mobile helper for IDLE state */}
       {appState === AppState.IDLE && (
         <div className="md:hidden absolute bottom-20 animate-bounce text-white/50 text-sm font-medium pointer-events-none">
            –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—É–Ω–¥—É–∫
         </div>
       )}

    </div>
  );
};
</file>

<file path="components/Sidebar.tsx">
import React, { useState } from 'react';
import { LayoutDashboard, Apple, Dumbbell, Grid, User, ShoppingBag, PackageOpen, Package } from 'lucide-react';
import { UserProfile, RANKS } from '../types';

interface SidebarProps {
  currentTab: number;
  onSwitch: (idx: number) => void;
  onProfileClick: () => void;
  profile: UserProfile;
  onSecretClick: () => void;
}

const NAV_ITEMS = [
  { label: '–ó–∞–¥–∞—á–∏', icon: LayoutDashboard },
  { label: '–ö–∞–ª–æ—Ä–∏–∏', icon: Apple },
  { label: '–°–ø–æ—Ä—Ç', icon: Dumbbell },
  { label: '–ü—Ä–∏–≤—ã—á–∫–∏', icon: Grid },
  { label: '–ú–∞–≥–∞–∑–∏–Ω', icon: ShoppingBag },
  { label: '–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å', icon: PackageOpen },
];

export const Sidebar: React.FC<SidebarProps> = ({ currentTab, onSwitch, onProfileClick, profile, onSecretClick }) => {
  const currentRank = RANKS.reduce((prev, curr) => (profile.xp >= curr.threshold ? curr : prev), RANKS[0]);
  const chestCount = profile.chest_inventory.length;

  const [clickCount, setClickCount] = useState(0);

  const handleSecretClick = () => {
    setClickCount(prev => {
        const next = prev + 1;
        if (next >= 5) {
            onSecretClick();
            return 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
        }
        return next;
    });
  };

  return (
    <div className="w-64 bg-slate-900/80 border-r border-white/5 flex flex-col h-full sticky top-0">
      <div className="pt-2 pb-0 px-4 flex flex-col items-center text-center overflow-hidden shrink-0">
        <img 
            src="/Massonabor.png" 
            alt="Massonabor" 
            className="w-full max-w-[200px] h-auto object-contain -my-6 scale-110 pointer-events-none" 
        />
        <p 
          onClick={handleSecretClick} 
          className="text-[10px] text-yellow-500/60 -mt-2 mb-8 uppercase tracking-[0.2em] font-semibold relative z-50 cursor-pointer select-none py-2 px-4"
        >
          Beta 1.2
        </p>
      </div>

      <nav className="flex-1 px-3 space-y-1 overflow-y-auto custom-scrollbar">
        {NAV_ITEMS.map((item, idx) => {
          const isActive = currentTab === idx;
          const Icon = item.icon;
          return (
            <button
              key={idx}
              onClick={() => onSwitch(idx)}
              className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 text-sm font-medium ${
                isActive 
                  ? 'bg-cyan-500/10 text-cyan-400 border-r-2 border-cyan-500 rounded-r-none' 
                  : 'text-slate-400 hover:text-white hover:bg-white/5'
              }`}
            >
              <Icon size={18} />
              {item.label}
              
              {/* –ë–µ–π–¥–∂–∏–∫ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è */}
              {idx === 5 && chestCount > 0 && (
                  <span className="ml-auto bg-gradient-to-r from-yellow-500 to-yellow-600 text-black font-bold text-[10px] px-2 py-0.5 rounded-full shadow-[0_0_10px_rgba(234,179,8,0.5)] animate-pulse">
                      {chestCount}
                  </span>
              )}
            </button>
          );
        })}
      </nav>

      {/* --- DAILY XP PROGRESS BAR (LUXURY) --- */}
      <div className="px-4 pb-4 pt-2 shrink-0">
        <div className="bg-gradient-to-b from-slate-900 to-slate-950 rounded-2xl p-4 border border-white/10 relative overflow-visible shadow-[0_4px_20px_rgba(0,0,0,0.3)] group">
          
          {/* –°–≤–µ—á–µ–Ω–∏–µ –Ω–∞ —Ñ–æ–Ω–µ */}
          <div className="absolute -top-10 -right-10 w-32 h-32 bg-cyan-500/10 blur-3xl rounded-full group-hover:bg-cyan-500/20 transition-colors pointer-events-none"></div>

          <div className="flex justify-between items-end mb-3 relative z-10">
            <span className="text-xs font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 flex items-center gap-1.5 uppercase tracking-widest drop-shadow-sm">
               <Package size={14} className="text-cyan-400" /> –î–Ω–µ–≤–Ω–æ–π –ª—É—Ç
            </span>
            <span className="text-[11px] font-mono font-bold text-cyan-300 bg-cyan-950/50 px-2 py-0.5 rounded-md border border-cyan-500/20">
              {profile.daily_xp} XP
            </span>
          </div>
          
          <div className="relative h-2 w-full bg-slate-900 rounded-full overflow-visible border border-white/5 shadow-inner mt-2">
            
            {/* –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º —Å–≤–µ—á–µ–Ω–∏–µ–º */}
            <div className="absolute top-0 left-0 w-full h-full overflow-hidden rounded-full">
              <div 
                className="h-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all duration-500"
                style={{ width: `${Math.min(100, (profile.daily_xp / 600) * 100)}%` }}
              />
            </div>
            
            {/* Checkpoint 1 (–û–±—ã—á–Ω—ã–π) */}
            <div className={`absolute top-1/2 -translate-y-1/2 left-[16.6%] w-2.5 h-2.5 rounded-full border border-slate-900 z-10 group/tooltip cursor-help transition-all duration-300 hover:scale-150 flex items-center justify-center ${profile.daily_xp >= 100 ? 'bg-amber-400 shadow-[0_0_8px_#fbbf24]' : 'bg-slate-700'}`}>
               <div className="absolute bottom-full mb-2 opacity-0 group-hover/tooltip:opacity-100 transition-opacity bg-slate-800 text-amber-400 text-[10px] font-bold px-2 py-1 rounded border border-amber-500/30 whitespace-nowrap z-50 pointer-events-none shadow-xl">
                  –û–±—ã—á–Ω—ã–π: {Math.min(profile.daily_xp, 100)} / 100
               </div>
            </div>

            {/* Checkpoint 2 (–†–µ–¥–∫–∏–π) */}
            <div className={`absolute top-1/2 -translate-y-1/2 left-[50%] w-2.5 h-2.5 rounded-full border border-slate-900 z-10 group/tooltip cursor-help transition-all duration-300 hover:scale-150 flex items-center justify-center ${profile.daily_xp >= 300 ? 'bg-blue-400 shadow-[0_0_8px_#60a5fa]' : 'bg-slate-700'}`}>
               <div className="absolute bottom-full mb-2 opacity-0 group-hover/tooltip:opacity-100 transition-opacity bg-slate-800 text-blue-400 text-[10px] font-bold px-2 py-1 rounded border border-blue-500/30 whitespace-nowrap z-50 pointer-events-none shadow-xl">
                  –†–µ–¥–∫–∏–π: {Math.min(profile.daily_xp, 300)} / 300
               </div>
            </div>

            {/* Checkpoint 3 (–≠–ø–∏—á–µ—Å–∫–∏–π) */}
            <div className={`absolute top-1/2 -translate-y-1/2 right-0 translate-x-[2px] w-3 h-3 rounded-full border-2 border-slate-900 z-10 group/tooltip cursor-help transition-all duration-300 hover:scale-150 flex items-center justify-center ${profile.daily_xp >= 600 ? 'bg-purple-500 shadow-[0_0_10px_#a855f7]' : 'bg-slate-700'}`}>
               <div className="absolute bottom-full mb-2 right-0 opacity-0 group-hover/tooltip:opacity-100 transition-opacity bg-slate-800 text-purple-400 text-[10px] font-bold px-2 py-1 rounded border border-purple-500/30 whitespace-nowrap z-50 pointer-events-none shadow-xl">
                  –≠–ø–∏–∫: {Math.min(profile.daily_xp, 600)} / 600
               </div>
            </div>
          </div>
          
          {/* –ü–æ–¥–ø–∏—Å–∏ –ø–æ–¥ —á–µ–∫–ø–æ–∏–Ω—Ç–∞–º–∏ */}
          <div className="flex justify-between mt-3 text-[9px] font-bold text-slate-500 uppercase tracking-widest relative z-10">
             <span>–û–±—ã—á–Ω</span>
             <span className="ml-5">–†–µ–¥–∫</span>
             <span>–≠–ø–∏–∫</span>
          </div>
        </div>
      </div>

      <div className="p-4 pt-0 shrink-0">
        <div 
            onClick={onProfileClick}
            className="bg-slate-950/50 rounded-xl p-4 border border-white/5 cursor-pointer group hover:bg-slate-900 transition-colors relative overflow-hidden"
        >
          <div className="text-center mb-2 relative z-10">
            <span className={`font-bold text-sm block bg-gradient-to-r ${currentRank.color} bg-clip-text text-transparent`}>
                {currentRank.title}
            </span>
            <span className="text-slate-500 text-xs">{profile.xp} XP | ü™ô {profile.coins}</span>
          </div>
          <div className="flex justify-center relative z-10">
             <div className={`w-14 h-14 rounded-full p-[2px] bg-gradient-to-br ${currentRank.color} shadow-lg shadow-black/50`}>
                 <div className="w-full h-full rounded-full bg-slate-800 overflow-hidden flex items-center justify-center relative">
                    {profile.avatar_path ? (
                      <img src={profile.avatar_path} alt="Avatar" className="w-full h-full object-cover" />
                    ) : (
                      <User className="text-slate-500" size={24} />
                    )}
                 </div>
             </div>
          </div>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="components/SoundManager.ts">
class SoundManagerClass {
  private audioCtx: AudioContext | null = null;
  private isMuted: boolean = false;
  private notifier: ((msg: string, type?: string) => void) | null = null;
  
  // Ambience nodes
  private ambienceOsc: AudioBufferSourceNode | null = null;
  private ambienceGain: GainNode | null = null;
  private isAmbiencePlaying: boolean = false;
  
  // Random sounds interval
  private natureInterval: number | null = null;

  setNotifier(fn: (msg: string, type?: string) => void) {
    this.notifier = fn;
  }

  private getContext(): AudioContext | null {
    if (!this.audioCtx) {
      const AudioContextCtor = window.AudioContext || (window as any).webkitAudioContext;
      if (AudioContextCtor) {
        this.audioCtx = new AudioContext();
      }
    }
    return this.audioCtx;
  }

  async init() {
    const ctx = this.getContext();
    if (ctx && ctx.state === 'suspended') {
      await ctx.resume();
    }
    this.startAmbience();
  }

  toggleMute() {
    this.isMuted = !this.isMuted;
    if (this.isMuted) this.stopAmbience();
    else this.startAmbience();
  }

  // --- Ambient Space Noise (Brownian Noise Filtered) ---
  startAmbience() {
    if (this.isAmbiencePlaying || this.isMuted) return;
    const ctx = this.getContext();
    if (!ctx) return;

    // 1. Base Space Drone
    const bufferSize = ctx.sampleRate * 5; 
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
    }

    this.ambienceOsc = ctx.createBufferSource();
    this.ambienceOsc.buffer = buffer;
    this.ambienceOsc.loop = true;

    const filter = ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 120; // Very deep

    this.ambienceGain = ctx.createGain();
    this.ambienceGain.gain.value = 0.05; 

    this.ambienceOsc.connect(filter);
    filter.connect(this.ambienceGain);
    this.ambienceGain.connect(ctx.destination);

    this.ambienceOsc.start();
    this.isAmbiencePlaying = true;

    // 2. Start Random Nature Sounds Loop
    this.scheduleNextNatureSound();
  }

  stopAmbience() {
    if (this.ambienceOsc) {
        try { this.ambienceOsc.stop(); } catch(e) {}
        this.ambienceOsc.disconnect();
        this.ambienceOsc = null;
    }
    if (this.natureInterval) {
        clearTimeout(this.natureInterval);
        this.natureInterval = null;
    }
    this.isAmbiencePlaying = false;
  }

  private scheduleNextNatureSound() {
      if (this.isMuted) return;
      // Random time between 3 and 7 minutes (180s - 420s)
      // For demo purposes/testing, reducing to 30s-60s so you can hear it, 
      // but in real app roughly 5 mins is good.
      // Let's do 3-6 minutes as requested.
      const delay = (Math.random() * (360000 - 180000)) + 180000; 
      
      this.natureInterval = window.setTimeout(() => {
          this.playRandomNatureSound();
          this.scheduleNextNatureSound();
      }, delay);
  }

  private playRandomNatureSound() {
      if (Math.random() > 0.5) {
          this.playBirdChirp();
      } else {
          this.playWindRustle();
      }
  }

  private playBirdChirp() {
      const ctx = this.getContext();
      if (!ctx || this.isMuted) return;

      const t = ctx.currentTime;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = 'sine';
      // Bird: High freq sine with quick slides
      osc.frequency.setValueAtTime(4000, t);
      osc.frequency.linearRampToValueAtTime(5000, t + 0.1);
      osc.frequency.linearRampToValueAtTime(3500, t + 0.2);
      osc.frequency.linearRampToValueAtTime(4500, t + 0.3);

      gain.gain.setValueAtTime(0, t);
      gain.gain.linearRampToValueAtTime(0.05, t + 0.05); // Fade in
      gain.gain.linearRampToValueAtTime(0, t + 0.4);     // Fade out

      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(t);
      osc.stop(t + 0.4);
  }

  private playWindRustle() {
      const ctx = this.getContext();
      if (!ctx || this.isMuted) return;

      const t = ctx.currentTime;
      const bufferSize = ctx.sampleRate * 3; 
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1; // White noise
      }
      
      const noise = ctx.createBufferSource();
      noise.buffer = buffer;

      const filter = ctx.createBiquadFilter();
      filter.type = 'bandpass';
      filter.frequency.setValueAtTime(800, t);
      filter.frequency.linearRampToValueAtTime(1200, t + 1.5); // Move filter up
      filter.frequency.linearRampToValueAtTime(600, t + 3);   // Move filter down

      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0, t);
      gain.gain.linearRampToValueAtTime(0.15, t + 1.5); // Swell
      gain.gain.linearRampToValueAtTime(0, t + 3);     // Fade

      noise.connect(filter);
      filter.connect(gain);
      gain.connect(ctx.destination);
      noise.start(t);
  }


  // --- Tones ---

  private playTone(freq: number, type: OscillatorType, duration: number, startTime: number = 0, vol: number = 0.1) {
    const ctx = this.getContext();
    if (!ctx || this.isMuted) return;

    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = type;
    osc.frequency.setValueAtTime(freq, ctx.currentTime + startTime);
    
    gain.gain.setValueAtTime(0, ctx.currentTime + startTime);
    gain.gain.linearRampToValueAtTime(vol, ctx.currentTime + startTime + 0.05);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + startTime + duration);

    osc.connect(gain);
    gain.connect(ctx.destination);

    osc.start(ctx.currentTime + startTime);
    osc.stop(ctx.currentTime + startTime + duration);
  }

  // --- ASMR Typing ---
  playTypingSound() {
      const ctx = this.getContext();
      if (!ctx || this.isMuted) return;

      const t = ctx.currentTime;
      
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.frequency.setValueAtTime(2000 + Math.random() * 500, t); 
      gain.gain.setValueAtTime(0.05, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(t);
      osc.stop(t + 0.05);

      const osc2 = ctx.createOscillator();
      const gain2 = ctx.createGain();
      osc2.frequency.setValueAtTime(150 + Math.random() * 50, t);
      osc2.type = 'triangle';
      gain2.gain.setValueAtTime(0.1, t);
      gain2.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
      osc2.connect(gain2);
      gain2.connect(ctx.destination);
      osc2.start(t);
      osc2.stop(t + 0.1);
  }

  playClick() {
    this.playTone(600, 'sine', 0.1, 0, 0.05);
  }

  playSuccess(msg: string = '–£—Å–ø–µ—à–Ω–æ!') {
    // Improved "Magical" arpeggio (C Maj 7: C5, E5, G5, B5)
    // with sparkle effect (high sine waves)
    const ctx = this.getContext();
    if (ctx && !this.isMuted) {
        const t = ctx.currentTime;
        // Arpeggio
        this.playTone(523.25, 'sine', 0.6, 0, 0.2); // C5
        this.playTone(659.25, 'sine', 0.6, 0.08, 0.2); // E5
        this.playTone(783.99, 'sine', 0.6, 0.16, 0.2); // G5
        this.playTone(987.77, 'sine', 1.0, 0.24, 0.15); // B5 (Longer sustain)
        
        // Sparkle overlay
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(1500, t);
        osc.frequency.exponentialRampToValueAtTime(3000, t + 0.4);
        gain.gain.setValueAtTime(0.05, t);
        gain.gain.linearRampToValueAtTime(0, t + 0.4);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(t);
        osc.stop(t + 0.4);
    }
    
    if (this.notifier) this.notifier(msg, 'success');
  }

  playGoal(msg: string = '–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!') {
    this.playTone(523.25, 'triangle', 0.2, 0);
    this.playTone(659.25, 'triangle', 0.2, 0.1);
    this.playTone(783.99, 'triangle', 0.6, 0.2);
    this.playTone(1046.50, 'triangle', 0.8, 0.3);
    
    if (this.notifier) this.notifier(msg, 'success');
  }

  playAchievement(msg: string = '–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!') {
    const ctx = this.getContext();
    if (!ctx) return;
    
    [440, 440, 440, 554, 659, 880].forEach((freq, i) => {
        this.playTone(freq, 'square', 0.2, i * 0.1, 0.05);
    });
    
    if (this.notifier) this.notifier(msg, 'achievement');
  }

  playNotification(title: string) {
    this.playTone(880, 'sine', 0.5, 0, 0.2);
    this.playTone(440, 'sine', 0.5, 0.1, 0.2);

    if (this.notifier) this.notifier(title, 'info');

    if ("Notification" in window && Notification.permission === "granted") {
        new Notification("Daily Organizer", { 
            body: title,
            icon: '/icon.png'
        });
    }
  }

  playError() {
      this.playTone(150, 'sawtooth', 0.3, 0, 0.1);
  }
}

export const SoundManager = new SoundManagerClass();
</file>

<file path="components/SpecialItem.tsx">
import React, { useRef, useMemo } from 'react';
import { useFrame } from '@react-three/fiber';
import { Float } from '@react-three/drei';
import { useSpring, animated, config } from '@react-spring/three';
import * as THREE from 'three';
import { AppState, RewardType } from '../types';

interface SpecialItemProps {
  appState: AppState;
  type: RewardType;
}

export const SpecialItem: React.FC<SpecialItemProps> = ({ appState, type }) => {
  const group = useRef<THREE.Group>(null);
  
  // --- GEOMETRIES ---

  // Snowflake: 3 intersected boxes
  const snowflakeGeometry = useMemo(() => {
    const geo = new THREE.BoxGeometry(0.1, 1.2, 0.1);
    return geo;
  }, []);

  // Lightning: Extruded Shape
  const lightningGeometry = useMemo(() => {
    const shape = new THREE.Shape();
    // Zig-zag shape
    shape.moveTo(0, 0);
    shape.lineTo(-0.3, 0.5);
    shape.lineTo(-0.1, 0.5);
    shape.lineTo(-0.4, 1.2);
    shape.lineTo(0.3, 0.6);
    shape.lineTo(0.1, 0.6);
    shape.lineTo(0.3, 0);
    shape.lineTo(0, 0);

    const extrudeSettings = {
      steps: 1,
      depth: 0.1,
      bevelEnabled: true,
      bevelThickness: 0.05,
      bevelSize: 0.05,
      bevelSegments: 2
    };

    const geo = new THREE.ExtrudeGeometry(shape, extrudeSettings);
    geo.center(); // Center the geometry
    return geo;
  }, []);


  // --- MATERIALS ---
  const materials = useMemo(() => {
    return {
      snowflake: new THREE.MeshStandardMaterial({
        color: '#a5f3fc', // Cyan-200
        emissive: '#06b6d4', // Cyan-500
        emissiveIntensity: 0.8,
        metalness: 0.3,
        roughness: 0.2,
      }),
      lightning: new THREE.MeshStandardMaterial({
        color: '#fef08a', // Yellow-200
        emissive: '#eab308', // Yellow-500
        emissiveIntensity: 1.5,
        metalness: 0.8,
        roughness: 0.1,
      })
    };
  }, []);

  const isOpen = appState === AppState.OPENING || appState === AppState.OPENED;

  // Spring animation: 
  // 1. Scale: 0 -> 1.5
  // 2. Position Y: 0.5 (Inside chest) -> 1.8 (Hovering above, lowered from 2.5)
  // Tension reduced for smoother, less "snappy" motion.
  const { scale, positionY } = useSpring({
    scale: isOpen ? 1.5 : 0,
    positionY: isOpen ? 1.8 : 0.5,
    config: { mass: 2, tension: 50, friction: 15 } // Slower, heavier feel
  });

  useFrame((state) => {
    if (!group.current) return;
    
    // Rotate constantly for presentation
    group.current.rotation.y += 0.02;
    // Slight tilt wobble
    group.current.rotation.z = Math.sin(state.clock.elapsedTime * 2) * 0.1;
  });

  // If menu or idle, don't show (it's inside hidden)
  if (appState === AppState.MENU || appState === AppState.IDLE) return null;

  const isLightning = type === RewardType.LIGHTNING;

  return (
    // Animated Group handles the "Fly Out" motion via positionY
    <animated.group position-y={positionY}> 
      {/* Float creates the gentle hovering effect once it's up */}
      <Float 
        speed={4} 
        rotationIntensity={0.5} 
        floatIntensity={0.5} 
        floatingRange={[-0.1, 0.1]} 
      >
        <animated.group ref={group} scale={scale}> 
           
           {isLightning ? (
              <mesh geometry={lightningGeometry} material={materials.lightning} castShadow />
           ) : (
             <group>
                {/* 3 Crossed bars for a snowflake */}
                <mesh geometry={snowflakeGeometry} material={materials.snowflake} castShadow />
                <mesh geometry={snowflakeGeometry} material={materials.snowflake} rotation={[0, 0, Math.PI/3]} castShadow />
                <mesh geometry={snowflakeGeometry} material={materials.snowflake} rotation={[0, 0, -Math.PI/3]} castShadow />
             </group>
           )}

           {/* Particle Glow Effect (Simple Sphere behind) */}
           <pointLight 
              distance={4} 
              intensity={4} 
              color={isLightning ? "#eab308" : "#06b6d4"} 
           />
        </animated.group>
      </Float>
    </animated.group>
  );
};
</file>

<file path="components/ui/GlassCard.tsx">
import React, { useRef, useState } from 'react';
import { clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';
import { SoundManager } from '../SoundManager';

interface Props extends React.HTMLAttributes<HTMLDivElement> {
  className?: string;
  noPadding?: boolean;
}

export const GlassCard: React.FC<Props> = ({ children, className, noPadding, ...props }) => {
  const ref = useRef<HTMLDivElement>(null);
  const [transform, setTransform] = useState('');
  const [shadow, setShadow] = useState('');

  const handleMouseMove = (e: React.MouseEvent) => {
    if (!ref.current) return;
    const rect = ref.current.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    // Calculate rotation (-5 to 5 degrees)
    const centerX = rect.width / 2;
    const centerY = rect.height / 2;
    
    const rotateX = ((y - centerY) / centerY) * -3; // Invert Y for correct tilt
    const rotateY = ((x - centerX) / centerX) * 3;

    setTransform(`perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`);
    setShadow('0 20px 40px rgba(0,0,0,0.4)');
  };

  const handleMouseLeave = () => {
    setTransform('perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)');
    setShadow('');
  };

  return (
    <div 
      ref={ref}
      onMouseMove={handleMouseMove}
      onMouseLeave={handleMouseLeave}
      className={twMerge(
        "bg-slate-800/40 backdrop-blur-md border border-white/10 rounded-2xl overflow-hidden transition-all duration-200 ease-out",
        !noPadding && "p-6",
        className
      )}
      style={{
        transform,
        boxShadow: shadow || '0 10px 25px -5px rgba(0, 0, 0, 0.3)',
        transformStyle: 'preserve-3d'
      }}
      {...props}
    >
      {children}
    </div>
  );
};

export const Button: React.FC<React.ButtonHTMLAttributes<HTMLButtonElement> & { variant?: 'primary' | 'secondary' | 'danger' | 'ghost' }> = ({ 
  className, variant = 'secondary', onClick, ...props 
}) => {
  const base = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95";
  const variants = {
    primary: "bg-cyan-500/20 text-cyan-400 border border-cyan-500/50 hover:bg-cyan-500/30",
    secondary: "bg-white/5 text-slate-200 border border-white/10 hover:bg-white/10",
    danger: "bg-red-500/20 text-red-400 border border-red-500/50 hover:bg-red-500/30",
    ghost: "bg-transparent text-slate-400 hover:text-white hover:bg-white/5"
  };
  
  const handleClick = (e: React.MouseEvent<HTMLButtonElement>) => {
      SoundManager.playClick();
      if (onClick) onClick(e);
  };
  
  return (
    <button onClick={handleClick} className={twMerge(base, variants[variant], className)} {...props} />
  );
};
</file>

<file path="hooks/useGameSounds.ts">
import { useMemo, useEffect } from 'react';
import { Howl } from 'howler';

export const useGameSounds = () => {
  const sounds = useMemo(() => {
    return {
      // –¢–∏—Ö–∏–π, –ø—Ä–∏—è—Ç–Ω—ã–π "—Ç–∏–∫" –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ (Nintendo style)
      hover: new Howl({
        src: ['https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'],
        volume: 0.2,
      }),
      // –£–≤–µ—Ä–µ–Ω–Ω—ã–π, –Ω–æ –º—è–≥–∫–∏–π –∫–ª–∏–∫
      click: new Howl({
        src: ['https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'],
        volume: 0.4,
      }),
      // –ó–≤—É–∫ –≤—ã–±–æ—Ä–∞ —Å—É–Ω–¥—É–∫–∞ (–±–æ–ª–µ–µ —Ç—è–∂–µ–ª—ã–π –∫–ª–∏–∫)
      select: new Howl({
        src: ['https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3'],
        volume: 0.5,
      }),
      // –ú–∞–≥–∏—á–µ—Å–∫–∏–π –∑–≤—É–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –∏ "–í–∂—É—Ö"
      open: new Howl({
        src: ['https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'], 
        volume: 0.6,
        rate: 1.1 // –ß—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –¥–∏–Ω–∞–º–∏–∫–∏
      }),
      // –ó–≤–æ–Ω –º–æ–Ω–µ—Ç (–¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –¥—Ä–æ–ø–∞)
      coins: new Howl({
        src: ['https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'],
        volume: 0.5,
      }),
      // –ó–≤—É–∫ –ª—å–¥–∞/–∫—Ä–∏—Å—Ç–∞–ª–ª–∞ –¥–ª—è –§—Ä–∏–∑–∞ (Magic Glint / Ice)
      freeze: new Howl({
        src: ['https://assets.mixkit.co/active_storage/sfx/1437/1437-preview.mp3'], 
        volume: 0.7,
      }),
      // –≠–ø–∏—á–Ω—ã–π –∑–≤—É–∫ –¥–ª—è –ó–æ–ª–æ—Ç–æ–≥–æ –¥–Ω—è (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–∂–Ω–∏–π legendary)
      lightning: new Howl({
        src: ['https://assets.mixkit.co/active_storage/sfx/2060/2060-preview.mp3'], // Success chime
        volume: 0.5,
      }),
      // –°–±—Ä–æ—Å
      reset: new Howl({
        src: ['https://assets.mixkit.co/active_storage/sfx/2160/2160-preview.mp3'], // Whoosh transition
        volume: 0.3,
      })
    };
  }, []);

  // Preload
  useEffect(() => {
    Object.values(sounds).forEach(s => s.load());
  }, [sounds]);

  return {
    playHover: () => sounds.hover.play(),
    playClick: () => sounds.click.play(),
    playSelect: () => sounds.select.play(),
    playOpen: () => sounds.open.play(),
    playCoins: () => sounds.coins.play(),
    playFreeze: () => sounds.freeze.play(),
    playLightning: () => sounds.lightning.play(),
    playReset: () => sounds.reset.play(),
  };
};
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daily Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #0f172a; /* slate-900 */
        color: #f1f5f9;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "lucide-react": "https://esm.sh/lucide-react@^0.574.0",
    "recharts": "https://esm.sh/recharts@^3.7.0",
    "react-hot-toast": "https://esm.sh/react-hot-toast@^2.6.0",
    "tailwind-merge": "https://esm.sh/tailwind-merge@^3.5.0",
    "clsx": "https://esm.sh/clsx@^2.1.1",
    "canvas-confetti": "https://esm.sh/canvas-confetti@1.9.2"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
</file>

<file path="index.tsx">
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
</file>

<file path="metadata.json">
{
  "name": "Daily Organizer Web",
  "description": "A stylish, gamified daily organizer and tracker application ported to the web.",
  "requestFramePermissions": []
}
</file>

<file path="package.json">
{
  "name": "daily-organizer-web",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@react-spring/three": "^10.0.3",
    "@react-three/drei": "^10.7.7",
    "@react-three/fiber": "^9.5.0",
    "canvas-confetti": "1.9.2",
    "clsx": "^2.1.1",
    "howler": "^2.2.4",
    "lucide-react": "^0.574.0",
    "react": "^19.2.4",
    "react-dom": "^19.2.4",
    "react-hot-toast": "^2.6.0",
    "react-wavify": "^1.11.1",
    "recharts": "^3.7.0",
    "tailwind-merge": "^3.5.0",
    "three": "^0.183.0",
    "zustand": "^5.0.11"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "@vitejs/plugin-react": "^5.0.0",
    "typescript": "~5.8.2",
    "vite": "^6.2.0"
  }
}
</file>

<file path="pages/Calories.tsx">
import React, { useState, useMemo } from 'react';
import { FoodEntry } from '../types';
import { GlassCard, Button } from '../components/ui/GlassCard';
import { Droplet, Plus, Trash2, History as HistoryIcon, Flame, RotateCcw, Sparkles, Loader2 } from 'lucide-react';
import { SoundManager } from '../components/SoundManager';
import { toast } from 'react-hot-toast';
import { ai } from '../services/ai';
import Wave from 'react-wavify';

interface Props {
  entries: FoodEntry[];
  water: number;
  onAddFood: (f: Omit<FoodEntry, 'id'>) => void;
  onDeleteFood: (id: number) => void;
  onUpdateWater: (amount: number) => void;
  onResetWater: () => void;
  onGoToHistory: () => void;
}

const GOAL_WATER = 3000;
const GOAL_KCAL = 4000;

const WaterProgressBar = ({ percent }: { percent: number }) => {
  const safePercent = Math.min(Math.max(percent, 0), 100);

  return (
    <div className="relative mb-4">
      <style>{`
        @keyframes water-bubble {
          0% { transform: translateY(20px) scale(0.5); opacity: 0; }
          20% { opacity: 0.6; }
          80% { opacity: 0.4; }
          100% { transform: translateY(-80px) scale(1.2); opacity: 0; }
        }
        .animate-water-bubble {
          animation: water-bubble ease-in infinite;
        }
      `}</style>

      {/* –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–ª–±–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ */}
      <div className="h-20 bg-slate-950/90 rounded-2xl overflow-hidden relative border border-white/5 shadow-[inset_0_2px_10px_rgba(0,0,0,0.5)] backdrop-blur-sm">
        
        {/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (—Å–∏–Ω—è—è —á–∞—Å—Ç—å) */}
        <div 
          className="absolute top-0 left-0 bottom-0 z-10 overflow-hidden"
          style={{ 
              width: `${safePercent}%`,
              transition: 'width 1.5s cubic-bezier(0.23, 1, 0.32, 1)' 
          }}
        >
          {/* –§–æ–Ω –∑–∞–ª–∏–≤–∫–∏ –¥–ª—è –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ü–≤–µ—Ç–∞ */}
          <div className="absolute inset-0 bg-gradient-to-r from-blue-600/40 to-cyan-500/40" />

          {/* –°–ª–æ–π –≤–æ–ª–Ω */}
          <div className="absolute inset-0 w-full pointer-events-none">
            {/* –ó–∞–¥–Ω—è—è –≤–æ–ª–Ω–∞ */}
            <Wave 
              fill="url(#waterGradientDark)"
              paused={false}
              options={{ height: 20, amplitude: 15, speed: 0.15, points: 4 }}
              className="absolute inset-0 h-full opacity-60"
            />
            
            {/* –ü–µ—Ä–µ–¥–Ω—è—è –≤–æ–ª–Ω–∞ */}
            <Wave 
              fill="url(#waterGradientLight)"
              paused={false}
              options={{ height: 25, amplitude: 10, speed: 0.25, points: 3 }}
              className="absolute inset-0 h-full mix-blend-screen opacity-80"
            />

            {/* –ü—É–∑—ã—Ä—å–∫–∏ (–ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏) */}
            <div className="absolute inset-0 w-full overflow-hidden">
              {[...Array(15)].map((_, i) => {
                const size = Math.random() * 5 + 2;
                const left = Math.random() * 100;
                const delay = Math.random() * 8;
                const duration = Math.random() * 3 + 3;
                return (
                  <div 
                    key={i}
                    className="absolute -bottom-6 bg-cyan-200 rounded-full animate-water-bubble opacity-30"
                    style={{
                      width: `${size}px`,
                      height: `${size}px`,
                      left: `${left}%`,
                      animationDuration: `${duration}s`,
                      animationDelay: `${delay}s`,
                      filter: 'blur(1px)'
                    }}
                  />
                );
              })}
            </div>
          </div>
        </div>

        {/* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –±–ª–∏–∫–∏ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ */}
        <div className="absolute inset-0 pointer-events-none z-20">
          <div className="absolute top-0 left-0 right-0 h-1/3 bg-gradient-to-b from-white/10 to-transparent"></div>
          <div className="absolute bottom-0 left-0 right-0 h-1/4 bg-gradient-to-t from-white/5 to-transparent"></div>
          <div className="absolute inset-0 rounded-2xl border border-white/10 shadow-[inset_0_0_15px_rgba(255,255,255,0.05)]"></div>
        </div>

        {/* –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è SVG –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤ */}
        <svg width="0" height="0" className="absolute">
          <defs>
            <linearGradient id="waterGradientDark" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stopColor="#0ea5e9" />
              <stop offset="100%" stopColor="#1d4ed8" />
            </linearGradient>
            <linearGradient id="waterGradientLight" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stopColor="#67e8f9" />
              <stop offset="100%" stopColor="#3b82f6" />
            </linearGradient>
          </defs>
        </svg>
      </div>
    </div>
  );
};

export const CaloriesPage: React.FC<Props> = ({ 
  entries, 
  water, 
  onAddFood, 
  onDeleteFood, 
  onUpdateWater, 
  onResetWater, 
  onGoToHistory 
}) => {
  const [name, setName] = useState('');
  const [kcal, setKcal] = useState('');
  const [p, setP] = useState('');
  const [f, setF] = useState('');
  const [c, setC] = useState('');
  const [phase, setPhase] = useState<'morning' | 'day' | 'evening'>('morning');
  
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [aiStatus, setAiStatus] = useState('');

  const totals = useMemo(() => {
    return entries.reduce((acc, curr) => ({
      kcal: acc.kcal + curr.kcal,
      p: acc.p + curr.p,
      f: acc.f + curr.f,
      c: acc.c + curr.c
    }), { kcal: 0, p: 0, f: 0, c: 0 });
  }, [entries]);

  const waterPercent = Math.min((water / GOAL_WATER) * 100, 100);

  const handleAdd = () => {
    if (!name || !kcal) {
        toast.error("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å!");
        return;
    }
    onAddFood({
      date_str: new Date().toISOString().split('T')[0],
      phase,
      name,
      kcal: parseInt(kcal),
      p: parseFloat(p) || 0,
      f: parseFloat(f) || 0,
      c: parseFloat(c) || 0
    });
    setName(''); setKcal(''); setP(''); setF(''); setC('');
  };
  
  const handleAiCalculate = async () => {
      if (!name) {
          toast.error("–°–ø–µ—Ä–≤–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –≤–µ—Å");
          return;
      }
      setIsAiLoading(true);
      setAiStatus('–ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–∞...');
      try {
          const result = await ai.analyzeFood(name, (msg) => setAiStatus(msg));
          if (result && typeof result.kcal !== 'undefined') {
              setKcal(result.kcal.toString());
              setP(result.protein.toString());
              setF(result.fat.toString());
              setC(result.carbs.toString());
              SoundManager.playSuccess("–ë–ñ–£ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ!");
          } else {
              toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–æ—Å—Ç–∞–≤.");
          }
      } catch (error) {
          toast.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –ò–ò.");
      } finally {
          setIsAiLoading(false);
          setAiStatus('');
      }
  };

  const handleResetClick = (e: React.MouseEvent) => {
      e.preventDefault();
      if (water === 0) return;
      if (window.confirm('–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –≤–æ–¥—ã?')) {
          onResetWater();
          toast.success('–°–±—Ä–æ—à–µ–Ω–æ');
      }
  };

  const PhaseList = ({ title, ph }: { title: string, ph: string }) => {
    const list = entries.filter(e => e.phase === ph);
    return (
      <div className="bg-slate-950/20 rounded-xl p-4 border border-white/5 min-w-[280px]">
        <h3 className="font-bold text-slate-400 mb-3 flex items-center justify-between">
            <span className="flex items-center gap-2">{title}</span>
            <span className="text-[10px] font-mono bg-slate-800 px-2 py-0.5 rounded text-slate-500">
                {list.reduce((sum, i) => sum + i.kcal, 0)} kcal
            </span>
        </h3>
        <div className="space-y-2">
            {list.map(item => (
                <div key={item.id} className="bg-slate-800/40 p-3 rounded-xl flex justify-between items-start group hover:bg-slate-800 transition-all border border-white/5">
                    <div>
                        <div className="font-medium text-sm">{item.name}</div>
                        <div className="text-[10px] text-slate-500 mt-1 font-mono">
                            üî• {item.kcal} | –ë:{item.p} –ñ:{item.f} –£:{item.c}
                        </div>
                    </div>
                    <button onClick={() => onDeleteFood(item.id)} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <Trash2 size={14} />
                    </button>
                </div>
            ))}
            {list.length === 0 && <div className="text-xs text-slate-600 italic py-2 text-center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>}
        </div>
      </div>
    );
  };

  return (
    <div className="h-full flex flex-col gap-6">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
         {/* –í–û–î–ê */}
         <GlassCard className="flex flex-col justify-between overflow-hidden relative">
            <div className="relative z-20 flex justify-between items-start mb-4">
                <div className="flex items-center gap-2">
                    <Droplet className="text-cyan-400 animate-pulse" />
                    <span className="font-bold text-lg">–í–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è</span>
                </div>
                <div className="text-2xl font-black font-mono text-white">
                    {water} <span className="text-xs text-slate-500 font-normal">/ {GOAL_WATER} –º–ª</span>
                </div>
            </div>
            
            <WaterProgressBar percent={waterPercent} />
            
            <div className="relative z-20 flex flex-col gap-2">
                <div className="flex gap-2">
                    <Button onClick={() => onUpdateWater(water + 250)} variant="primary" className="flex-1 py-3">+250 –º–ª</Button>
                    <Button onClick={() => onUpdateWater(Math.max(0, water - 250))} variant="secondary" className="flex-1 py-3">-250 –º–ª</Button>
                </div>
                <button onClick={handleResetClick} className="text-[10px] text-slate-600 hover:text-red-400 py-1 transition-colors flex items-center justify-center gap-1">
                    <RotateCcw size={10} /> –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
                </button>
            </div>
         </GlassCard>

         {/* –ö–ê–õ–û–†–ò–ò */}
         <GlassCard className="flex flex-col justify-between relative overflow-hidden group">
             <div className="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                 <Flame size={140} />
             </div>
             
             <div className="relative z-10 flex justify-between items-start">
                 <div className="flex items-center gap-2">
                     <Flame className="text-orange-500" />
                     <span className="font-bold text-lg">–≠–Ω–µ—Ä–≥–∏—è</span>
                 </div>
                 <Button onClick={onGoToHistory} variant="secondary" className="text-[10px] py-1 px-3 h-7 bg-white/5 border-white/10">
                     <HistoryIcon size={12} /> –ò—Å—Ç–æ—Ä–∏—è
                 </Button>
             </div>

             <div className="relative z-10 text-center py-4">
                 <div className="text-5xl font-black text-white mb-1 drop-shadow-lg">{totals.kcal}</div>
                 <div className="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-bold">–¶–µ–ª—å: {GOAL_KCAL} –∫–∫–∞–ª</div>
             </div>

             <div className="relative z-10 grid grid-cols-3 gap-2">
                 {[
                   { label: '–ë–µ–ª–∫–∏', val: totals.p, color: 'text-cyan-400' },
                   { label: '–ñ–∏—Ä—ã', val: totals.f, color: 'text-purple-400' },
                   { label: '–£–≥–ª–µ–≤–æ–¥—ã', val: totals.c, color: 'text-yellow-400' }
                 ].map(m => (
                    <div key={m.label} className="bg-slate-950/40 rounded-xl p-2 border border-white/5 text-center">
                        <div className="text-[9px] text-slate-500 uppercase font-bold">{m.label}</div>
                        <div className={`font-mono font-bold ${m.color}`}>{m.val.toFixed(0)}–≥</div>
                    </div>
                 ))}
             </div>
         </GlassCard>
      </div>

      <GlassCard className="flex-1 flex flex-col min-h-0">
         <div className="flex-1 overflow-x-auto pb-4 custom-scrollbar">
            <div className="flex gap-4 h-full">
                <PhaseList title="üåÖ –ó–∞–≤—Ç—Ä–∞–∫" ph="morning" />
                <PhaseList title="‚òÄÔ∏è –û–±–µ–¥" ph="day" />
                <PhaseList title="üåô –£–∂–∏–Ω" ph="evening" />
            </div>
         </div>
         
         <div className="mt-4 pt-4 border-t border-white/5">
             <div className="flex flex-wrap md:flex-nowrap gap-3 items-end">
                 <div className="w-full md:w-32">
                     <label className="text-[10px] text-slate-500 uppercase font-bold mb-1 block">–ü—Ä–∏–µ–º</label>
                     <select value={phase} onChange={e => setPhase(e.target.value as any)} className="w-full bg-slate-950 border border-white/10 rounded-xl p-2.5 text-sm outline-none focus:border-cyan-500 transition-colors">
                         <option value="morning">üåÖ –£—Ç—Ä–æ</option>
                         <option value="day">‚òÄÔ∏è –î–µ–Ω—å</option>
                         <option value="evening">üåô –í–µ—á–µ—Ä</option>
                     </select>
                 </div>
                 
                 <div className="flex-1 min-w-[200px]">
                     <label className="text-[10px] text-slate-500 uppercase font-bold mb-1 block">–ü—Ä–æ–¥—É–∫—Ç –∏ –≤–µ—Å</label>
                     <div className="flex gap-2">
                        <input 
                            value={name} 
                            onChange={e => setName(e.target.value)} 
                            onKeyDown={e => e.key === 'Enter' && handleAiCalculate()}
                            placeholder="–ù–∞–ø—Ä: 150–≥ —Å—Ç–µ–π–∫–∞" 
                            className="w-full bg-slate-950 border border-white/10 rounded-xl p-2.5 text-sm outline-none focus:border-cyan-500 transition-all" 
                        />
                        <div className="relative">
                            {isAiLoading && (
                                <div className="absolute -top-8 left-1/2 -translate-x-1/2 text-[9px] text-cyan-400 bg-slate-900 border border-cyan-500/30 px-2 py-0.5 rounded-md whitespace-nowrap animate-pulse">
                                    {aiStatus}
                                </div>
                            )}
                            <Button 
                                onClick={handleAiCalculate} 
                                disabled={isAiLoading}
                                variant="secondary"
                                className={`h-[42px] px-3 ${isAiLoading ? 'opacity-50' : 'text-purple-400 hover:bg-purple-500/10 border-purple-500/20'}`}
                            >
                                {isAiLoading ? <Loader2 size={18} className="animate-spin" /> : <Sparkles size={18} />}
                            </Button>
                        </div>
                     </div>
                 </div>
                 
                 <div className="grid grid-cols-4 gap-2 w-full md:w-auto">
                    {[
                      { l: '–ö–∫–∞–ª', v: kcal, s: setKcal },
                      { l: '–ë', v: p, s: setP },
                      { l: '–ñ', v: f, s: setF },
                      { l: '–£', v: c, s: setC }
                    ].map(field => (
                        <div key={field.l} className="w-full md:w-16">
                            <label className="text-[9px] text-slate-500 uppercase font-bold mb-1 block text-center">{field.l}</label>
                            <input type="number" value={field.v} onChange={e => field.s(e.target.value)} placeholder="0" className="w-full bg-slate-950 border border-white/10 rounded-xl p-2.5 text-sm outline-none text-center focus:border-cyan-500 transition-colors" />
                        </div>
                    ))}
                 </div>
                 
                 <Button onClick={handleAdd} variant="primary" className="h-[42px] px-6 w-full md:w-auto shadow-lg shadow-cyan-500/20">
                     <Plus size={20} />
                 </Button>
             </div>
         </div>
      </GlassCard>
    </div>
  );
};
</file>

<file path="pages/Habits.tsx">
import React from 'react';
import { HABITS } from '../types';
import { GlassCard } from '../components/ui/GlassCard';
import { CheckCircle2, Circle } from 'lucide-react';

interface Props {
  completedHabits: string[];
  onToggle: (habit: string) => void;
}

export const HabitsPage: React.FC<Props> = ({ completedHabits, onToggle }) => {
  return (
    <div className="h-full flex flex-col">
        <div className="mb-4 shrink-0">
            <h2 className="text-2xl font-bold text-white mb-1">üß© –¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫</h2>
            <p className="text-slate-400 text-sm">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ä–∏—Ç—É–∞–ª—ã.</p>
        </div>
        
        <GlassCard className="flex-1 overflow-hidden" noPadding>
            {/* –ò—Å–ø–æ–ª—å–∑—É–µ–º h-full –∏ grid-cols-4. 
               13 –ø—Ä–∏–≤—ã—á–µ–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—Å—è –Ω–∞ 4 —Ä—è–¥–∞ (4+4+4+1).
               –ö–∞–∂–¥—ã–π —Ä—è–¥ –±—É–¥–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å —Ä–æ–≤–Ω–æ 25% –≤—ã—Å–æ—Ç—ã –≤–∏–¥–∂–µ—Ç–∞.
            */}
            <div className="h-full grid grid-cols-4 gap-[1px] bg-white/5">
                {HABITS.map(habit => {
                    const isDone = completedHabits.includes(habit);
                    return (
                        <button
                            key={habit}
                            onClick={() => onToggle(habit)}
                            className={`
                                flex flex-col items-center justify-center gap-2 transition-all duration-200 group h-full
                                ${isDone 
                                    ? 'bg-cyan-900/20 text-cyan-400' 
                                    : 'bg-slate-900/80 text-slate-400 hover:bg-slate-800'
                                }
                            `}
                        >
                            <div className={`transition-transform duration-300 ${isDone ? 'scale-110' : 'group-hover:scale-110'}`}>
                                {isDone ? <CheckCircle2 size={24} /> : <Circle size={24} />}
                            </div>
                            <span className="font-bold text-center px-2 text-xs leading-tight uppercase tracking-tight">
                                {habit}
                            </span>
                            
                            {isDone && (
                                <div className="absolute inset-0 bg-cyan-500/5 pointer-events-none" />
                            )}
                        </button>
                    );
                })}
                {/* –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–µ—Ç–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ */}
                {[...Array(3)].map((_, i) => (
                    <div key={`empty-${i}`} className="bg-slate-900/40 opacity-20" />
                ))}
            </div>
        </GlassCard>
    </div>
  );
};
</file>

<file path="pages/History.tsx">
import React, { useState } from 'react';
import { repo } from '../services/repository';
import { GlassCard, Button } from '../components/ui/GlassCard';
import { ChevronRight, ArrowLeft, Sparkles, Loader2, Bot, X } from 'lucide-react';
import { ai } from '../services/ai';
import { toast } from 'react-hot-toast';

interface Props {
    onBack: () => void;
}

export const HistoryPage: React.FC<Props> = ({ onBack }) => {
  const dates = repo.getHistoryDates();
  const [selectedDate, setSelectedDate] = useState<string | null>(dates[0] || null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è AI –°–∞–º–º–∞—Ä–∏
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [aiStatus, setAiStatus] = useState('');
  const [aiSummary, setAiSummary] = useState<string | null>(null);

  const water = selectedDate ? repo.getWater(selectedDate) : 0;
  const food = selectedDate ? repo.getFoodEntries(selectedDate) : [];
  const sport = selectedDate ? repo.getSportEntries(selectedDate) : [];
  
  const totalKcal = food.reduce((a, b) => a + b.kcal, 0);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Å–∞–º–º–∞—Ä–∏
  const handleGenerateSummary = async () => {
      if (dates.length === 0) {
          toast.error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞");
          return;
      }

      setIsAiLoading(true);
      setAiStatus('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');

      // –ë–µ—Ä–µ–º –º–∞–∫—Å–∏–º—É–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π (—á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ Nano)
      const recentDates = dates.slice(0, 7);
      let dataText = "";

      recentDates.forEach(d => {
          const w = repo.getWater(d);
          const f = repo.getFoodEntries(d);
          const s = repo.getSportEntries(d);
          
          const kcal = f.reduce((acc, curr) => acc + curr.kcal, 0);
          const sportNames = s.length > 0 ? s.map(x => x.name).join(', ') : '–Ω–µ—Ç';

          dataText += `[–î–µ–Ω—å ${d}]: –ö–∞–ª–æ—Ä–∏–∏: ${kcal} –∫–∫–∞–ª, –í–æ–¥–∞: ${w} –º–ª, –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: ${sportNames}.\n`;
      });

      try {
          const result = await ai.generateHistorySummary(dataText, (msg) => setAiStatus(msg));
          
          if (result) {
              setAiSummary(result);
              toast.success("–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!");
          } else {
              toast.error("–ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (window.ai).");
          }
      } catch (err) {
          toast.error("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞.");
          console.error(err);
      } finally {
          setIsAiLoading(false);
      }
  };

  return (
    <div className="h-full flex flex-col gap-4">
        <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
                <Button onClick={onBack} variant="ghost" className="p-2 h-auto">
                    <ArrowLeft size={24} />
                </Button>
                <h2 className="text-2xl font-bold text-white">–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
            </div>
            
            {/* –ö–Ω–æ–ø–∫–∞ AI –°–∞–º–º–∞—Ä–∏ */}
            <Button 
                onClick={handleGenerateSummary}
                disabled={isAiLoading || dates.length === 0}
                className="flex items-center gap-2 bg-purple-500/20 text-purple-300 hover:bg-purple-500/30 border border-purple-500/30 transition-all"
            >
                {isAiLoading ? <Loader2 size={18} className="animate-spin" /> : <Sparkles size={18} />}
                {isAiLoading ? aiStatus : "AI –û—Ç—á–µ—Ç"}
            </Button>
        </div>

        <div className="flex-1 flex gap-6 min-h-0">
            {/* Sidebar List */}
            <div className="w-1/4 flex flex-col">
                <GlassCard className="flex-1 flex flex-col" noPadding>
                    <div className="p-4 border-b border-white/10 bg-slate-800/50">
                        <h3 className="font-semibold text-slate-300">–ê—Ä—Ö–∏–≤</h3>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2 space-y-1">
                        {dates.map(d => (
                            <button
                                key={d}
                                onClick={() => setSelectedDate(d)}
                                className={`w-full text-left p-3 rounded-lg text-sm font-mono flex justify-between items-center ${selectedDate === d ? 'bg-cyan-500/20 text-cyan-300' : 'hover:bg-white/5 text-slate-400'}`}
                            >
                                {d}
                                {selectedDate === d && <ChevronRight size={14} />}
                            </button>
                        ))}
                        {dates.length === 0 && <div className="p-4 text-center text-slate-500 text-sm">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>}
                    </div>
                </GlassCard>
            </div>

            {/* Content */}
            <div className="w-3/4 flex flex-col">
                <GlassCard className="flex-1 overflow-y-auto">
                    
                    {/* –ü–ª–∞—à–∫–∞ —Å AI –°–∞–º–º–∞—Ä–∏ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ) */}
                    {aiSummary && (
                        <div className="mb-6 bg-gradient-to-br from-purple-900/40 to-indigo-900/40 border border-purple-500/30 rounded-xl p-5 relative overflow-hidden animate-in fade-in slide-in-from-top-4">
                            <div className="absolute top-0 right-0 p-3 opacity-10 pointer-events-none">
                                <Bot size={100} />
                            </div>
                            <div className="relative z-10">
                                <div className="flex justify-between items-start mb-2">
                                    <h3 className="font-bold text-purple-300 flex items-center gap-2">
                                        <Sparkles size={16} /> –í—ã–≤–æ–¥ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
                                    </h3>
                                    <button onClick={() => setAiSummary(null)} className="text-slate-400 hover:text-white transition-colors">
                                        <X size={18} />
                                    </button>
                                </div>
                                <p className="text-sm text-purple-100/90 leading-relaxed whitespace-pre-wrap">
                                    {aiSummary}
                                </p>
                            </div>
                        </div>
                    )}

                    {selectedDate ? (
                        <div className="space-y-8">
                            <div>
                                <h2 className="text-3xl font-bold text-white mb-1">{selectedDate}</h2>
                                <div className="flex gap-4 text-sm text-slate-400">
                                    <span>üíß {water} –º–ª</span>
                                    <span>üî• {totalKcal} –∫–∫–∞–ª</span>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="font-bold text-slate-300 mb-3 border-b border-white/5 pb-2">–ü–∏—Ç–∞–Ω–∏–µ</h3>
                                    <div className="space-y-2">
                                        {food.map(f => (
                                            <div key={f.id} className="bg-slate-950/40 p-3 rounded border border-white/5 flex justify-between">
                                                <span>{f.name}</span>
                                                <span className="text-slate-500 font-mono text-sm">{f.kcal}</span>
                                            </div>
                                        ))}
                                        {food.length === 0 && <div className="text-slate-600 italic text-sm">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>}
                                    </div>
                                </div>

                                <div>
                                    <h3 className="font-bold text-slate-300 mb-3 border-b border-white/5 pb-2">–°–ø–æ—Ä—Ç</h3>
                                    <div className="space-y-2">
                                        {sport.map(s => (
                                            <div key={s.id} className="bg-slate-950/40 p-3 rounded border border-white/5">
                                                <div className="font-medium">{s.name}</div>
                                                <div className="text-xs text-slate-500">{s.details} {s.weight && `| ${s.weight}`}</div>
                                            </div>
                                        ))}
                                        {sport.length === 0 && <div className="text-slate-600 italic text-sm">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="h-full flex items-center justify-center text-slate-500">
                            –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É
                        </div>
                    )}
                </GlassCard>
            </div>
        </div>
    </div>
  );
};
</file>

<file path="pages/Inventory.tsx">
import React, { useState, useCallback, useEffect } from 'react';
import { Canvas } from '@react-three/fiber';
import { Experience } from '../components/Experience';
import { AppState, ChestType, Reward, RewardType, UserProfile } from '../types';
import { useGameSounds } from '../hooks/useGameSounds';
import { repo } from '../services/repository';
import { GlassCard, Button } from '../components/ui/GlassCard';
import { Coins, Snowflake, Zap, PackageOpen, Shield, X, Timer, Utensils, Flame, CheckCircle, Clock } from 'lucide-react';
import { toast } from 'react-hot-toast';

interface Props {
  profile: UserProfile;
  onRefresh: () => void;
}

// –¢–∏–ø –¥–ª—è –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥
export interface ActiveReward {
    id: string;
    name: string;
    category: 'food' | 'dopamine';
    expiresAt: number; // Timestamp –≤—Ä–µ–º–µ–Ω–∏ —Å–≥–æ—Ä–∞–Ω–∏—è
}

const TWENTY_FOUR_HOURS_MS = 24 * 60 * 60 * 1000;

const getGaussianRandom = (min: number, max: number) => {
  let u = 0, v = 0;
  while(u === 0) u = Math.random(); 
  while(v === 0) v = Math.random();
  let num = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
  const mean = (min + max) / 2;
  const stdDev = (max - min) / 6; 
  let result = mean + num * stdDev;
  return Math.floor(Math.max(min, Math.min(max, result)));
};

// --- CSS-–ê—Ä—Ç –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã—Ö –°—É–Ω–¥—É–∫–æ–≤ ---
const ChestGraphic: React.FC<{ type: ChestType }> = ({ type }) => {
    const styles = {
        [ChestType.COMMON]: { 
            bg: 'bg-gradient-to-b from-amber-700 to-amber-900', 
            trim: 'bg-gradient-to-b from-slate-400 to-slate-600', 
            lock: 'bg-slate-800', 
            glow: 'shadow-[0_10px_30px_rgba(217,119,6,0.3)] group-hover:shadow-[0_15px_40px_rgba(217,119,6,0.5)]' 
        },
        [ChestType.RARE]: { 
            bg: 'bg-gradient-to-b from-blue-500 to-blue-800', 
            trim: 'bg-gradient-to-b from-slate-100 to-slate-300', 
            lock: 'bg-slate-900', 
            glow: 'shadow-[0_10px_30px_rgba(59,130,246,0.5)] group-hover:shadow-[0_15px_40px_rgba(59,130,246,0.7)]' 
        },
        [ChestType.EPIC]: { 
            bg: 'bg-gradient-to-b from-purple-500 to-purple-900', 
            trim: 'bg-gradient-to-b from-yellow-300 to-yellow-600', 
            lock: 'bg-rose-600', 
            glow: 'shadow-[0_10px_40px_rgba(168,85,247,0.6)] group-hover:shadow-[0_20px_50px_rgba(168,85,247,0.8)]' 
        }
    };
    const s = styles[type];

    return (
        <div className={`relative w-20 h-16 flex flex-col items-center justify-end transition-all duration-300 transform group-hover:-translate-y-2 group-hover:scale-110 mb-4`}>
            {/* –°–≤–µ—á–µ–Ω–∏–µ –ø–æ–∑–∞–¥–∏ —Å—É–Ω–¥—É–∫–∞ */}
            <div className={`absolute -inset-4 rounded-full blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-0 ${s.glow.split(' ')[0].replace('shadow-', 'bg-').replace('rgba(', '').replace(',0.3)', '').replace(',0.5)', '').replace(',0.6)', '')} / 30`}></div>
            
            <div className="relative z-10 w-full h-full flex flex-col items-center justify-end drop-shadow-2xl">
                {/* –ö—Ä—ã—à–∫–∞ (Lid) */}
                <div className={`w-full h-8 ${s.bg} rounded-t-2xl relative border-b-2 border-black/50 shadow-inner overflow-hidden`}>
                    <div className={`absolute top-0 left-2 w-1.5 h-full ${s.trim} shadow-[1px_0_2px_rgba(0,0,0,0.5)]`}></div>
                    <div className={`absolute top-0 right-2 w-1.5 h-full ${s.trim} shadow-[1px_0_2px_rgba(0,0,0,0.5)]`}></div>
                    <div className={`absolute bottom-0 left-0 w-full h-1.5 ${s.trim} shadow-[0_1px_2px_rgba(0,0,0,0.5)]`}></div>
                    {/* –ë–ª–∏–∫ –Ω–∞ –∫—Ä—ã—à–∫–µ */}
                    <div className="absolute top-0 inset-x-0 h-2 bg-white/20 rounded-t-2xl"></div>
                </div>
                {/* –û—Å–Ω–æ–≤–∞–Ω–∏–µ (Base) */}
                <div className={`w-[94%] h-8 ${s.bg} rounded-b-xl relative shadow-inner overflow-hidden border-t border-white/10`}>
                    <div className={`absolute top-0 left-2 w-1.5 h-full ${s.trim}`}></div>
                    <div className={`absolute top-0 right-2 w-1.5 h-full ${s.trim}`}></div>
                    {/* –¢–µ–Ω—å –Ω–∞ –¥–Ω–µ */}
                    <div className="absolute bottom-0 inset-x-0 h-3 bg-black/40"></div>
                </div>
                {/* –ó–∞–º–æ–∫ (Lock) */}
                <div className={`absolute top-5 w-4 h-5 ${s.lock} rounded border-2 border-black/60 shadow-lg flex items-center justify-center z-20`}>
                    <div className="w-1 h-1.5 bg-black/80 rounded-sm"></div>
                </div>
            </div>
        </div>
    );
};

export const InventoryPage: React.FC<Props> = ({ profile, onRefresh }) => {
  const [isOpeningState, setIsOpeningState] = useState(false);
  const [openingChestIndex, setOpeningChestIndex] = useState<number>(0);
  const [appState, setAppState] = useState<AppState>(AppState.IDLE);
  const [reward, setReward] = useState<Reward>({ type: RewardType.COINS, amount: 0 });
  const [displayedCoins, setDisplayedCoins] = useState(0);
  const [timeLeft, setTimeLeft] = useState<string | null>(null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥
  const [activeRewards, setActiveRewards] = useState<ActiveReward[]>([]);
  const [now, setNow] = useState(Date.now());

  const { playOpen, playCoins, playFreeze, playLightning, playSelect } = useGameSounds();

  // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–≥—Ä–∞–¥ –∏–∑ localStorage –∏ –∑–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
  useEffect(() => {
    const loadRewards = () => {
        const saved = localStorage.getItem('user_purchased_rewards');
        if (saved) {
            // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º —Ç–µ, —á—Ç–æ —É–∂–µ —Å–≥–æ—Ä–µ–ª–∏
            const parsed: ActiveReward[] = JSON.parse(saved);
            const valid = parsed.filter(r => r.expiresAt > Date.now());
            setActiveRewards(valid);
            if (valid.length !== parsed.length) {
                localStorage.setItem('user_purchased_rewards', JSON.stringify(valid));
            }
        }
    };
    
    loadRewards();
    const interval = setInterval(() => {
        setNow(Date.now());
    }, 1000);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å, —á—Ç–æ–±—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –æ–±–Ω–æ–≤–ª—è–ª—Å—è, –µ—Å–ª–∏ –º—ã –∫—É–ø–∏–ª–∏ —á—Ç–æ-—Ç–æ –≤ –º–∞–≥–∞–∑–∏–Ω–µ
    window.addEventListener('storage', loadRewards);
    
    return () => {
        clearInterval(interval);
        window.removeEventListener('storage', loadRewards);
    };
  }, []);

  // –õ–æ–≥–∏–∫–∞ —Å—á–µ—Ç—á–∏–∫–∞ –ó–æ–ª–æ—Ç—ã—Ö —Å—É—Ç–æ–∫
  useEffect(() => {
    const interval = setInterval(() => {
        if (profile.golden_hour_expires && profile.golden_hour_expires > Date.now()) {
            const diff = Math.floor((profile.golden_hour_expires - Date.now()) / 1000);
            const h = Math.floor(diff / 3600);
            const m = Math.floor((diff % 3600) / 60);
            const s = diff % 60;
            setTimeLeft(`${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`);
        } else {
            setTimeLeft(null);
        }
    }, 1000);
    return () => clearInterval(interval);
  }, [profile.golden_hour_expires]);

  // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –º–æ–Ω–µ—Ç
  useEffect(() => {
    if (appState === AppState.OPENED && reward.type === RewardType.COINS) {
      let start = 0;
      const end = reward.amount;
      const duration = 1500;
      const startTime = performance.now();
      const animate = (currentTime: number) => {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 4);
        setDisplayedCoins(Math.floor(start + (end - start) * ease));
        if (progress < 1) requestAnimationFrame(animate);
      };
      requestAnimationFrame(animate);
    } else {
      setDisplayedCoins(0);
    }
  }, [appState, reward]);

  const currentChestType = profile.chest_inventory[openingChestIndex] || ChestType.COMMON;

  const handleStartOpening = (index: number) => {
    setOpeningChestIndex(index);
    setAppState(AppState.IDLE);
    setReward({ type: RewardType.COINS, amount: 0 });
    setDisplayedCoins(0);
    setIsOpeningState(true);
  };

  const handleOpenChest = useCallback(() => {
    if (appState === AppState.IDLE) {
      setAppState(AppState.OPENING);
      playOpen();
      
      let selectedReward: Reward = { type: RewardType.COINS, amount: 0 };
      const rand = Math.random() * 100;
      let fChance = 0, lChance = 0;

      if (currentChestType === ChestType.COMMON) { fChance = 1; lChance = 0.2; }
      else if (currentChestType === ChestType.RARE) { fChance = 2; lChance = 0.5; }
      else if (currentChestType === ChestType.EPIC) { fChance = 4; lChance = 1; }

      if (rand < lChance) selectedReward = { type: RewardType.LIGHTNING, amount: 1 };
      else if (rand < lChance + fChance) selectedReward = { type: RewardType.FREEZE, amount: 1 };
      else {
        let amt = currentChestType === ChestType.EPIC ? getGaussianRandom(140, 500) : 
                  currentChestType === ChestType.RARE ? getGaussianRandom(60, 120) : getGaussianRandom(10, 50);
        selectedReward = { type: RewardType.COINS, amount: amt };
      }
      
      setReward(selectedReward);
      setTimeout(() => {
        setAppState(AppState.OPENED);
        if (selectedReward.type === RewardType.COINS) playCoins();
        else if (selectedReward.type === RewardType.FREEZE) playFreeze();
        else playLightning();
      }, 600);
    }
  }, [appState, currentChestType, playOpen, playCoins, playFreeze, playLightning]);

  const handleClaim = () => {
    playSelect();
    repo.processChestReward(openingChestIndex, reward.type, reward.amount);
    toast.success("–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!");
    setIsOpeningState(false);
    setAppState(AppState.IDLE);
    onRefresh();
  };

  const handleUseReward = (id: string) => {
    const updated = activeRewards.filter(r => r.id !== id);
    setActiveRewards(updated);
    localStorage.setItem('user_purchased_rewards', JSON.stringify(updated));
    toast.success("–û—Ç–ª–∏—á–Ω–æ! –ù–∞–≥—Ä–∞–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞.", { icon: 'üéâ' });
  };

  return (
    <div className="h-full w-full relative flex flex-col">
      
      {/* –ì–õ–ê–í–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° –ò–ù–í–ï–ù–¢–ê–†–Ø */}
      <div className={`flex-1 flex flex-col min-h-0 transition-all duration-300 ${isOpeningState ? 'blur-md scale-[0.98] opacity-40 pointer-events-none' : ''}`}>
        
        {/* Header —Å –±–∞–ª–∞–Ω—Å–æ–º –º–æ–Ω–µ—Ç (–ö–∞–∫ –≤ –ú–∞–≥–∞–∑–∏–Ω–µ) */}
        <div className="flex items-center justify-between mb-6 shrink-0">
          <div>
            <h2 className="text-3xl font-black text-white mb-1 flex items-center gap-3 drop-shadow-sm">
                <Shield className="text-indigo-400" size={32} /> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
            </h2>
            <p className="text-slate-400 text-sm font-medium">–í–∞—à–∏ –º–∞–≥–∏—á–µ—Å–∫–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∏ –¥–æ–±—ã—á–∞.</p>
          </div>
          
          <div className="bg-slate-900/80 px-5 py-2.5 rounded-2xl border border-yellow-500/30 flex items-center gap-3 shadow-[0_0_20px_rgba(234,179,8,0.15)] backdrop-blur-md">
              <Coins className="text-yellow-400 drop-shadow-md" size={24} />
              <span className="text-2xl font-black font-mono text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 to-yellow-500">
                  {profile.coins}
              </span>
          </div>
        </div>

        <div className="flex flex-col gap-6 flex-1 min-h-0 overflow-y-auto pr-2 custom-scrollbar pb-10">
            
            {/* –°–µ–∫—Ü–∏—è: –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã */}
            <div className="shrink-0">
                <h3 className="font-bold text-slate-300 flex items-center gap-2 mb-4 uppercase tracking-widest text-xs">
                    <Zap size={16} className="text-cyan-400" /> –ê–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
                </h3>
                
                {/* –°–µ—Ç–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –ø–æ —à–∏—Ä–∏–Ω–µ (max-w-xl), —á—Ç–æ–±—ã 2 —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–∏—Å—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */}
                <div className="grid grid-cols-2 gap-4 max-w-xl">
                    {/* –ó–∞–º–æ—Ä–æ–∑–∫–∞ */}
                    <GlassCard className={`relative overflow-hidden group p-5 flex flex-col items-center justify-center text-center shadow-lg transition-all ${profile.has_freeze ? 'border-cyan-500/30 hover:border-cyan-400/50 bg-cyan-950/20' : 'border-white/5 bg-slate-900/40 opacity-70'}`}>
                        {profile.has_freeze && <div className="absolute -inset-10 bg-cyan-500/10 blur-3xl rounded-full pointer-events-none group-hover:bg-cyan-500/20 transition-colors" />}
                        <div className={`w-14 h-14 rounded-full flex items-center justify-center mb-3 shadow-inner ${profile.has_freeze ? 'bg-cyan-500/20 ring-1 ring-cyan-500/50' : 'bg-slate-800 ring-1 ring-white/10'}`}>
                            <Snowflake size={28} className={profile.has_freeze ? 'text-cyan-400 drop-shadow-[0_0_8px_rgba(34,211,238,0.8)]' : 'text-slate-600'} />
                        </div>
                        <div className="text-3xl font-black font-mono text-white tracking-tight">{profile.has_freeze ? '1' : '0'}</div>
                        <div className={`text-[11px] uppercase font-bold tracking-widest mt-1 ${profile.has_freeze ? 'text-cyan-400/80' : 'text-slate-500'}`}>–ó–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ç—Ä–∏–∫–∞</div>
                    </GlassCard>

                    {/* –ó–æ–ª–æ—Ç—ã–µ —Å—É—Ç–∫–∏ (–¢–∞–π–º–µ—Ä) */}
                    <GlassCard className={`relative overflow-hidden group p-5 flex flex-col items-center justify-center text-center shadow-lg transition-all ${timeLeft ? 'border-orange-500/40 hover:border-orange-400/60 bg-orange-950/20' : 'border-white/5 bg-slate-900/40 opacity-70'}`}>
                        {timeLeft && <div className="absolute -inset-10 bg-orange-500/10 blur-3xl rounded-full pointer-events-none group-hover:bg-orange-500/20 transition-colors animate-pulse" />}
                        <div className={`w-14 h-14 rounded-full flex items-center justify-center mb-3 shadow-inner ${timeLeft ? 'bg-orange-500/20 ring-1 ring-orange-500/50' : 'bg-slate-800 ring-1 ring-white/10'}`}>
                            {timeLeft ? <Timer size={28} className="text-orange-400 drop-shadow-[0_0_8px_rgba(249,115,22,0.8)]" /> : <Zap size={28} className="text-slate-600" />}
                        </div>
                        <div className={`text-2xl font-black font-mono tracking-tight ${timeLeft ? 'text-transparent bg-clip-text bg-gradient-to-b from-orange-200 to-orange-500' : 'text-white'}`}>
                            {timeLeft ? timeLeft : '0'}
                        </div>
                        <div className={`text-[11px] uppercase font-bold tracking-widest mt-1 ${timeLeft ? 'text-orange-400/80' : 'text-slate-500'}`}>–ó–æ–ª–æ—Ç—ã–µ —Å—É—Ç–∫–∏</div>
                    </GlassCard>
                </div>
            </div>

            {/* –ù–û–í–û–ï: –°–µ–∫—Ü–∏—è –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥ (—Å —Ç–∞–π–º–µ—Ä–æ–º 24 —á–∞—Å–∞) */}
            {activeRewards.length > 0 && (
                <div className="shrink-0 animate-in fade-in slide-in-from-bottom-4">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="font-bold text-slate-300 flex items-center gap-2 uppercase tracking-widest text-xs">
                            <Clock size={16} className="text-rose-400" /> –°–≥–æ—Ä–∞—é—â–∏–µ –Ω–∞–≥—Ä–∞–¥—ã
                        </h3>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {activeRewards.map(reward => {
                            const timeLeftMs = reward.expiresAt - now;
                            if (timeLeftMs <= 0) return null; // –°–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ —Å–≥–æ—Ä–µ–ª–æ

                            const progress = Math.max(0, Math.min(100, (timeLeftMs / TWENTY_FOUR_HOURS_MS) * 100));
                            const h = Math.floor(timeLeftMs / (1000 * 60 * 60));
                            const m = Math.floor((timeLeftMs % (1000 * 60 * 60)) / (1000 * 60));
                            
                            const isDanger = progress < 20; // –ú–µ–Ω—å—à–µ 20% –≤—Ä–µ–º–µ–Ω–∏ –æ—Å—Ç–∞–ª–æ—Å—å

                            return (
                                <GlassCard key={reward.id} className="relative flex flex-col p-4 overflow-hidden border-white/5 bg-slate-900/60 shadow-lg">
                                    <div className="flex items-start justify-between mb-3 z-10 relative">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${reward.category === 'food' ? 'bg-orange-500/20 text-orange-400' : 'bg-rose-500/20 text-rose-400'}`}>
                                                {reward.category === 'food' ? <Utensils size={20} /> : <Flame size={20} />}
                                            </div>
                                            <div>
                                                <div className="font-bold text-white text-sm">{reward.name}</div>
                                                <div className={`text-xs font-mono mt-0.5 flex items-center gap-1 ${isDanger ? 'text-red-400 animate-pulse' : 'text-slate-400'}`}>
                                                    <Clock size={12} /> {h}—á {m}–º
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤—Ä–µ–º–µ–Ω–∏ */}
                                    <div className="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden mb-4 z-10 relative">
                                        <div 
                                            className={`h-full transition-all duration-1000 ${isDanger ? 'bg-red-500' : 'bg-cyan-400'}`} 
                                            style={{ width: `${progress}%` }} 
                                        />
                                    </div>

                                    <Button 
                                        onClick={() => handleUseReward(reward.id)} 
                                        variant="ghost" 
                                        className="w-full mt-auto bg-white/5 hover:bg-white/10 text-white py-2 flex justify-center items-center gap-2 text-xs font-bold uppercase tracking-wider z-10 relative border border-white/5"
                                    >
                                        <CheckCircle size={16} /> –í—ã–ø–æ–ª–Ω–∏—Ç—å
                                    </Button>
                                </GlassCard>
                            );
                        })}
                    </div>
                </div>
            )}

            {/* –°–µ–∫—Ü–∏—è: –°—É–Ω–¥—É–∫–∏ (–ì—Ä–∏–¥) */}
            <div className="flex-1 flex flex-col min-h-0">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-slate-300 flex items-center gap-2 uppercase tracking-widest text-xs">
                        <PackageOpen size={16} className="text-amber-500" /> –ù–µ–æ—Ç–∫—Ä—ã—Ç—ã–µ —Å—É–Ω–¥—É–∫–∏
                    </h3>
                    <span className="bg-amber-500/20 border border-amber-500/30 text-amber-400 text-xs px-3 py-1 rounded-full font-black shadow-[0_0_10px_rgba(245,158,11,0.2)]">
                        {profile.chest_inventory.length} —à—Ç
                    </span>
                </div>

                <div className="flex-1 bg-slate-900/60 backdrop-blur-sm rounded-3xl border border-white/5 p-6 shadow-inner relative overflow-hidden">
                    {profile.chest_inventory.length === 0 ? (
                        <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-500/50">
                            <PackageOpen size={80} className="mb-6 opacity-20" />
                            <p className="text-lg font-bold uppercase tracking-widest">–•—Ä–∞–Ω–∏–ª–∏—â–µ –ø—É—Å—Ç–æ</p>
                            <p className="text-sm mt-2 text-slate-600">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞—á–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ª—É—Ç–±–æ–∫—Å—ã.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                            {profile.chest_inventory.map((chest, index) => (
                                <button 
                                    key={index} 
                                    onClick={() => handleStartOpening(index)} 
                                    className="group relative flex flex-col items-center p-4 bg-slate-800/50 border border-white/10 rounded-2xl hover:bg-slate-800 hover:border-white/20 transition-all duration-300 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-cyan-500 animate-in zoom-in-95"
                                >
                                    <ChestGraphic type={chest} />
                                    
                                    <div className="mt-2 text-center">
                                        <span className={`text-xs font-black uppercase tracking-widest drop-shadow-md ${chest === ChestType.EPIC ? 'text-purple-400' : chest === ChestType.RARE ? 'text-blue-400' : 'text-amber-500'}`}>
                                            {chest === ChestType.EPIC ? '–≠–ø–∏—á–µ—Å–∫–∏–π' : chest === ChestType.RARE ? '–†–µ–¥–∫–∏–π' : '–û–±—ã—á–Ω—ã–π'}
                                        </span>
                                    </div>

                                    {/* –ü–ª–∞—à–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å" –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */}
                                    <div className="absolute inset-x-0 bottom-0 h-10 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-b-2xl flex items-end justify-center pb-2">
                                        <span className="text-[10px] text-white font-bold uppercase tracking-wider">–û—Ç–∫—Ä—ã—Ç—å</span>
                                    </div>
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            </div>

        </div>
      </div>

      {/* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø 3D –°–¶–ï–ù–´ */}
      <div className={`fixed inset-0 flex items-center justify-center bg-black/90 backdrop-blur-xl p-4 transition-all duration-500 ${isOpeningState ? 'opacity-100 z-[100] pointer-events-auto' : 'opacity-0 -z-50 pointer-events-none delay-200'}`}>
        
        <div className={`w-full max-w-5xl h-[80vh] min-h-[500px] bg-slate-900 border border-white/10 rounded-[2rem] overflow-hidden relative shadow-[0_0_80px_rgba(0,0,0,0.8)] transition-all duration-500 ${isOpeningState ? 'scale-100 translate-y-0' : 'scale-95 translate-y-10'}`}>
          
          <Button 
            variant="ghost" 
            className={`absolute top-6 right-6 z-50 text-slate-400 hover:text-white bg-black/40 hover:bg-black/70 rounded-full p-3 transition-opacity duration-300 backdrop-blur-sm ${appState === AppState.IDLE ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} 
            onClick={() => setIsOpeningState(false)}
          >
            <X size={24} />
          </Button>

          {/* Canvas –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ DOM –≤—Å–µ–≥–¥–∞ */}
          <div className="absolute inset-0 z-0">
            <Canvas 
              shadows 
              dpr={[1, 1.5]} 
              camera={{ position: [0, 3, 6], fov: 45 }}
              gl={{ powerPreference: "high-performance", antialias: false }}
              frameloop={isOpeningState ? "always" : "demand"}
            >
              <Experience appState={appState} chestType={currentChestType} reward={reward} onOpen={handleOpenChest} />
            </Canvas>
          </div>

          <div className="absolute inset-0 z-10 pointer-events-none flex flex-col items-center justify-between py-12">
            <div className="text-center mt-4">
               <h1 className="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-slate-400 drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)] uppercase tracking-widest">
                  {appState === AppState.IDLE ? "–ù–∞–∂–º–∏ –Ω–∞ —Å—É–Ω–¥—É–∫" : appState === AppState.OPENED ? "–õ—É—Ç –ø–æ–ª—É—á–µ–Ω!" : "–û—Ç–∫—Ä—ã–≤–∞–µ–º..."}
               </h1>
            </div>

            {appState === AppState.OPENED && (
              <div className="flex flex-col items-center animate-in zoom-in-75 fade-in duration-700 ease-out translate-y-[-20px]">
                {reward.type === RewardType.COINS ? (
                  <div className="flex flex-col items-center relative">
                    <div className="absolute -inset-32 bg-yellow-500/20 blur-3xl rounded-full animate-pulse" />
                    <div className="flex items-center gap-6 relative z-10">
                      <Coins size={80} className="text-yellow-400 drop-shadow-[0_0_15px_rgba(250,204,21,0.6)]" />
                      <span className="text-8xl font-black text-white drop-shadow-[0_6px_6px_rgba(0,0,0,0.6)]">{displayedCoins}</span>
                    </div>
                    <div className="text-2xl font-bold text-yellow-400 uppercase mt-4 tracking-widest bg-black/20 px-6 py-2 rounded-full backdrop-blur-md border border-yellow-500/20">
                        –ó–æ–ª–æ—Ç—ã—Ö –º–æ–Ω–µ—Ç
                    </div>
                  </div>
                ) : (
                  <div className="flex flex-col items-center relative">
                    <div className={`absolute -inset-32 blur-[80px] rounded-full animate-pulse ${reward.type === RewardType.FREEZE ? 'bg-cyan-500/30' : 'bg-orange-500/30'}`} />
                    <div className="text-6xl md:text-7xl font-black text-white uppercase drop-shadow-[0_4px_10px_rgba(0,0,0,0.8)] relative z-10 tracking-tight">
                        {reward.type === RewardType.FREEZE ? '–ó–∞–º–æ—Ä–æ–∑–∫–∞' : '–ó–æ–ª–æ—Ç–æ–π –¥–µ–Ω—å'}
                    </div>
                    <div className={`${reward.type === RewardType.FREEZE ? 'text-cyan-400 border-cyan-500/30' : 'text-orange-400 border-orange-500/30'} bg-black/30 backdrop-blur-md border font-bold uppercase mt-6 tracking-widest relative z-10 px-6 py-2 rounded-full`}>
                        –ú–∞–≥–∏—á–µ—Å–∫–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
                    </div>
                  </div>
                )}
                
                <Button 
                    onClick={handleClaim} 
                    variant="primary" 
                    className="mt-16 px-16 py-5 text-xl pointer-events-auto font-black tracking-widest shadow-[0_0_40px_rgba(6,182,212,0.5)] hover:shadow-[0_0_60px_rgba(6,182,212,0.8)] border-cyan-400/60 bg-cyan-500/20 hover:bg-cyan-500/40 rounded-2xl hover:-translate-y-1 transition-all duration-300"
                >
                    –ó–ê–ë–†–ê–¢–¨ –í –ò–ù–í–ï–ù–¢–ê–†–¨
                </Button>
              </div>
            )}
            <div /> 
          </div>
        </div>
      </div>

    </div>
  );
};
</file>

<file path="pages/Profile.tsx">
import React, { useState, useRef } from 'react';
import { UserProfile, ACHIEVEMENTS_LIST, RANKS } from '../types';
import { GlassCard, Button } from '../components/ui/GlassCard';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { 
    Save, User as UserIcon, Lock, Unlock, Trophy, ArrowLeft, 
    Upload, Crown, TrendingUp, Download, Database, ChevronRight 
} from 'lucide-react';
import { SoundManager } from '../components/SoundManager';
import { ImageCropper } from '../components/ImageCropper';
import { repo } from '../services/repository';
import { toast } from 'react-hot-toast';

interface Props {
  profile: UserProfile;
  weightHistory: { date: string, weight: number }[];
  achievements: Record<string, string>;
  onUpdateProfile: (p: Partial<UserProfile>) => void;
  onLogWeight: (w: number) => void;
  onBack: () => void;
}

export const ProfilePage: React.FC<Props> = ({ profile, weightHistory, achievements, onUpdateProfile, onLogWeight, onBack }) => {
  const [weight, setWeight] = useState(profile.weight.toString());
  const [bf, setBf] = useState(profile.body_fat.toString());
  const [avatar, setAvatar] = useState(profile.avatar_path);
  const [showRankRoad, setShowRankRoad] = useState(false);
  const [cropImage, setCropImage] = useState<string | null>(null);

  const fileInputRef = useRef<HTMLInputElement>(null);
  const backupInputRef = useRef<HTMLInputElement>(null);

  const handleSave = () => {
    const w = parseFloat(weight);
    onUpdateProfile({
        weight: w,
        body_fat: parseFloat(bf),
        avatar_path: avatar
    });
    if (w > 0) onLogWeight(w);
    SoundManager.playSuccess("–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
          if (event.target?.result) {
            setCropImage(event.target.result as string);
            e.target.value = '';
          }
      };
      reader.readAsDataURL(file);
  };
  
  const handleCropped = (base64: string) => {
      setAvatar(base64);
      setCropImage(null);
      SoundManager.playClick();
  };

  // --- Backup Logic ---
  const handleExport = () => {
      const dataStr = repo.exportData();
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      const date = new Date().toISOString().split('T')[0];
      link.href = url;
      link.download = `daily_organizer_backup_${date}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      toast.success("–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
  };

  const handleImportClick = () => {
      backupInputRef.current?.click();
  };

  const handleImportFile = (e: React.ChangeEvent<HTMLInputElement>) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
          if (event.target?.result) {
              const success = repo.importData(event.target.result as string);
              if (success) {
                  toast.success("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...");
                  setTimeout(() => window.location.reload(), 1500);
              } else {
                  toast.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç.");
              }
          }
      };
      reader.readAsText(file);
      e.target.value = ''; // Reset input
  };

  const formattedHistory = weightHistory.map(h => ({ ...h, date: h.date.substring(5) }));
  const hasHistory = formattedHistory.length > 0;
  
  // –†–∞—Å—á–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–∞–Ω–≥–æ–≤
  const currentRank = RANKS.reduce((prev, curr) => (profile.xp >= curr.threshold ? curr : prev), RANKS[0]);
  const currentRankIndex = RANKS.findIndex(r => r.title === currentRank.title);
  const isMaxRank = currentRankIndex === RANKS.length - 1;
  const nextRank = isMaxRank ? currentRank : RANKS[currentRankIndex + 1];
  
  const xpProgress = isMaxRank 
      ? 100 
      : Math.min(100, Math.max(0, ((profile.xp - currentRank.threshold) / (nextRank.threshold - currentRank.threshold)) * 100));

  // –û–ø—Ü–∏–∏ –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏ —Ä–∞–Ω–≥–æ–≤
  const ITEM_HEIGHT = 160; 
  const BOTTOM_PADDING = 80;
  const BASE_OFFSET = 40 + BOTTOM_PADDING + (ITEM_HEIGHT / 2); // 200

  let progressPx = BASE_OFFSET;
  let nextThresholdForRoad = 0;

  for (let i = 0; i < RANKS.length - 1; i++) {
      const start = RANKS[i].threshold;
      const end = RANKS[i+1].threshold;
      
      if (profile.xp >= start && profile.xp < end) {
          const ratio = (profile.xp - start) / (end - start);
          progressPx += i * ITEM_HEIGHT;
          progressPx += ratio * ITEM_HEIGHT;
          nextThresholdForRoad = end;
          break;
      } else if (i === RANKS.length - 2 && profile.xp >= end) {
          progressPx += (i + 1) * ITEM_HEIGHT;
          nextThresholdForRoad = end;
      }
  }

  if (profile.xp >= RANKS[RANKS.length - 1].threshold) {
       progressPx = BASE_OFFSET + ((RANKS.length - 1) * ITEM_HEIGHT);
       nextThresholdForRoad = RANKS[RANKS.length - 1].threshold;
  }

  return (
    <div className="h-full flex flex-col gap-6 overflow-y-auto pr-2 custom-scrollbar pb-10">
      {/* Header */}
      <div className="flex items-center gap-4 shrink-0">
          <Button onClick={onBack} variant="ghost" className="p-2 h-auto hover:bg-white/10 rounded-full">
              <ArrowLeft size={24} />
          </Button>
          <h2 className="text-2xl font-bold text-white">–ü—Ä–æ—Ñ–∏–ª—å</h2>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0">
          
          {/* –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ò–Ω—Ñ–æ, –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–ª–∞, –ë—ç–∫–∞–ø—ã */}
          <div className="lg:col-span-4 flex flex-col gap-6">
              
              {/* –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è */}
              <GlassCard className="flex flex-col items-center justify-center relative overflow-hidden group/card p-8">
                  <div className="absolute top-0 inset-x-0 h-24 bg-gradient-to-b from-cyan-500/10 to-transparent pointer-events-none"></div>
                  
                  {/* –ê–≤–∞—Ç–∞—Ä */}
                  <div 
                    className="relative group cursor-pointer mb-5 z-10 flex flex-col items-center justify-center rounded-full" 
                    onClick={() => fileInputRef.current?.click()}
                  >
                      {/* –£—Å–∏–ª–µ–Ω–Ω–æ–µ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ (Glow) */}
                      <div className={`absolute -inset-4 rounded-full blur-2xl opacity-60 bg-gradient-to-br ${currentRank.color} group-hover:opacity-100 group-hover:blur-3xl transition-all duration-500 animate-pulse`}></div>
                      <div className={`absolute -inset-1 rounded-full blur-md opacity-80 bg-gradient-to-tr ${currentRank.color} group-hover:opacity-100 transition-all duration-300`}></div>
                      
                      {/* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ (Gradient Border) */}
                      <div className={`relative p-[4px] rounded-full bg-gradient-to-br ${currentRank.color} shadow-2xl`}>
                          {/* –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∂–µ—Å—Ç–∫–æ –æ–±—Ä–µ–∑–∞–µ—Ç –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –±–ª—é—Ä */}
                          <div 
                              className="w-28 h-28 rounded-full overflow-hidden bg-slate-900 flex items-center justify-center relative border-2 border-slate-900 z-10"
                              style={{ transform: 'translateZ(0)' }} 
                          >
                                {avatar ? <img src={avatar} className="w-full h-full object-cover" /> : <UserIcon size={48} className="text-slate-500" />}
                                
                                {/* –û–≤–µ—Ä–ª–µ–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ —Å—Ç—Ä–æ–≥–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫—Ä—É–≥–∞ */}
                                <div className="absolute inset-0 rounded-full bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-all duration-300 backdrop-blur-sm z-20">
                                    <Upload size={28} className="text-white drop-shadow-lg" />
                                </div>
                          </div>
                      </div>
                  </div>
                  <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" hidden />
                  
                  {/* –ò–Ω—Ñ–æ –∏ –†–∞–Ω–≥ */}
                  <div className="text-center w-full z-10">
                      <div 
                        onClick={() => setShowRankRoad(true)}
                        className="cursor-pointer hover:scale-105 transition-transform inline-flex flex-col items-center group/rank"
                      >
                          <p className={`text-xl font-bold bg-gradient-to-r ${currentRank.color} bg-clip-text text-transparent drop-shadow-sm flex items-center gap-2`}>
                              {currentRank.title}
                              <ChevronRight size={18} className="text-slate-500 group-hover/rank:text-white transition-colors opacity-50" />
                          </p>
                      </div>
                      
                      {/* XP –ü—Ä–æ–≥—Ä–µ—Å—Å */}
                      <div className="w-full mt-4">
                          <div className="flex justify-between text-xs font-mono mb-1 text-slate-400">
                              <span>{profile.xp} XP</span>
                              <span>{isMaxRank ? 'MAX' : `${nextRank.threshold} XP`}</span>
                          </div>
                          <div className="h-2 w-full bg-slate-900 rounded-full overflow-hidden border border-white/5 shadow-inner">
                              <div 
                                className={`h-full bg-gradient-to-r ${currentRank.color} transition-all duration-1000 ease-out relative`}
                                style={{ width: `${xpProgress}%` }}
                              >
                                  <div className="absolute inset-0 bg-white/20 w-full h-1/2"></div>
                              </div>
                          </div>
                      </div>
                  </div>
              </GlassCard>

              {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–ª–∞ (–ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ) */}
              <GlassCard className="p-5">
                  <h3 className="font-semibold text-slate-200 mb-4 flex items-center gap-2">
                      <TrendingUp size={18} className="text-cyan-400" /> –§–∏–∑–∏–æ–ª–æ–≥–∏—è
                  </h3>
                  <div className="flex gap-3 mb-4">
                      <div className="flex-1 bg-slate-900/50 p-2 rounded-xl border border-white/5">
                          <label className="text-[10px] uppercase tracking-wider text-slate-500 mb-1 block px-1">–í–µ—Å (–∫–≥)</label>
                          <input 
                              value={weight} 
                              onChange={e => setWeight(e.target.value)} 
                              className="w-full bg-transparent border-none text-white font-mono text-lg px-1 outline-none" 
                          />
                      </div>
                      <div className="flex-1 bg-slate-900/50 p-2 rounded-xl border border-white/5">
                          <label className="text-[10px] uppercase tracking-wider text-slate-500 mb-1 block px-1">–ñ–∏—Ä (%)</label>
                          <input 
                              value={bf} 
                              onChange={e => setBf(e.target.value)} 
                              className="w-full bg-transparent border-none text-white font-mono text-lg px-1 outline-none" 
                          />
                      </div>
                  </div>
                  <Button onClick={handleSave} variant="primary" className="w-full h-10 text-sm">
                      <Save size={16} /> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                  </Button>
              </GlassCard>

              {/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ (–ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ) */}
              <div className="bg-slate-800/40 backdrop-blur-md border border-white/5 rounded-2xl p-4 flex items-center justify-between hover:bg-slate-800/60 transition-colors">
                  <div className="flex items-center gap-3">
                      <div className="p-2 bg-purple-500/10 rounded-lg">
                          <Database size={20} className="text-purple-400" />
                      </div>
                      <div>
                          <h4 className="text-sm font-semibold text-slate-200">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h4>
                          <p className="text-[11px] text-slate-500">–≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç JSON</p>
                      </div>
                  </div>
                  <div className="flex gap-1">
                      <Button onClick={handleExport} variant="ghost" className="p-2 h-9 w-9 text-cyan-400 hover:bg-cyan-500/20 hover:text-cyan-300 rounded-lg">
                          <Download size={16} />
                      </Button>
                      <Button onClick={handleImportClick} variant="ghost" className="p-2 h-9 w-9 text-purple-400 hover:bg-purple-500/20 hover:text-purple-300 rounded-lg">
                          <Upload size={16} />
                      </Button>
                      <input type="file" ref={backupInputRef} onChange={handleImportFile} accept=".json" hidden />
                  </div>
              </div>

          </div>

          {/* –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ì—Ä–∞—Ñ–∏–∫ –∏ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è */}
          <div className="lg:col-span-8 flex flex-col gap-6">
              
              {/* –ì—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞ */}
              <GlassCard className="flex flex-col p-5">
                  <div className="flex items-center justify-between mb-4">
                      <h3 className="font-semibold text-slate-200 flex items-center gap-2">
                          <TrendingUp className="text-cyan-400" size={20} /> –î–∏–Ω–∞–º–∏–∫–∞ –≤–µ—Å–∞
                      </h3>
                      {hasHistory && <span className="text-xs text-slate-500 font-mono border border-white/10 px-2 py-1 rounded bg-slate-900">{formattedHistory.length} –∑–∞–ø–∏—Å–µ–π</span>}
                  </div>
                  
                  {/* –Ø–≤–Ω–æ –∑–∞–¥–∞–µ–º –≤—ã—Å–æ—Ç—É –≥—Ä–∞—Ñ–∏–∫—É, —á—Ç–æ–±—ã –Ω–µ "—Å–∫—É–∫–æ–∂–∏–≤–∞–ª—Å—è" */}
                  <div className="h-[280px] w-full relative bg-slate-950/40 rounded-xl border border-white/5 p-3 shadow-inner">
                    {hasHistory ? (
                        <ResponsiveContainer width="100%" height="100%">
                            <LineChart data={formattedHistory} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" vertical={false} />
                                <XAxis dataKey="date" stroke="#475569" tick={{fontSize: 11, fill: '#94a3b8'}} dy={10} axisLine={false} tickLine={false} />
                                <YAxis domain={['dataMin - 2', 'dataMax + 2']} stroke="#475569" tick={{fontSize: 11, fill: '#94a3b8'}} axisLine={false} tickLine={false} />
                                <Tooltip 
                                    contentStyle={{ backgroundColor: '#0f172a', borderColor: '#1e293b', color: '#f8fafc', borderRadius: '12px', boxShadow: '0 10px 25px rgba(0,0,0,0.5)' }}
                                    itemStyle={{ color: '#22d3ee', fontWeight: 'bold' }}
                                    cursor={{ stroke: 'rgba(255,255,255,0.1)', strokeWidth: 2 }}
                                />
                                <Line 
                                    type="monotone" 
                                    dataKey="weight" 
                                    stroke="#22d3ee" 
                                    strokeWidth={4} 
                                    dot={{r: 4, fill: '#0f172a', stroke: '#22d3ee', strokeWidth: 2}} 
                                    activeDot={{r: 6, fill: '#22d3ee', stroke: '#fff', strokeWidth: 2}} 
                                />
                            </LineChart>
                        </ResponsiveContainer>
                    ) : (
                        <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-500 p-6 text-center">
                            <div className="bg-slate-800/50 p-4 rounded-full mb-3 shadow-inner">
                                <TrendingUp size={32} className="text-slate-400/50" />
                            </div>
                            <p className="text-base font-medium text-slate-300">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</p>
                            <p className="text-xs mt-2 max-w-xs text-slate-500">–†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–≤–æ–π –≤–µ—Å –≤ –ø–∞–Ω–µ–ª–∏ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.</p>
                        </div>
                    )}
                  </div>
              </GlassCard>

              {/* –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è */}
              <div>
                  <h3 className="text-xl font-bold text-yellow-500 flex items-center gap-2 mb-4 px-1 drop-shadow-sm">
                      <Trophy size={24} /> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                      {ACHIEVEMENTS_LIST.map(ach => {
                          const unlocked = !!achievements[ach.code];
                          return (
                              <div 
                                key={ach.code} 
                                className={`
                                    relative overflow-hidden rounded-xl p-3 border flex items-center gap-4 transition-all duration-300
                                    ${unlocked 
                                        ? 'bg-gradient-to-r from-yellow-500/10 to-transparent border-yellow-500/30 shadow-[0_4px_15px_rgba(234,179,8,0.05)]' 
                                        : 'bg-slate-900/40 border-white/5 opacity-60 grayscale hover:grayscale-0 hover:opacity-100'
                                    }
                                `}
                              >
                                  {unlocked && <div className="absolute left-0 top-0 bottom-0 w-1 bg-yellow-500/50"></div>}
                                  
                                  <div className={`p-3 rounded-full shrink-0 ${unlocked ? 'bg-yellow-500/20 text-yellow-400 shadow-inner' : 'bg-slate-800 text-slate-500'}`}>
                                      {unlocked ? <Unlock size={18} /> : <Lock size={18} />}
                                  </div>
                                  <div>
                                      <div className={`font-bold text-sm ${unlocked ? 'text-yellow-100 drop-shadow-sm' : 'text-slate-400'}`}>{ach.name}</div>
                                      <div className="text-[11px] text-slate-500 leading-tight mt-0.5">{ach.desc}</div>
                                  </div>
                              </div>
                          );
                      })}
                  </div>
              </div>

          </div>
      </div>

      {/* –ú–æ–¥–∞–ª–∫–∏ (–ö—Ä–æ–ø–ø–µ—Ä –∏ –ü—É—Ç—å –†–∞–Ω–≥–æ–≤ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ –ª–æ–≥–∏–∫–µ, —Ç–æ–ª—å–∫–æ —Å—Ç–∏–ª–∏) */}
      {cropImage && (
          <ImageCropper 
            imageSrc={cropImage} 
            onCancel={() => setCropImage(null)} 
            onCrop={handleCropped} 
          />
      )}

      {showRankRoad && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-in fade-in duration-200">
              <div className="w-full max-w-lg h-[90vh] bg-[#1d3557] rounded-3xl relative flex flex-col shadow-2xl overflow-hidden border-4 border-[#14233a]">
                  {/* Pattern Background */}
                  <div className="absolute inset-0 opacity-10 pointer-events-none" 
                    style={{
                      backgroundImage: 'radial-gradient(circle, #457b9d 1px, transparent 1px)',
                      backgroundSize: '20px 20px'
                    }}
                  ></div>

                  {/* Header */}
                  <div className="relative z-20 bg-[#14233a] p-4 flex justify-between items-center shadow-lg border-b border-[#1d3557]">
                      <div className="text-white font-bold text-lg flex items-center gap-2">
                          <Crown className="text-yellow-400" />
                          <span>–ü—É—Ç—å –∫ –í–µ–ª–∏—á–∏—é</span>
                      </div>
                      <button 
                        onClick={() => setShowRankRoad(false)} 
                        className="bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-3 py-1.5 text-sm font-bold shadow-[0_4px_0_rgb(30,58,138)] active:shadow-none active:translate-y-[4px] transition-all"
                      >
                          –ó–∞–∫—Ä—ã—Ç—å
                      </button>
                  </div>
                  
                  {/* Scrolling Road */}
                  <div className="flex-1 overflow-y-auto custom-scrollbar relative bg-[#1e293b]">
                      <div className="flex flex-col-reverse relative min-h-full" style={{ paddingBottom: '40px', paddingTop: '40px' }}>
                          
                          <div className="absolute left-1/2 -translate-x-1/2 top-0 bottom-0 w-3 bg-[#0f172a] border-x border-white/5 z-0" />

                          <div 
                            className="absolute left-1/2 -translate-x-1/2 bottom-0 w-3 bg-[#3b82f6] border-x border-blue-400 z-0 transition-all duration-1000 ease-out shadow-[0_0_15px_rgba(59,130,246,0.5)]"
                            style={{ height: `${progressPx}px` }}
                          />

                          <div 
                            className="absolute left-1/2 -translate-x-1/2 z-30 transition-all duration-700 ease-out flex flex-col items-center"
                            style={{ bottom: `${progressPx - 24}px` }}
                          >
                             <div className="mb-1 flex flex-col items-center animate-bounce">
                                <div className="text-[10px] font-bold text-white bg-blue-600 px-2 py-0.5 rounded shadow whitespace-nowrap border border-blue-400">
                                    {profile.xp} / {nextThresholdForRoad || 'MAX'} XP
                                </div>
                                <div className="w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[4px] border-t-blue-600"></div>
                             </div>

                             <div className="text-[10px] font-bold text-white bg-black/70 px-2 rounded mb-1 whitespace-nowrap uppercase tracking-wider">–í—ã</div>
                             <div className="w-12 h-12 rounded-full border-2 border-white overflow-hidden shadow-[0_0_20px_rgba(59,130,246,0.8)] bg-slate-800">
                                {avatar ? <img src={avatar} className="w-full h-full object-cover" /> : <UserIcon className="p-2 text-white" />}
                             </div>
                          </div>

                          {RANKS.map((rank, i) => {
                              const isReached = profile.xp >= rank.threshold;
                              const isEven = i % 2 === 0;
                              // @ts-ignore
                              const { cardBg, cardBorder } = rank;

                              return (
                                  <div 
                                    key={rank.threshold} 
                                    className={`relative z-10 flex w-full ${isEven ? 'justify-start pl-8' : 'justify-end pr-8'}`}
                                    style={{ height: `${ITEM_HEIGHT}px`, marginBottom: i === 0 ? `${BOTTOM_PADDING}px` : 0 }}
                                  >
                                      <div className={`w-[160px] relative`}>
                                          <div className={`absolute top-1/2 -translate-y-1/2 w-8 h-1 bg-[#0f172a] z-0 ${isEven ? '-right-8' : '-left-8'}`}>
                                               {isReached && <div className="w-full h-full bg-blue-500 shadow-[0_0_5px_rgba(59,130,246,0.5)]"></div>}
                                          </div>
                                          
                                          <div className={`
                                            absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full border-2 z-10
                                            ${isEven ? '-right-[42px]' : '-left-[42px]'}
                                            ${isReached ? 'bg-blue-500 border-white shadow-[0_0_10px_rgba(59,130,246,1)]' : 'bg-[#0f172a] border-slate-600'}
                                          `}></div>

                                          <div className={`absolute top-0 right-0 -mt-3 -mr-2 bg-[#14233a] text-white px-2 py-0.5 rounded font-mono text-[10px] border border-white/20 z-30 shadow-lg`}>
                                              {rank.threshold}
                                          </div>

                                          <div className={`
                                            h-28 rounded-xl border-b-4 shadow-xl flex flex-col items-center justify-center p-2 relative overflow-hidden transition-all duration-300
                                            ${isReached ? `${cardBg || 'bg-[#588157]'} ${cardBorder || 'border-[#3a5a40]'}` : 'bg-[#334155] border-[#1e293b] grayscale opacity-80'}
                                          `}>
                                              <div className="absolute inset-x-0 top-0 h-1/2 bg-white/5 pointer-events-none"></div>

                                              <div className={`mb-1 p-2 rounded-full ${isReached ? 'bg-black/20' : 'bg-black/40'}`}>
                                                {i === RANKS.length - 1 ? <Crown size={24} className="text-yellow-400 drop-shadow-md" /> :
                                                 <Trophy size={24} className={isReached ? "text-yellow-400" : "text-slate-400"} />}
                                              </div>
                                              
                                              <div className="text-center relative z-10">
                                                <div className="text-[9px] uppercase font-bold text-white/60 tracking-wider">–ê—Ä–µ–Ω–∞ {i + 1}</div>
                                                <div className="text-xs font-bold text-white leading-tight shadow-black drop-shadow-md">{rank.title}</div>
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              );
                          })}
                          <div style={{ height: '100px' }}></div>
                      </div>
                  </div>
              </div>
          </div>
      )}
    </div>
  );
};
</file>

<file path="pages/Sport.tsx">
import React, { useState } from 'react';
import { SportEntry } from '../types';
import { GlassCard, Button } from '../components/ui/GlassCard';
import { Dumbbell, Trash2, History as HistoryIcon, Sparkles, Loader2, Zap, Activity, Flame } from 'lucide-react';
import { SoundManager } from '../components/SoundManager';
import { toast } from 'react-hot-toast';
import { ai } from '../services/ai';

interface Props {
  entries: SportEntry[];
  onAdd: (s: Omit<SportEntry, 'id'>) => void;
  onDelete: (id: number) => void;
  onGoToHistory: () => void;
}

type Intensity = '–õ–µ–≥–∫–∞—è' | '–°—Ä–µ–¥–Ω—è—è' | '–¢—è–∂–µ–ª–∞—è';

// –¢–∏–ø –¥–ª—è –Ω–∞—à–∏—Ö —É–¥–∞—Ä–Ω—ã—Ö –≤–æ–ª–Ω
interface RippleEffect {
    id: number;
    color: string;
}

export const SportPage: React.FC<Props> = ({ entries, onAdd, onDelete, onGoToHistory }) => {
  const [inputText, setInputText] = useState('');
  const [intensity, setIntensity] = useState<Intensity>('–°—Ä–µ–¥–Ω—è—è');
  const [isParsing, setIsParsing] = useState(false);
  const [parsingStatus, setParsingStatus] = useState('');
  
  // –ú–∞—Å—Å–∏–≤ –≤–æ–ª–Ω (—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã—Å—Ç—Ä–æ —Å–ø–∞–º–∏—Ç—å –∫–Ω–æ–ø–∫—É –∏ –≤–∏–¥–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ª–Ω)
  const [ripples, setRipples] = useState<RippleEffect[]>([]);

  // –ü–æ–¥—Å—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤
  const totalSets = entries.reduce((acc, curr) => {
      if (!curr.details) return acc;
      const match = curr.details.match(/(\d+)\s*(?:–ø–æ|—Ö|x|–Ω–∞)/i);
      return acc + (match ? parseInt(match[1]) : 1);
  }, 0);

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –≥–ª–∞—Å—Å–º–æ—Ä—Ñ–∏–∑–º-–≤–æ–ª–Ω—ã
  const triggerPulseAnimation = (currentIntensity: Intensity) => {
      let color = 'rgba(168, 85, 247, 0.5)'; // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π (–°—Ä–µ–¥–Ω—è—è)
      if (currentIntensity === '–¢—è–∂–µ–ª–∞—è') color = 'rgba(244, 63, 94, 0.5)'; // –†–æ–∑–æ–≤—ã–π/–ö—Ä–∞—Å–Ω—ã–π
      if (currentIntensity === '–õ–µ–≥–∫–∞—è') color = 'rgba(34, 197, 94, 0.5)'; // –ó–µ–ª–µ–Ω—ã–π

      const newRipple = { id: Date.now(), color };
      setRipples(prev => [...prev, newRipple]);

      // –£–¥–∞–ª—è–µ–º –≤–æ–ª–Ω—É –∏–∑ DOM –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ (1 —Å–µ–∫—É–Ω–¥–∞)
      setTimeout(() => {
          setRipples(prev => prev.filter(r => r.id !== newRipple.id));
      }, 1000);
  };

  const handleSmartAdd = async () => {
    if (!inputText.trim()) {
        toast.error("–û–ø–∏—à–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ!");
        return;
    }

    setIsParsing(true);
    setParsingStatus('–ó–∞–ø—É—Å–∫ –ò–ò...');
    
    try {
        let parsed = await ai.parseSportEntry(inputText, (msg) => setParsingStatus(msg));
        
        let finalName = "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å";
        let finalDetails = "";
        let finalWeight = "";

        if (parsed) {
            finalName = parsed.name || "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å";
            finalDetails = parsed.details || "";
            finalWeight = parsed.weight || "";
            toast.success("–ò–ò —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª —Ç–µ–∫—Å—Ç!");
        } else {
            toast("–ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–ø–∏—Å–∞–Ω–æ –∫–∞–∫ –µ—Å—Ç—å", { icon: "‚ö†Ô∏è" });
            finalName = inputText.split(',')[0] || inputText;
        }

        const finalDetailsWithTag = `${finalDetails} [${intensity}]`.trim();

        onAdd({
            date_str: new Date().toISOString().split('T')[0],
            name: finalName.charAt(0).toUpperCase() + finalName.slice(1),
            details: finalDetailsWithTag,
            weight: finalWeight
        });

        SoundManager.playSuccess("–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∞–Ω–æ!");
        triggerPulseAnimation(intensity); // –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à—É –Ω–æ–≤—É—é –≤–æ–ª–Ω—É!
        
        setInputText('');
        setIntensity('–°—Ä–µ–¥–Ω—è—è');
    } catch (err) {
        toast.error("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ");
        console.error(err);
    } finally {
        setIsParsing(false);
        setParsingStatus('');
    }
  };

  const getIntensityColor = (detailsString: string) => {
      if (!detailsString) return 'text-slate-400 bg-slate-500/10 border-slate-500/30';
      if (detailsString.includes('[–¢—è–∂–µ–ª–∞—è]')) return 'text-rose-400 bg-rose-500/10 border-rose-500/30 shadow-[0_0_15px_rgba(244,63,94,0.15)]';
      if (detailsString.includes('[–õ–µ–≥–∫–∞—è]')) return 'text-green-400 bg-green-500/10 border-green-500/30 shadow-[0_0_15px_rgba(34,197,94,0.1)]';
      return 'text-purple-400 bg-purple-500/10 border-purple-500/30 shadow-[0_0_15px_rgba(168,85,247,0.15)]'; 
  };

  return (
    <div className="h-full flex flex-col gap-6 relative overflow-hidden">
      
      {/* –ú–ê–ì–ò–Ø –ì–õ–ê–°–°–ú–û–†–§–ò–ó–ú–ê: 
        –ò–Ω–∂–µ–∫—Ç–∏—Ä—É–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä—è–º–æ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç.
      */}
      <style>{`
        @keyframes shockwave-glass {
          0% { 
            transform: translate(-50%, -50%) scale(0); 
            opacity: 1; 
            border-width: 20px; 
          }
          100% { 
            transform: translate(-50%, -50%) scale(2.5); 
            opacity: 0; 
            border-width: 0px; 
          }
        }
        @keyframes shockwave-color {
          0% { transform: translate(-50%, -50%) scale(0); opacity: 0.8; }
          100% { transform: translate(-50%, -50%) scale(3); opacity: 0; }
        }
        .ripple-container {
          position: absolute; 
          inset: 0; 
          pointer-events: none; 
          z-index: 50; /* –ü–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–æ—á–µ–∫, –Ω–æ –ø–æ–¥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ */
          overflow: hidden;
        }
        .glass-ring {
          position: absolute; 
          top: 50%; 
          left: 50%;
          width: 80vmin; /* –ö—Ä—É–≥ –±—É–¥–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ –∫—Ä—É–≥–ª—ã–º –Ω–∞ –ª—é–±–æ–º —ç–∫—Ä–∞–Ω–µ */
          height: 80vmin; 
          border-radius: 50%;
          border: solid rgba(255, 255, 255, 0.8);
          /* –≠—Ñ—Ñ–µ–∫—Ç –ª–∏–Ω–∑—ã –∏ –∏—Å–∫–∞–∂–µ–Ω–∏—è */
          backdrop-filter: blur(16px) brightness(1.2) contrast(1.1);
          -webkit-backdrop-filter: blur(16px) brightness(1.2) contrast(1.1);
          animation: shockwave-glass 1s cubic-bezier(0.1, 0.8, 0.3, 1) forwards;
        }
        .color-blob {
          position: absolute; 
          top: 50%; 
          left: 50%;
          width: 60vmin; 
          height: 60vmin; 
          border-radius: 50%;
          filter: blur(50px); 
          mix-blend-mode: screen;
          animation: shockwave-color 1s cubic-bezier(0.1, 0.8, 0.3, 1) forwards;
        }
      `}</style>

      {/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤–æ–ª–Ω */}
      <div className="ripple-container">
          {ripples.map(r => (
              <React.Fragment key={r.id}>
                  {/* –ò—Å–∫–∞–∂–∞—é—â–µ–µ —Å—Ç–µ–∫–ª–æ —Å —Ü–≤–µ—Ç–Ω–æ–π —Ç–µ–Ω—å—é */}
                  <div 
                      className="glass-ring" 
                      style={{ boxShadow: `0 0 60px ${r.color}, inset 0 0 60px ${r.color}` }}
                  />
                  {/* –ú—è–≥–∫–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è —Å–µ—Ä–¥—Ü–µ–≤–∏–Ω–∞ */}
                  <div 
                      className="color-blob" 
                      style={{ backgroundColor: r.color }} 
                  />
              </React.Fragment>
          ))}
      </div>

      {/* --- –û–°–¢–ê–õ–¨–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° --- */}
      <div className="flex flex-col gap-4 shrink-0 relative z-10">
          <div className="flex items-center justify-between">
             <h2 className="text-2xl font-bold flex items-center gap-3">
                <div className="p-2 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-xl text-white shadow-[0_0_20px_rgba(168,85,247,0.4)]">
                    <Activity size={24} />
                </div>
                –ñ—É—Ä–Ω–∞–ª —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
             </h2>
             <Button onClick={onGoToHistory} variant="secondary" className="text-xs py-2 px-3">
                 <HistoryIcon size={16} /> –ò—Å—Ç–æ—Ä–∏—è
             </Button>
          </div>

          <div className="grid grid-cols-2 gap-4">
              <GlassCard className="p-4 flex items-center justify-between relative overflow-hidden group">
                  <div className="absolute -right-4 -top-4 opacity-5 group-hover:opacity-10 transition-opacity">
                      <Dumbbell size={100} />
                  </div>
                  <div>
                      <p className="text-xs text-slate-400 uppercase tracking-widest font-bold mb-1">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>
                      <p className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400">
                          {entries.length}
                      </p>
                  </div>
              </GlassCard>
              
              <GlassCard className="p-4 flex items-center justify-between relative overflow-hidden group">
                  <div className="absolute -right-4 -top-4 opacity-5 group-hover:opacity-10 transition-opacity">
                      <Zap size={100} />
                  </div>
                  <div>
                      <p className="text-xs text-slate-400 uppercase tracking-widest font-bold mb-1">–í—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–æ–≤</p>
                      <p className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-rose-400">
                          {totalSets}
                      </p>
                  </div>
              </GlassCard>
          </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 flex-1 min-h-0 relative z-10">
          
          <GlassCard className="flex flex-col gap-5 h-fit relative">
              <div className="flex items-center gap-2 border-b border-white/5 pb-3">
                  <Sparkles size={18} className="text-cyan-400" />
                  <h3 className="font-semibold text-slate-300">–£–º–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</h3>
              </div>
              
              <div>
                  <label className="text-xs text-slate-500 mb-2 block uppercase tracking-wider font-bold">–û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ö–æ–¥</label>
                  <textarea 
                      value={inputText} 
                      onChange={e => setInputText(e.target.value)} 
                      placeholder="–ù–∞–ø—Ä: –ñ–∏–º –ª–µ–∂–∞, 2 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 6 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π, 65–∫–≥..." 
                      className="w-full bg-slate-900/80 border border-white/10 rounded-xl p-4 outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all resize-none h-28 text-sm" 
                  />
              </div>

              <div>
                  <label className="text-xs text-slate-500 mb-2 block uppercase tracking-wider font-bold">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</label>
                  <div className="flex bg-slate-900/50 p-1 rounded-lg border border-white/5">
                      {(['–õ–µ–≥–∫–∞—è', '–°—Ä–µ–¥–Ω—è—è', '–¢—è–∂–µ–ª–∞—è'] as Intensity[]).map(level => (
                          <button
                              key={level}
                              onClick={() => setIntensity(level)}
                              className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${
                                  intensity === level 
                                    ? level === '–¢—è–∂–µ–ª–∞—è' ? 'bg-rose-500/20 text-rose-400 shadow-[0_0_10px_rgba(244,63,94,0.2)]'
                                    : level === '–õ–µ–≥–∫–∞—è' ? 'bg-green-500/20 text-green-400 shadow-[0_0_10px_rgba(34,197,94,0.2)]'
                                    : 'bg-purple-500/20 text-purple-400 shadow-[0_0_10px_rgba(168,85,247,0.2)]'
                                  : 'text-slate-500 hover:text-slate-300'
                              }`}
                          >
                              {level}
                          </button>
                      ))}
                  </div>
              </div>

              <div className="relative mt-2">
                  {isParsing && (
                      <div className="absolute -top-8 left-1/2 -translate-x-1/2 text-center text-[10px] text-cyan-400 bg-slate-900/90 rounded px-3 py-1 whitespace-nowrap z-50 animate-pulse border border-cyan-900 shadow-xl">
                          {parsingStatus}
                      </div>
                  )}
                  <Button 
                      onClick={handleSmartAdd} 
                      disabled={isParsing}
                      variant="primary" 
                      className={`w-full py-4 text-sm font-bold tracking-widest shadow-lg ${isParsing ? 'opacity-70' : 'hover:-translate-y-1'}`}
                  >
                      {isParsing ? <Loader2 size={18} className="animate-spin" /> : <Zap size={18} />} 
                      {isParsing ? '–ê–ù–ê–õ–ò–ó...' : '–ó–ê–ü–ò–°–ê–¢–¨'}
                  </Button>
              </div>
          </GlassCard>

          <GlassCard className="md:col-span-2 flex flex-col min-h-0" noPadding>
              <div className="p-4 border-b border-white/5 bg-slate-800/30 flex items-center justify-between">
                  <h3 className="font-semibold text-slate-300 uppercase tracking-widest text-xs flex items-center gap-2">
                      <Flame size={16} className="text-orange-500" /> –í—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è
                  </h3>
              </div>
              
              <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                  {entries.length === 0 && (
                      <div className="h-full flex flex-col items-center justify-center text-slate-500">
                          <Dumbbell size={48} className="mb-4 opacity-20" />
                          <p className="text-sm">–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç. –í—Ä–µ–º—è –ø–æ–ø–æ—Ç–µ—Ç—å!</p>
                      </div>
                  )}
                  
                  {entries.map(e => {
                      const colorClass = getIntensityColor(e.details);
                      const cleanDetails = e.details ? e.details.replace(/\\[.*?\\]/, '').trim() : ''; 
                      
                      return (
                          <div 
                              key={e.id} 
                              className={`relative overflow-hidden bg-slate-900/60 border rounded-xl p-4 flex items-center justify-between group transition-all duration-300 hover:bg-slate-800/80 ${colorClass}`}
                          >
                              <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${colorClass.split(' ')[0].replace('text-', 'bg-')}`} />
                              
                              <div className="flex items-center gap-4 pl-2">
                                  <div className={`w-12 h-12 rounded-full flex items-center justify-center border border-current bg-slate-950/50`}>
                                      <Dumbbell size={20} className="opacity-80" />
                                  </div>
                                  <div>
                                      <div className="font-bold text-white text-lg tracking-tight">{e.name}</div>
                                      <div className="text-sm flex items-center gap-2 mt-0.5">
                                          {cleanDetails && <span className="text-slate-300 bg-slate-950 px-2 py-0.5 rounded text-xs border border-white/5">{cleanDetails}</span>}
                                          {e.weight && <span className="text-slate-400 font-mono text-xs">{e.weight}</span>}
                                      </div>
                                  </div>
                              </div>
                              
                              <Button 
                                  onClick={() => onDelete(e.id)} 
                                  variant="ghost" 
                                  className="opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-500/20 hover:text-red-400 border border-transparent hover:border-red-500/30"
                              >
                                  <Trash2 size={18} />
                              </Button>
                          </div>
                      );
                  })}
              </div>
          </GlassCard>
      </div>
    </div>
  );
};
</file>

<file path="pages/Store.tsx">
import React, { useState, useEffect, useRef } from 'react';
import { GlassCard, Button } from '../components/ui/GlassCard';
import { UserProfile, PurchaseEntry } from '../types';
import { 
    ShoppingBag, Snowflake, Coins, Zap, Pizza, Sandwich, 
    History, Scroll, Fish, Beef, Utensils, CupSoda, 
    Candy, Lock, Film, Tv, Youtube, Smartphone, Flame,
    Minus, Plus, ShoppingCart, Trash2, Moon
} from 'lucide-react';
import { toast } from 'react-hot-toast';
import { repo } from '../services/repository';

interface Props {
  profile: UserProfile;
  onBuyFreeze: () => boolean;
  onBuyGoldenHour: () => boolean; 
}

const FOOD_ITEMS = [
    { name: "–°–æ—á–Ω–∞—è –ü–∏—Ü—Ü–∞", icon: Pizza, cost: 500, desc: "–ò—Ç–∞–ª—å—è–Ω—Å–∫–∞—è –∫–ª–∞—Å—Å–∏–∫–∞ –¥–ª—è –¥—É—à–∏." },
    { name: "–ú–æ—â–Ω—ã–π –ë—É—Ä–≥–µ—Ä", icon: Sandwich, cost: 450, desc: "–í–∫—É—Å–Ω–µ–π—à–∞—è –∫–æ—Ç–ª–µ—Ç–∞ —Å —Å—ã—Ä–æ–º." },
    { name: "–°—ã—Ç–Ω–∞—è –®–∞—É—Ä–º–∞", icon: Scroll, cost: 300, desc: "–ü–∏—â–∞ –±–æ–≥–æ–≤." },
    { name: "–°–µ—Ç –°—É—à–∏", icon: Fish, cost: 800, desc: "–ü—Ä–µ–º–∏—É–º —Ä–æ–ª–ª—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è." },
    { name: "–°—Ç–µ–π–∫ –†–∏–±–∞–π", icon: Beef, cost: 1200, desc: "–ú—è—Å–æ –¥–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ —Ö–∏—â–Ω–∏–∫–∞." },
    { name: "–ë–∞–Ω–∫–∞ –ö–æ–ª—ã", icon: CupSoda, cost: 150, desc: "–õ–µ–¥—è–Ω–∞—è –∏ –æ—Å–≤–µ–∂–∞—é—â–∞—è." },
    { name: "–®–æ–∫–æ–ª–∞–¥–∫–∞", icon: Candy, cost: 100, desc: "–ë—ã—Å—Ç—Ä–∞—è —ç–Ω–µ—Ä–≥–∏—è –∏ —ç–Ω–¥–æ—Ä—Ñ–∏–Ω—ã." },
];

const DOPAMINE_ITEMS = [
    { name: "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–ª—å–º", icon: Film, cost: 500, desc: "–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –æ—Ç–¥—ã—Ö –Ω–∞ 2 —á–∞—Å–∞." },
    { name: "–°–µ—Ä–∏—è —Å–µ—Ä–∏–∞–ª–∞", icon: Tv, cost: 300, desc: "–ö–æ—Ä–æ—Ç–∫–∏–π —ç–ø–∏–∑–æ–¥ –ª—é–±–∏–º–æ–≥–æ —à–æ—É." },
    { name: "–†–æ–ª–∏–∫ YouTube", icon: Youtube, cost: 100, desc: "–ü–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ —Å–º–µ—à–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç." },
    { name: "YT Shorts (30 –º–∏–Ω)", icon: Zap, cost: 300, desc: "–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Ñ–∞–º–∏–Ω –ø–æ —Ç–∞–π–º–µ—Ä—É." },
    { name: "–ó–∞—Ä—è–¥–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω", icon: Smartphone, cost: 30, desc: "–†–∏—Ç—É–∞–ª –ø–æ–ª–Ω–æ–π –∑–∞—Ä—è–¥–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞." },
    { name: "–ú–∞—Å—Ç—É—Ä–±–∞—Ü–∏—è", icon: Flame, cost: 300, desc: "–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–∞–∑—Ä—è–¥–∫–∞." },
    { name: "–î–Ω–µ–≤–Ω–æ–π —Å–æ–Ω", icon: Moon, cost: 300, desc: "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–∑–≥–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏–ª." },
];

const SORTED_FOOD = [...FOOD_ITEMS].sort((a, b) => a.cost - b.cost);
const SORTED_DOPAMINE = [...DOPAMINE_ITEMS].sort((a, b) => a.cost - b.cost);

interface CartItem {
    name: string;
    cost: number;
    category: 'bonus' | 'food' | 'dopamine';
    qty: number;
}

export const StorePage: React.FC<Props> = ({ profile, onBuyFreeze, onBuyGoldenHour }) => {
  const [tab, setTab] = useState<'bonus' | 'food' | 'dopamine' | 'history'>('bonus');
  const [purchaseHistory, setPurchaseHistory] = useState<PurchaseEntry[]>([]);
  const [cart, setCart] = useState<CartItem[]>([]);
  const totalCost = cart.reduce((sum, item) => sum + (item.cost * item.qty), 0);

  const [pin, setPin] = useState(['', '', '', '']);
  const [isUnlocked, setIsUnlocked] = useState(false);
  const pinRefs = [useRef<HTMLInputElement>(null), useRef<HTMLInputElement>(null), useRef<HTMLInputElement>(null), useRef<HTMLInputElement>(null)];

  useEffect(() => {
    if (tab !== 'dopamine') { setIsUnlocked(false); setPin(['', '', '', '']); }
    setPurchaseHistory(repo.getPurchaseHistory());
  }, [tab, profile.coins]);

  const [timeLeft, setTimeLeft] = useState<string | null>(null);
  useEffect(() => {
    const interval = setInterval(() => {
        if (profile.golden_hour_expires && profile.golden_hour_expires > Date.now()) {
            const diff = Math.floor((profile.golden_hour_expires - Date.now()) / 1000);
            const h = Math.floor(diff / 3600);
            const m = Math.floor((diff % 3600) / 60);
            const s = diff % 60;
            setTimeLeft(`${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`);
        } else setTimeLeft(null);
    }, 1000);
    return () => clearInterval(interval);
  }, [profile.golden_hour_expires]);

  const handlePinChange = (val: string, idx: number) => {
    if (!/^\d?$/.test(val)) return;
    const newPin = [...pin];
    newPin[idx] = val;
    setPin(newPin);
    if (val && idx < 3) pinRefs[idx + 1].current?.focus();
  };

  const checkPin = () => {
    const now = new Date();
    const currentTimeStr = now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0');
    if (pin.join('') === currentTimeStr) { setIsUnlocked(true); toast.success("–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω", { icon: 'üîì' }); }
    else { toast.error("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥"); setPin(['', '', '', '']); pinRefs[0].current?.focus(); }
  };

  const addToCart = (name: string, cost: number, category: 'bonus' | 'food' | 'dopamine', maxQty?: number) => {
    setCart(prev => {
        const existing = prev.find(i => i.name === name);
        if (existing) {
            if (maxQty && existing.qty >= maxQty) return prev;
            return prev.map(i => i.name === name ? { ...i, qty: i.qty + 1 } : i);
        }
        return [...prev, { name, cost, category, qty: 1 }];
    });
  };

  const removeFromCart = (name: string) => {
    setCart(prev => {
        const existing = prev.find(i => i.name === name);
        if (existing && existing.qty > 1) return prev.map(i => i.name === name ? { ...i, qty: i.qty - 1 } : i);
        return prev.filter(i => i.name !== name);
    });
  };

  const handleCheckout = () => {
    if (totalCost > profile.coins) { toast.error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!"); return; }
    let successCount = 0;
    
    // –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–∞–≥—Ä–∞–¥—ã
    const existing = localStorage.getItem('user_purchased_rewards');
    const purchasedRewards = existing ? JSON.parse(existing) : [];

    cart.forEach(item => {
        for (let i = 0; i < item.qty; i++) {
            if (item.category === 'bonus') {
                if (item.name === '–ó–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ç—Ä–∏–∫–∞' && onBuyFreeze()) successCount++;
                if (item.name === '–ó–æ–ª–æ—Ç—ã–µ —Å—É—Ç–∫–∏' && onBuyGoldenHour()) successCount++;
            } else {
                if (repo.buyReward(item.name, item.cost, item.category as any)) {
                    successCount++;
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç –≤ –º–∞—Å—Å–∏–≤ –Ω–∞ 24 —á–∞—Å–∞
                    purchasedRewards.push({
                        id: `${Date.now()}_${Math.random()}`,
                        name: item.name,
                        category: item.category,
                        expiresAt: Date.now() + (24 * 60 * 60 * 1000)
                    });
                }
            }
        }
    });

    if (successCount > 0) {
        toast.success(`–ö—É–ø–ª–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${successCount}`);
        setCart([]);
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –≤—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ–±—ã –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –æ–±–Ω–æ–≤–∏–ª—Å—è (–µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã –≤ —Å–æ—Å–µ–¥–Ω–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö, —Ö–æ—Ç—è –∏ –±–µ–∑ —ç—Ç–æ–≥–æ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç)
        localStorage.setItem('user_purchased_rewards', JSON.stringify(purchasedRewards));
        window.dispatchEvent(new Event('storage'));
        setPurchaseHistory(repo.getPurchaseHistory());
    }
};

  const deleteHistoryEntry = (id: number) => {
      if (window.confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?")) {
          repo.deletePurchaseEntry(id);
          setPurchaseHistory(repo.getPurchaseHistory());
          toast.success("–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞");
      }
  };

  const renderItemAction = (name: string, cost: number, category: 'bonus' | 'food' | 'dopamine', maxQty?: number) => {
      const qty = cart.find(i => i.name === name)?.qty || 0;
      if (qty > 0) {
          return (
              <div className="flex items-center justify-between w-full bg-slate-900 rounded-lg p-1 border border-cyan-500/30 h-10 mt-auto">
                  <button onClick={() => removeFromCart(name)} className="w-8 h-full flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-800 rounded transition-colors"><Minus size={16}/></button>
                  <span className="font-bold text-white text-sm">{qty} —à—Ç</span>
                  <button onClick={() => addToCart(name, cost, category, maxQty)} disabled={maxQty ? qty >= maxQty : false} className="w-8 h-full flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-800 rounded transition-colors disabled:opacity-30"><Plus size={16}/></button>
              </div>
          )
      }
      return (
          <Button onClick={() => addToCart(name, cost, category, maxQty)} className="w-full h-10 bg-slate-800 hover:bg-slate-700 transition-colors mt-auto">
              <div className="flex items-center gap-1">{cost} <Coins size={14} className="text-yellow-400"/></div>
          </Button>
      )
  };

  return (
    <div className="h-full flex flex-col relative">
       <div className="flex items-center justify-between mb-6 shrink-0">
          <div>
            <h2 className="text-2xl font-bold text-white mb-2 flex items-center gap-2"><ShoppingBag className="text-purple-400" /> –ú–∞–≥–∞–∑–∏–Ω</h2>
            <p className="text-slate-400 text-sm">–ù–∞–≥—Ä–∞–¥—ã –∑–∞ –≤–∞—à–∏ —Ç—Ä—É–¥—ã.</p>
          </div>
          <div className="bg-slate-900/50 px-4 py-2 rounded-xl border border-white/10 flex items-center gap-2 shadow-inner">
              <Coins className="text-yellow-400" size={20} />
              <span className="text-xl font-bold font-mono text-yellow-100">{profile.coins}</span>
          </div>
       </div>

       <div className="flex gap-2 mb-4 overflow-x-auto pb-2 shrink-0 custom-scrollbar">
           {[ {id:'bonus', icon: Zap, label:'–ë–æ–Ω—É—Å—ã', color:'bg-purple-600'}, {id:'food', icon: Utensils, label:'–ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏', color:'bg-orange-600'}, {id:'dopamine', icon: Lock, label:'–î–æ—Ñ–∞–º–∏–Ω', color:'bg-rose-600'}, {id:'history', icon: History, label:'–ò—Å—Ç–æ—Ä–∏—è', color:'bg-slate-600'}].map(t => (
               <button key={t.id} onClick={() => setTab(t.id as any)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2 whitespace-nowrap ${tab === t.id ? `${t.color} text-white` : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                   <t.icon size={16} /> {t.label}
               </button>
           ))}
       </div>

       <div className="flex-1 overflow-y-auto pb-28 custom-scrollbar relative min-h-0 pr-2">
           {tab === 'bonus' && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <GlassCard className="flex flex-col items-center text-center h-full">
                        <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 ${profile.has_freeze ? 'bg-slate-700/50 grayscale opacity-50' : 'bg-blue-500/20'}`}><Snowflake size={40} className="text-blue-300" /></div>
                        <h3 className="text-lg font-bold text-white mb-2">–ó–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ç—Ä–∏–∫–∞</h3>
                        <p className="text-xs text-slate-400 mb-6 flex-1">–ü—Ä–æ–ø—É—Å–∫ –¥–Ω—è –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å–µ—Ä–∏–∏.</p>
                        <div className="w-full mt-auto">{profile.has_freeze ? <Button disabled className="w-full opacity-50 bg-slate-800">–ö—É–ø–ª–µ–Ω–æ</Button> : renderItemAction('–ó–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ç—Ä–∏–∫–∞', 500, 'bonus', 1)}</div>
                    </GlassCard>
                    <GlassCard className="flex flex-col items-center text-center h-full relative">
                        {timeLeft && <div className="absolute top-0 inset-x-0 bg-yellow-500/20 text-yellow-200 text-[10px] font-bold text-center py-1 uppercase">–ê–∫—Ç–∏–≤–Ω–æ: {timeLeft}</div>}
                        <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 mt-2 ${timeLeft ? 'bg-yellow-500/30 animate-pulse' : 'bg-yellow-500/20'}`}><Zap size={40} className="text-yellow-400" /></div>
                        <h3 className="text-lg font-bold text-white mb-2">–ó–æ–ª–æ—Ç—ã–µ —Å—É—Ç–∫–∏</h3>
                        <p className="text-xs text-slate-400 mb-6 flex-1">–£–¥–≤–æ–µ–Ω–∏–µ XP –Ω–∞ 24 —á–∞—Å–∞.</p>
                        <div className="w-full mt-auto">{timeLeft ? <Button disabled className="w-full opacity-50 bg-slate-800">–ê–∫—Ç–∏–≤–Ω–æ</Button> : renderItemAction('–ó–æ–ª–æ—Ç—ã–µ —Å—É—Ç–∫–∏', 5000, 'bonus', 1)}</div>
                    </GlassCard>
                </div>
           )}

           {tab === 'food' && (
               <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                   {SORTED_FOOD.map((item, idx) => (
                       <GlassCard key={idx} className="flex flex-col items-center text-center group h-full">
                           <div className="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><item.icon size={32} className="text-orange-400" /></div>
                           <h3 className="font-bold text-white mb-1">{item.name}</h3>
                           <p className="text-xs text-slate-500 mb-4 flex-1">{item.desc}</p>
                           <div className="w-full mt-auto">{renderItemAction(item.name, item.cost, 'food')}</div>
                       </GlassCard>
                   ))}
               </div>
           )}

           {tab === 'dopamine' && (
               <div className="h-full flex flex-col items-center">
                   {!isUnlocked ? (
                       <GlassCard className="w-full max-w-sm p-8 text-center border-rose-500/30 my-10">
                           <Lock size={48} className="text-rose-500 mx-auto mb-4" />
                           <h3 className="text-xl font-bold text-white mb-2">–°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ä–∞–∑–¥–µ–ª</h3>
                           <p className="text-slate-400 text-sm mb-6">–í–≤–µ–¥–∏—Ç–µ –ø–∏–Ω-–∫–æ–¥.</p>
                           <div className="flex justify-center gap-3 mb-8">
                               {pin.map((digit, i) => (
                                   <input key={i} ref={pinRefs[i]} type="text" maxLength={1} value={digit} onChange={(e) => handlePinChange(e.target.value, i)} className="w-12 h-16 bg-slate-950 border-2 border-white/10 rounded-xl text-center text-2xl font-bold text-rose-400 focus:border-rose-500 outline-none transition-colors" />
                               ))}
                           </div>
                           <Button onClick={checkPin} variant="primary" className="w-full bg-rose-600 hover:bg-rose-500 py-4 text-white">–†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–¢–¨</Button>
                       </GlassCard>
                   ) : (
                       <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 w-full">
                           {SORTED_DOPAMINE.map((item, idx) => (
                               <GlassCard key={idx} className="flex flex-col items-center text-center border-rose-500/20 group h-full">
                                   <div className="w-16 h-16 rounded-full bg-rose-500/10 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><item.icon size={32} className="text-rose-400" /></div>
                                   <h3 className="font-bold text-white mb-1">{item.name}</h3>
                                   <p className="text-xs text-slate-500 mb-4 flex-1">{item.desc}</p>
                                   <div className="w-full mt-auto">{renderItemAction(item.name, item.cost, 'dopamine')}</div>
                               </GlassCard>
                           ))}
                       </div>
                   )}
               </div>
           )}

           {tab === 'history' && (
               <div className="space-y-2">
                   {purchaseHistory.length === 0 && <div className="text-center text-slate-500 py-10">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.</div>}
                   {purchaseHistory.map(entry => (
                       <div key={entry.id} className="bg-slate-800/50 rounded-lg p-3 flex justify-between items-center border border-white/5">
                           <div className="flex items-center gap-3">
                               <div className={`p-2 rounded-full ${entry.category === 'bonus' ? 'bg-purple-500/20 text-purple-400' : entry.category === 'dopamine' ? 'bg-rose-500/20 text-rose-400' : 'bg-orange-500/20 text-orange-400'}`}>
                                   {entry.category === 'dopamine' ? <Lock size={16}/> : <Utensils size={16}/>}
                               </div>
                               <div>
                                   <div className={`font-bold text-sm transition-all ${entry.category === 'dopamine' ? 'blur-[5px] select-none pointer-events-none opacity-50' : ''}`}>
                                       {entry.item_name}
                                   </div>
                                   <div className="text-xs text-slate-500">{entry.date_str}</div>
                               </div>
                           </div>
                           <div className="flex items-center gap-4">
                               <div className="font-mono text-yellow-400 text-sm">-{entry.cost} ü™ô</div>
                               <button onClick={() => deleteHistoryEntry(entry.id)} className="text-slate-600 hover:text-red-400 transition-colors p-1"><Trash2 size={16}/></button>
                           </div>
                       </div>
                   ))}
               </div>
           )}
       </div>

       {cart.length > 0 && (
           <div className="absolute bottom-4 left-4 right-4 bg-slate-800/95 backdrop-blur-md border border-cyan-500/40 rounded-2xl p-4 shadow-2xl flex flex-col md:flex-row items-center justify-between z-50 animate-in slide-in-from-bottom-8 gap-4">
               <div className="flex items-center gap-4 w-full md:w-auto">
                   <div className="w-12 h-12 bg-cyan-500/20 rounded-xl flex items-center justify-center text-cyan-400 shadow-inner"><ShoppingCart size={24} /></div>
                   <div>
                       <div className="text-sm text-slate-400">–¢–æ–≤–∞—Ä–æ–≤: {cart.reduce((s, i) => s + i.qty, 0)} —à—Ç</div>
                       <div className="text-xl font-bold text-white flex items-center gap-2">–ò—Ç–æ–≥–æ: <span className={totalCost > profile.coins ? "text-red-400" : "text-white"}>{totalCost}</span> <Coins size={18} className="text-yellow-400" /></div>
                   </div>
               </div>
               <div className="flex gap-3 w-full md:w-auto">
                   <Button variant="ghost" onClick={() => setCart([])} className="flex-1 md:flex-none py-3">–û—á–∏—Å—Ç–∏—Ç—å</Button>
                   <Button variant="primary" onClick={handleCheckout} className={`flex-1 md:flex-none py-3 px-6 shadow-lg transition-all ${totalCost > profile.coins ? "bg-red-600 hover:bg-red-500 text-white" : "bg-cyan-600 hover:bg-cyan-500 text-white"}`}>
                       {totalCost > profile.coins ? '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç' : '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'}
                   </Button>
               </div>
           </div>
       )}
    </div>
  );
};
</file>

<file path="pages/Tasks.tsx">
import React, { useState, useEffect } from 'react';
import { Task } from '../types';
import { GlassCard, Button } from '../components/ui/GlassCard';
import { Plus, Trash2, Edit3, Power, Check, LayoutDashboard, Clock, AlertCircle } from 'lucide-react';
import { toast } from 'react-hot-toast';

interface Props {
  tasks: Task[];
  onAdd: (t: Omit<Task, 'id'>) => void;
  onUpdate: (t: Task) => void;
  onDelete: (id: number) => void;
  onComplete: (id: number) => void; 
}

const DAYS = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"];

// –°—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
type TaskStatus = 'upcoming' | 'missed' | 'completed' | 'disabled';

export const TasksPage: React.FC<Props> = ({ tasks, onAdd, onUpdate, onDelete, onComplete }) => {
  const [selectedId, setSelectedId] = useState<number | null>(null);
  const [isModalOpen, setModalOpen] = useState(false);
  const [editingTask, setEditingTask] = useState<Task | null>(null);
  const [now, setNow] = useState(new Date());

  useEffect(() => {
    const timer = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –Ω–∞ –ø–µ—Ä–≤—É—é –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∑–∞–¥–∞—á—É, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
  useEffect(() => {
    if (!selectedId && tasks.length > 0) {
      const sorted = getSortedTasks();
      if (sorted.length > 0) setSelectedId(sorted[0].id);
    }
  }, [tasks]);

  const getLogicalDate = () => {
    const d = new Date(now);
    if (d.getHours() < 4) d.setDate(d.getDate() - 1);
    return d.toISOString().split('T')[0];
  };

  const getTaskStatus = (task: Task): TaskStatus => {
    if (!task.enabled) return 'disabled';
    
    const todayStr = getLogicalDate();
    const currentMaskIdx = now.getDay() === 0 ? 6 : now.getDay() - 1;
    const isToday = (task.days_mask & (1 << currentMaskIdx)) !== 0;

    if (!isToday) return 'disabled';
    if (task.last_completed === todayStr) return 'completed';

    const [h, m] = task.t_hhmm.split(':').map(Number);
    const taskTime = new Date(now);
    if (now.getHours() < 4) taskTime.setDate(taskTime.getDate() - 1);
    taskTime.setHours(h, m, 0, 0);

    return now > taskTime ? 'missed' : 'upcoming';
  };

  const getSortedTasks = () => {
    return [...tasks].sort((a, b) => {
      const statusA = getTaskStatus(a);
      const statusB = getTaskStatus(b);
      
      const weights: Record<TaskStatus, number> = { 
        upcoming: 0, 
        missed: 1, 
        completed: 2, 
        disabled: 3 
      };

      if (weights[statusA] !== weights[statusB]) {
        return weights[statusA] - weights[statusB];
      }
      return a.t_hhmm.localeCompare(b.t_hhmm);
    });
  };

  const selectedTask = tasks.find(t => t.id === selectedId);

  const getDaysString = (mask: number) => {
    if (mask === 0) return "‚Äî";
    if (mask === 127) return "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å";
    return DAYS.filter((_, i) => (mask & (1 << i))).join(", ");
  };

  const getTimeRemaining = (task: Task) => {
    if (!task.enabled) return { text: "–û—Ç–∫–ª—é—á–µ–Ω–æ", color: "text-slate-600" };
    
    const status = getTaskStatus(task);
    if (status === 'completed') return { text: "–í—ã–ø–æ–ª–Ω–µ–Ω–æ", color: "text-green-400" };
    if (status === 'missed') return { text: "–ü—Ä–æ–ø—É—â–µ–Ω–æ", color: "text-red-400" };

    const [h, m] = task.t_hhmm.split(':').map(Number);
    const currentMaskIdx = now.getDay() === 0 ? 6 : now.getDay() - 1;

    let daysUntil = -1;
    let nextDate = new Date(now);

    const isTodayInMask = (task.days_mask & (1 << currentMaskIdx)) !== 0;
    const taskTimeToday = new Date(now);
    taskTimeToday.setHours(h, m, 0, 0);

    if (isTodayInMask && taskTimeToday > now) {
        daysUntil = 0;
        nextDate = taskTimeToday;
    } else {
        for (let i = 1; i <= 7; i++) {
            const nextIdx = (currentMaskIdx + i) % 7;
            if ((task.days_mask & (1 << nextIdx)) !== 0) {
                daysUntil = i;
                nextDate = new Date(now);
                nextDate.setDate(now.getDate() + i);
                nextDate.setHours(h, m, 0, 0);
                break;
            }
        }
    }

    if (daysUntil === -1) return { text: "–ù–µ—Ç –¥–Ω–µ–π", color: "text-slate-600" };

    const diffMs = nextDate.getTime() - now.getTime();
    const totalSeconds = Math.floor(diffMs / 1000);
    const d = Math.floor(totalSeconds / (3600 * 24));
    const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
    const mins = Math.floor((totalSeconds % 3600) / 60);
    const secs = totalSeconds % 60;

    let text = "";
    if (d > 0) text = `${d}–¥ ${hours}—á`;
    else if (hours > 0) text = `${hours}—á ${mins}–º`;
    else text = `${mins}–º ${secs}—Å`;

    let color = "text-slate-400";
    if (d === 0 && hours < 1) color = "text-yellow-400 animate-pulse";
    if (d === 0 && hours === 0 && mins < 5) color = "text-red-400 animate-pulse";

    return { text, color };
  };

  const handleEdit = () => {
    if (!selectedTask) return;
    setEditingTask(selectedTask);
    setModalOpen(true);
  };

  const handleDelete = (e: React.MouseEvent) => {
    e.stopPropagation(); 
    if (!selectedTask) return;
    
    if (window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ¬´${selectedTask.title}¬ª?`)) {
      onDelete(selectedTask.id);
      setSelectedId(null);
      toast.success("–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞");
    }
  };

  const handleToggle = () => {
    if (!selectedTask) return;
    onUpdate({ ...selectedTask, enabled: !selectedTask.enabled });
  };

  const handleSave = (taskData: Omit<Task, 'id'>, id?: number) => {
    if (id) {
      onUpdate({ ...taskData, id });
    } else {
      onAdd(taskData);
    }
    setModalOpen(false);
    setEditingTask(null);
  };

  const sortedTasks = getSortedTasks();

  return (
    <div className="flex h-full gap-6">
      <div className="w-5/12 flex flex-col gap-4">
        <GlassCard className="flex-1 flex flex-col" noPadding>
            <div className="p-4 border-b border-white/10 flex justify-between items-center bg-slate-800/50">
                <h2 className="font-semibold text-lg">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>
                <Button variant="primary" onClick={() => { setEditingTask(null); setModalOpen(true); }} className="px-3 py-1 text-sm">
                    <Plus size={16} />
                </Button>
            </div>
            <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">
                {tasks.length === 0 && <div className="text-center text-slate-500 py-10">–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç</div>}
                {sortedTasks.map(t => {
                    const status = getTaskStatus(t);
                    const countdown = getTimeRemaining(t);
                    const isActive = selectedId === t.id;

                    const statusStyles: Record<TaskStatus, string> = {
                      completed: 'bg-green-500/10 border-green-500/30 text-green-200',
                      missed: 'bg-red-500/10 border-red-500/30 text-red-200',
                      upcoming: isActive ? 'bg-cyan-500/20 border-cyan-500/50' : 'hover:bg-white/5 border-transparent',
                      disabled: 'opacity-40 grayscale-[0.5]'
                    };

                    return (
                        <div 
                            key={t.id}
                            onClick={() => setSelectedId(t.id)}
                            className={`p-3 rounded-xl cursor-pointer flex items-center gap-3 transition-all border ${statusStyles[status]}`}
                        >
                            <div className={`w-3 h-3 rounded-full shrink-0 ${
                                status === 'completed' ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]' :
                                status === 'missed' ? 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]' :
                                t.enabled ? 'bg-cyan-400 shadow-[0_0_8px_rgba(34,211,238,0.6)]' : 'bg-slate-600'
                            }`} />
                            <div className="flex flex-col">
                                <span className={`font-mono text-sm leading-none ${status === 'upcoming' ? 'text-cyan-200' : ''}`}>
                                  {t.t_hhmm}
                                </span>
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="truncate font-medium text-sm">{t.title}</div>
                                <div className={`text-[10px] flex items-center gap-1 ${countdown.color}`}>
                                    {status === 'upcoming' && <Clock size={10} />}
                                    {status === 'missed' && <AlertCircle size={10} />}
                                    {status === 'completed' && <Check size={10} />}
                                    {countdown.text}
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        </GlassCard>
      </div>

      <div className="w-7/12 flex flex-col">
        <GlassCard className="flex-1 flex flex-col">
            {selectedTask ? (
                <>
                    <div className="flex justify-between items-start mb-6">
                        <div className="flex-1">
                            <h2 className="text-2xl font-bold text-white mb-2">{selectedTask.title}</h2>
                            <div className="flex flex-wrap gap-2 text-sm text-slate-400">
                                <span className="bg-slate-950 px-2 py-1 rounded border border-white/10">{selectedTask.t_hhmm}</span>
                                <span className="bg-slate-950 px-2 py-1 rounded border border-white/10">{getDaysString(selectedTask.days_mask)}</span>
                                <span className={`px-2 py-1 rounded border border-white/10 ${selectedTask.enabled ? 'text-green-400 bg-green-900/20' : 'text-slate-500'}`}>
                                    {selectedTask.enabled ? '–í–ö–õ' : '–í–´–ö–õ'}
                                </span>
                            </div>
                        </div>
                        <div className="bg-slate-950 px-4 py-3 rounded-xl text-right border border-white/5 shadow-inner">
                             <div className="text-[10px] text-slate-500 mb-1 uppercase tracking-widest font-bold">–°—Ç–∞—Ç—É—Å</div>
                             <div className={`font-mono font-bold text-lg ${getTimeRemaining(selectedTask).color}`}>
                                {getTimeRemaining(selectedTask).text}
                             </div>
                        </div>
                    </div>
                    
                    <div className="bg-slate-950/30 rounded-xl p-4 border border-white/5 flex-1 mb-6 overflow-y-auto">
                        <h3 className="text-[10px] uppercase tracking-wider text-slate-500 mb-2 font-bold">–ó–∞–º–µ—Ç–∫–∏</h3>
                        <p className="whitespace-pre-wrap text-slate-300 text-sm leading-relaxed">
                          {selectedTask.notes || "–ó–∞–º–µ—Ç–æ–∫ –Ω–µ—Ç."}
                        </p>
                    </div>

                    {(() => {
                        const status = getTaskStatus(selectedTask);
                        
                        if (status === 'upcoming' || status === 'missed') {
                            return (
                                <Button 
                                    onClick={() => onComplete(selectedTask.id)} 
                                    variant="primary" 
                                    className={`w-full mb-3 py-4 text-lg font-bold shadow-lg transition-all ${
                                      status === 'missed' 
                                      ? 'bg-red-500/20 text-red-300 border-red-500/50 hover:bg-red-500/30' 
                                      : 'bg-green-600 hover:bg-green-500 text-white border-green-500/50'
                                    }`}
                                >
                                    <Check size={20} /> 
                                    {status === 'missed' ? '–ó–∞–∫—Ä—ã—Ç—å –¥–æ–ª–≥ (+15 XP)' : '–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º (+15 XP)'}
                                </Button>
                            );
                        } else if (status === 'completed') {
                            return (
                                <div className="w-full bg-green-950/30 border border-green-500/30 text-green-400 rounded-xl flex items-center justify-center gap-2 mb-3 py-4 font-bold animate-in fade-in zoom-in-95">
                                    <Check size={20} /> –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è
                                </div>
                            );
                        }
                        return null;
                    })()}

                    <div className="flex gap-3">
                        <Button onClick={handleToggle} variant="secondary" className="flex-1 h-12">
                            <Power size={18} className={selectedTask.enabled ? "text-green-400" : "text-slate-400"} />
                            {selectedTask.enabled ? "–í—ã–∫–ª" : "–í–∫–ª"}
                        </Button>
                        <Button onClick={handleEdit} variant="secondary" className="flex-1 h-12">
                            <Edit3 size={18} /> –ü—Ä–∞–≤–∫–∞
                        </Button>
                        <Button onClick={handleDelete} variant="danger" className="flex-1 h-12">
                            <Trash2 size={18} />
                        </Button>
                    </div>
                </>
            ) : (
                <div className="h-full flex flex-col items-center justify-center text-slate-600">
                    <LayoutDashboard size={64} className="mb-4 opacity-10" />
                    <p className="font-medium">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</p>
                </div>
            )}
        </GlassCard>
      </div>

      {isModalOpen && (
        <TaskModal 
            task={editingTask} 
            onClose={() => setModalOpen(false)} 
            onSave={handleSave} 
        />
      )}
    </div>
  );
};

const TaskModal: React.FC<{ task: Task | null, onClose: () => void, onSave: (t: Omit<Task, 'id'>, id?: number) => void }> = ({ task, onClose, onSave }) => {
    const [title, setTitle] = useState(task?.title || '');
    const [time, setTime] = useState(task?.t_hhmm || '12:00');
    const [days, setDays] = useState(task?.days_mask ?? 127);
    const [enabled, setEnabled] = useState(task?.enabled ?? true);
    const [notes, setNotes] = useState(task?.notes || '');

    const toggleDay = (idx: number) => {
        setDays(prev => prev ^ (1 << idx));
    };

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
            <GlassCard className="w-full max-w-md animate-in fade-in zoom-in duration-200 border-white/20">
                <h3 className="text-xl font-bold mb-6 text-white flex items-center gap-2">
                  <Edit3 size={20} className="text-cyan-400" />
                  {task ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–ù–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'}
                </h3>
                
                <div className="space-y-5">
                    <div>
                        <label className="block text-[10px] uppercase font-bold text-slate-500 mb-1.5 ml-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input value={title} onChange={e => setTitle(e.target.value)} className="w-full bg-slate-950 border border-white/10 rounded-xl p-3 text-white focus:border-cyan-500 outline-none transition-all" placeholder="–ù–∞–ø—Ä: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–æ–≥" />
                    </div>
                    
                    <div className="flex gap-4">
                      <div className="flex-1">
                          <label className="block text-[10px] uppercase font-bold text-slate-500 mb-1.5 ml-1">–í—Ä–µ–º—è</label>
                          <input type="time" value={time} onChange={e => setTime(e.target.value)} className="w-full bg-slate-950 border border-white/10 rounded-xl p-3 text-white focus:border-cyan-500 outline-none transition-all" />
                      </div>
                      <div className="flex items-end pb-1">
                          <label className="flex items-center gap-2 cursor-pointer bg-slate-900 px-4 py-3 rounded-xl border border-white/5 hover:bg-slate-800 transition-colors">
                              <input type="checkbox" checked={enabled} onChange={e => setEnabled(e.target.checked)} className="w-4 h-4 rounded accent-cyan-500" />
                              <span className="text-sm font-bold text-slate-300">–ê–∫—Ç–∏–≤–Ω–∞</span>
                          </label>
                      </div>
                    </div>

                    <div>
                        <label className="block text-[10px] uppercase font-bold text-slate-500 mb-1.5 ml-1">–î–Ω–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</label>
                        <div className="flex justify-between gap-1.5">
                            {DAYS.map((d, i) => {
                                const active = (days & (1 << i)) !== 0;
                                return (
                                    <button 
                                        key={d} 
                                        type="button"
                                        onClick={() => toggleDay(i)}
                                        className={`flex-1 h-10 rounded-lg text-xs font-bold transition-all border ${active ? 'bg-cyan-600 text-white border-cyan-400 shadow-[0_0_10px_rgba(6,182,212,0.3)]' : 'bg-slate-950 text-slate-500 border-white/5 hover:bg-slate-900'}`}
                                    >
                                        {d}
                                    </button>
                                )
                            })}
                        </div>
                    </div>

                    <div>
                        <label className="block text-[10px] uppercase font-bold text-slate-500 mb-1.5 ml-1">–ó–∞–º–µ—Ç–∫–∏ –∏ –¥–µ—Ç–∞–ª–∏</label>
                        <textarea value={notes} onChange={e => setNotes(e.target.value)} className="w-full bg-slate-950 border border-white/10 rounded-xl p-3 text-white focus:border-cyan-500 outline-none h-28 resize-none text-sm transition-all" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..." />
                    </div>
                </div>

                <div className="flex justify-end gap-3 mt-8">
                    <Button variant="ghost" onClick={onClose} className="px-6">–û—Ç–º–µ–Ω–∞</Button>
                    <Button variant="primary" className="px-8 bg-cyan-600 hover:bg-cyan-500 text-white border-none shadow-lg" onClick={() => {
                        if (!title.trim()) return toast.error('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
                        onSave({
                            title: title.trim(),
                            t_hhmm: time,
                            days_mask: days,
                            enabled,
                            notes,
                            last_notified: task?.last_notified || null
                        }, task?.id);
                    }}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</Button>
                </div>
            </GlassCard>
        </div>
    );
};
</file>

<file path="README.md">
<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# Run and deploy your AI Studio app

This contains everything you need to run your app locally.

View your app in AI Studio: https://ai.studio/apps/drive/1hCw94TBUE1SfX5Nk-gSCzUnW44xnM0bi

## Run Locally

**Prerequisites:**  Node.js


1. Install dependencies:
   `npm install`
2. Set the `GEMINI_API_KEY` in [.env.local](.env.local) to your Gemini API key
3. Run the app:
   `npm run dev`
</file>

<file path="services/ai.ts">
import { AIOptions } from '../types';

const USDA_API_KEY = "LucFuL58oA83Lr1aTuhFVYmz1jbZgmvGgTD9I67k";

export class AIService {
    private nanoSession: any | null = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ Chrome Built-in AI (Gemini Nano)
    private async createNewSession(onProgress?: (msg: string) => void): Promise<any | null> {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API (–Ω–æ–≤—ã–µ –∏ —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        const modelApi = (window as any).ai?.languageModel || (window as any).ai?.assistant;

        if (!modelApi) {
            console.warn("AI Service: Chrome Built-in AI –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.");
            return null;
        }

        try {
            const capabilities = await modelApi.capabilities();
            if (capabilities.available === 'no') {
                console.warn("AI Service: –ú–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.");
                return null;
            }

            // –ï—Å–ª–∏ –º–æ–¥–µ–ª—å —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è, —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º
            if (capabilities.available === 'after-download') {
                if (onProgress) onProgress("–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –ò–ò (–∂–¥–∏—Ç–µ)...");
            }

            // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é —Å —Ç–∞–π–º–∞—É—Ç–æ–º 10 —Å–µ–∫—É–Ω–¥
            const sessionPromise = modelApi.create({
                systemPrompt: "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–∏—Ç–∞–Ω–∏—é –∏ —Ñ–∏—Ç–Ω–µ—Å—É. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∏–∑–≤–ª–µ–∫–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –æ—Ç–≤–µ—á–∞—Ç—å –∫—Ä–∞—Ç–∫–æ. –í—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä–∞–π—Å—è –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π JSON, –µ—Å–ª–∏ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç.",
                temperature: 0.3,
                topK: 3
            });

            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error("AI_TIMEOUT")), 10000)
            );

            return await Promise.race([sessionPromise, timeoutPromise]);
        } catch (e) {
            console.error("AI Service: –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
            return null;
        }
    }

    private async translateToEnglish(text: string): Promise<string> {
        if (!/[–∞-—è–ê-–Ø—ë–Å]/.test(text)) return text;
        try {
            const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=en&dt=t&q=${encodeURIComponent(text)}`);
            const data = await res.json();
            return data?.[0]?.[0]?.[0] || text;
        } catch (e) {
            return text;
        }
    }

    private parseSimple(text: string): { food: string, weight: number } {
        const match = text.match(/(\d+)/);
        const weight = match ? parseInt(match[0]) : 100;
        const food = text.replace(/\d+/g, '').replace(/(–≥|–≥—Ä|–≥—Ä–∞–º–º|grams|g)\.?/g, '').trim();
        return { food, weight };
    }

    private async fetchFromUSDA(foodName: string, weightGrams: number): Promise<any> {
        try {
            const searchRes = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(foodName)}&pageSize=1&api_key=${USDA_API_KEY}`);
            const searchData = await searchRes.json();

            if (!searchData.foods || searchData.foods.length === 0) return { kcal: 0, protein: 0, fat: 0, carbs: 0 };

            const food = searchData.foods[0];
            let kcal = 0, p = 0, f = 0, c = 0;

            food.foodNutrients.forEach((n: any) => {
                const name = n.nutrientName.toLowerCase();
                if (name.includes('energy') && n.unitName.toLowerCase() === 'kcal') kcal = n.value;
                if (name.includes('protein')) p = n.value;
                if (name.includes('total lipid') || name === 'fat') f = n.value;
                if (name.includes('carbohydrate')) c = n.value;
            });

            const mult = weightGrams / 100;
            return {
                kcal: Math.round(kcal * mult),
                protein: parseFloat((p * mult).toFixed(1)),
                fat: parseFloat((f * mult).toFixed(1)),
                carbs: parseFloat((c * mult).toFixed(1))
            };
        } catch (e) {
            return { kcal: 0, protein: 0, fat: 0, carbs: 0 };
        }
    }

    async analyzeFood(foodDescription: string, onProgress?: (msg: string) => void): Promise<any> {
        try {
            if (onProgress) onProgress("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ò–ò...");
            this.nanoSession = await this.createNewSession(onProgress);

            let parsed: any = null;

            if (this.nanoSession) {
                if (onProgress) onProgress("AI –ê–Ω–∞–ª–∏–∑...");
                const resultStr = await this.nanoSession.prompt(`–ò–∑–≤–ª–µ–∫–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –≤–µ—Å –≤ –≥—Ä–∞–º–º–∞—Ö –∏–∑: "${foodDescription}". –í–µ—Ä–Ω–∏ JSON: {"food": "name", "weight": 100}`);
                const jsonMatch = resultStr.match(/\{[\s\S]*?\}/);
                if (jsonMatch) {
                    try { parsed = JSON.parse(jsonMatch[0]); } catch (e) {}
                }
            }

            if (!parsed) {
                if (onProgress) onProgress("–ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–±–æ—Ä...");
                parsed = this.parseSimple(foodDescription);
            }

            if (onProgress) onProgress("–ü–µ—Ä–µ–≤–æ–¥...");
            parsed.food = await this.translateToEnglish(parsed.food);

            if (onProgress) onProgress(`–ü–æ–∏—Å–∫: ${parsed.food}...`);
            return await this.fetchFromUSDA(parsed.food, parsed.weight);
        } catch (e) {
            console.error("AI Analysis Error:", e);
            return null;
        } finally {
            if (this.nanoSession?.destroy) {
                this.nanoSession.destroy();
                this.nanoSession = null;
            }
        }
    }

    async generateHistorySummary(historyDataStr: string, onProgress?: (msg: string) => void): Promise<string | null> {
        try {
            if (onProgress) onProgress("–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...");
            this.nanoSession = await this.createNewSession(onProgress);
            if (!this.nanoSession) return "–õ–æ–∫–∞–ª—å–Ω—ã–π –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Chrome.";

            return await this.nanoSession.prompt(`–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –¥–∞–π 3 —Å–æ–≤–µ—Ç–∞ —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ: \n${historyDataStr}`);
        } catch (e) {
            return "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞.";
        } finally {
            if (this.nanoSession?.destroy) this.nanoSession.destroy();
        }
    }

    async parseSportEntry(text: string, onProgress?: (msg: string) => void): Promise<any> {
        try {
            if (onProgress) onProgress("–ü–∞—Ä—Å–∏–Ω–≥...");
            this.nanoSession = await this.createNewSession(onProgress);
            if (!this.nanoSession) return null;

            const prompt = `–†–∞–∑–±–µ—Ä–∏ —Ç–µ–∫—Å—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –í–µ—Ä–Ω–∏ JSON —Å –∫–ª—é—á–∞–º–∏: "name" (–Ω–∞–∑–≤–∞–Ω–∏–µ), "details" (–ø–æ–¥—Ö–æ–¥—ã/–ø–æ–≤—Ç–æ—Ä—ã), "weight" (–≤–µ—Å). –¢–µ–∫—Å—Ç: "${text}"`;
            const result = await this.nanoSession.prompt(prompt);
            const jsonMatch = result.match(/\{[\s\S]*?\}/);
            return jsonMatch ? JSON.parse(jsonMatch[0]) : null;
        } catch (e) {
            return null;
        } finally {
            if (this.nanoSession?.destroy) this.nanoSession.destroy();
        }
    }
}

export const ai = new AIService();
</file>

<file path="services/repository.ts">
import { AppData, Task, UserProfile, FoodEntry, SportEntry, RANKS, PurchaseEntry, ChestType, RewardType, HABITS } from '../types';

const DB_KEY = 'daily_organizer_db_v1';

const DEFAULT_PROFILE: UserProfile = {
  weight: 0,
  body_fat: 0,
  avatar_path: '',
  xp: 0,
  coins: 0,
  streak: 0,
  has_freeze: false,
  golden_hour_expires: null,
  last_active: '',
  last_seen_rank_index: 0,
  daily_xp: 0,
  last_daily_reset: '',
  chest_inventory: []
};

const getInitialData = (): AppData => ({
  tasks: [],
  foodEntries: [],
  sportEntries: [],
  waterEntries: {},
  userProfile: { ...DEFAULT_PROFILE },
  weightLog: {},
  habitEntries: [],
  achievements: {},
  purchaseHistory: []
});

export class Repository {
  private data: AppData;

  constructor() {
    const stored = localStorage.getItem(DB_KEY);
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        this.data = { ...getInitialData(), ...parsed };
        this.data.userProfile = { ...DEFAULT_PROFILE, ...(parsed.userProfile || {}) };
        
        if (!Array.isArray(this.data.tasks)) this.data.tasks = [];
        if (!Array.isArray(this.data.foodEntries)) this.data.foodEntries = [];
        if (!Array.isArray(this.data.sportEntries)) this.data.sportEntries = [];
        if (!Array.isArray(this.data.habitEntries)) this.data.habitEntries = [];
        if (!Array.isArray(this.data.purchaseHistory)) this.data.purchaseHistory = [];
        if (!Array.isArray(this.data.userProfile.chest_inventory)) this.data.userProfile.chest_inventory = [];
        if (typeof this.data.waterEntries !== 'object' || this.data.waterEntries === null) this.data.waterEntries = {};
        if (typeof this.data.weightLog !== 'object' || this.data.weightLog === null) this.data.weightLog = {};
        if (typeof this.data.achievements !== 'object' || this.data.achievements === null) this.data.achievements = {};
      } catch (e) {
        this.data = getInitialData();
      }
    } else {
      this.data = getInitialData();
      this.save();
    }
  }

  private save() {
    try {
      localStorage.setItem(DB_KEY, JSON.stringify(this.data));
    } catch (e) {
      console.error("CRITICAL: Failed to save data", e);
    }
  }

  exportData(): string { return JSON.stringify(this.data, null, 2); }

  importData(jsonString: string): boolean {
      try {
          const parsed = JSON.parse(jsonString);
          if (!parsed.userProfile || !Array.isArray(parsed.tasks)) throw new Error("Invalid structure");
          this.data = { ...getInitialData(), ...parsed };
          this.save();
          return true;
      } catch (e) {
          return false;
      }
  }

  getData(): AppData { return { ...this.data }; }
  getTasks(): Task[] { return [...this.data.tasks].sort((a, b) => a.t_hhmm.localeCompare(b.t_hhmm)); }
  getFoodEntries(date: string): FoodEntry[] { return this.data.foodEntries.filter(e => e.date_str === date); }
  getSportEntries(date: string): SportEntry[] { return this.data.sportEntries.filter(e => e.date_str === date); }
  getWater(date: string): number { return this.data.waterEntries[date] || 0; }
  getHabits(date: string): string[] { return this.data.habitEntries.filter(h => h.date_str === date).map(h => h.name); }
  getProfile(): UserProfile { return this.data.userProfile; }
  getWeightHistory(): { date: string, weight: number }[] {
    return Object.entries(this.data.weightLog)
      .map(([date, weight]) => ({ date, weight }))
      .sort((a, b) => a.date.localeCompare(b.date));
  }
  getHistoryDates(): string[] {
    const dates = new Set<string>();
    this.data.foodEntries.forEach(e => dates.add(e.date_str));
    this.data.sportEntries.forEach(e => dates.add(e.date_str));
    Object.keys(this.data.waterEntries).forEach(d => dates.add(d));
    return Array.from(dates).sort((a, b) => b.localeCompare(a));
  }
  getPurchaseHistory(): PurchaseEntry[] { return [...this.data.purchaseHistory].sort((a, b) => b.id - a.id); }

  addTask(task: Omit<Task, 'id'>) {
    const id = Date.now();
    this.data.tasks.push({ ...task, id });
    this.save();
    return id;
  }
  updateTask(task: Task) {
    const idx = this.data.tasks.findIndex(t => t.id === task.id);
    if (idx !== -1) { this.data.tasks[idx] = task; this.save(); }
  }
  deleteTask(id: number) { this.data.tasks = this.data.tasks.filter(t => t.id !== id); this.save(); }
  addFood(entry: Omit<FoodEntry, 'id'>) {
    const id = Date.now();
    this.data.foodEntries.push({ ...entry, id });
    this.save();
    return id;
  }
  completeTask(id: number, dateStr: string) {
      const task = this.data.tasks.find(t => t.id === id);
      if (task && task.last_completed !== dateStr) {
          task.last_completed = dateStr;
          this.addXp(15); // –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ —Å—Ä–æ–∫
          this.save();
      }
  }
  deleteFood(id: number) { this.data.foodEntries = this.data.foodEntries.filter(f => f.id !== id); this.save(); }
  addSport(entry: Omit<SportEntry, 'id'>) {
    const id = Date.now();
    this.data.sportEntries.push({ ...entry, id });
    this.save();
    return id;
  }
  deleteSport(id: number) { this.data.sportEntries = this.data.sportEntries.filter(s => s.id !== id); this.save(); }
  setWater(date: string, amount: number) { this.data.waterEntries[date] = amount; this.save(); }
  toggleHabit(date: string, name: string): boolean {
    const idx = this.data.habitEntries.findIndex(h => h.date_str === date && h.name === name);
    if (idx !== -1) { this.data.habitEntries.splice(idx, 1); this.save(); return false; }
    else { this.data.habitEntries.push({ date_str: date, name }); this.save(); return true; }
  }

  // –í —Ñ–∞–π–ª–µ services/repository.ts

  updateProfile(p: Partial<UserProfile>) {
    // –í–ê–ñ–ù–û: –ú—ã —Å–æ–∑–¥–∞–µ–º —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–æ–≤—É—é –∫–æ–ø–∏—é –æ–±—ä–µ–∫—Ç–∞ this.data.
    // –≠—Ç–æ —Å–∏–≥–Ω–∞–ª –¥–ª—è React, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å Sidebar.
    this.data = {
      ...this.data,
      userProfile: { 
        ...this.data.userProfile, 
        ...p 
      }
    };
    this.save();
  }
  updateLastSeenRank(idx: number) { this.data.userProfile.last_seen_rank_index = idx; this.save(); }
  logWeight(date: string, weight: number) { this.data.weightLog[date] = weight; this.save(); }

  addXp(amount: number) {
    let finalAmount = amount;
    if (this.data.userProfile.golden_hour_expires && Date.now() < this.data.userProfile.golden_hour_expires) finalAmount = amount * 2;
    this.data.userProfile.xp += finalAmount;
    // this.data.userProfile.coins += finalAmount;
    this.data.userProfile.daily_xp += finalAmount;
    if (this.data.userProfile.xp < 0) this.data.userProfile.xp = 0;
    if (this.data.userProfile.coins < 0) this.data.userProfile.coins = 0;
    this.data.userProfile.daily_xp = Math.max(0, this.data.userProfile.daily_xp);
    this.save();
    return finalAmount;
  }

  private addPurchaseLog(item_name: string, cost: number, category: 'bonus' | 'food' | 'dopamine') {
      const entry: PurchaseEntry = {
          id: Date.now() + Math.random(),
          date_str: new Date().toISOString().split('T')[0],
          item_name,
          cost,
          category
      };
      this.data.purchaseHistory.push(entry);
      if (this.data.purchaseHistory.length > 100) this.data.purchaseHistory.shift();
  }

  deletePurchaseEntry(id: number) {
      this.data.purchaseHistory = this.data.purchaseHistory.filter(p => p.id !== id);
      this.save();
  }

  buyFreeze(cost: number): boolean {
    if (this.data.userProfile.coins >= cost) {
      this.data.userProfile.coins -= cost;
      this.data.userProfile.has_freeze = true;
      this.addPurchaseLog('–ó–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ç—Ä–∏–∫–∞', cost, 'bonus');
      this.save();
      return true;
    }
    return false;
  }

  buyGoldenDay(cost: number): boolean {
    if (this.data.userProfile.coins >= cost) {
      this.data.userProfile.coins -= cost;
      this.data.userProfile.golden_hour_expires = Date.now() + (24 * 60 * 60 * 1000); 
      this.addPurchaseLog('–ó–æ–ª–æ—Ç—ã–µ —Å—É—Ç–∫–∏', cost, 'bonus');
      this.save();
      return true;
    }
    return false;
  }

  buyReward(name: string, cost: number, category: 'food' | 'dopamine'): boolean {
      if (this.data.userProfile.coins >= cost) {
          this.data.userProfile.coins -= cost;
          this.addPurchaseLog(name, cost, category);
          this.save();
          return true;
      }
      return false;
  }

  unlockAchievement(code: string): boolean {
    if (this.data.achievements[code]) return false;
    this.data.achievements[code] = new Date().toISOString().split('T')[0];
    this.save();
    return true;
  }

  setAchievements(achievements: Record<string, string>) {
    this.data.achievements = achievements;
    this.save();
  }

  private getLogicalDate(): string {
      const d = new Date();
      d.setHours(d.getHours() - 4); 
      return d.toISOString().split('T')[0];
  }

  checkDailyReset() {
      const todayStr = this.getLogicalDate();
      const p = this.data.userProfile;
      
      if (!p.last_daily_reset) { 
          p.last_daily_reset = todayStr; 
          this.save(); 
          return; 
      }
      
      if (p.last_daily_reset !== todayStr) {
          const prevDate = p.last_daily_reset;
          
          // --- 1. –®–¢–†–ê–§ –ó–ê –ü–†–ò–í–´–ß–ö–ò (–≤–∞—à –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥) ---
          const completedHabitsCount = this.getHabits(prevDate).length;
          const missedHabitsCount = HABITS.length - completedHabitsCount;
          if (missedHabitsCount > 0) {
              const penalty = Math.floor((missedHabitsCount * 10) / 2);
              p.xp = Math.max(0, p.xp - penalty);
          }

          // --- 2. –®–¢–†–ê–§ –ó–ê –ò–ì–ù–û–†–ò–†–û–í–ê–ù–ò–ï –ó–ê–î–ê–ß ---
          // –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—ã–ª–æ –≤—á–µ—Ä–∞, –Ω–æ –∑–∞–¥–∞—á–∞ —Ç–∞–∫ –∏ –Ω–µ –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
          const missedTasks = this.data.tasks.filter(t => 
              t.last_notified === prevDate && t.last_completed !== prevDate
          );
          if (missedTasks.length > 0) {
              const taskPenalty = missedTasks.length * 15; // –®—Ç—Ä–∞—Ñ 15 XP –∑–∞ –∫–∞–∂–¥—É—é –ø—Ä–æ–ø—É—â–µ–Ω–Ω—É—é
              p.xp = Math.max(0, p.xp - taskPenalty);
          }

          // --- 3. –ü–†–û–ü–û–†–¶–ò–û–ù–ê–õ–¨–ù–´–ô –®–¢–†–ê–§ –ó–ê –í–û–î–£ –ò –ö–ê–õ–û–†–ò–ò ---
          const prevWater = this.getWater(prevDate);
          const prevFood = this.getFoodEntries(prevDate);
          const prevKcal = prevFood.reduce((sum, f) => sum + f.kcal, 0);

          const MAX_WATER_PENALTY = 30; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —à—Ç—Ä–∞—Ñ, –µ—Å–ª–∏ –≤–æ–¥—ã 0
          const MAX_KCAL_PENALTY = 50;  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —à—Ç—Ä–∞—Ñ, –µ—Å–ª–∏ —Å—ä–µ–¥–µ–Ω–æ 0 –∫–∫–∞–ª

          // –í–æ–¥–∞ (—Ü–µ–ª—å 3000)
          if (prevWater < 3000) {
              const deficitRatio = (3000 - prevWater) / 3000; // –æ—Ç 0.0 –¥–æ 1.0
              const waterPenalty = Math.floor(deficitRatio * MAX_WATER_PENALTY);
              p.xp = Math.max(0, p.xp - waterPenalty);
          }

          // –ö–∞–ª–æ—Ä–∏–∏ (—Ü–µ–ª—å 4000)
          if (prevKcal < 4000) {
              const deficitRatio = (4000 - prevKcal) / 4000; // –æ—Ç 0.0 –¥–æ 1.0
              const kcalPenalty = Math.floor(deficitRatio * MAX_KCAL_PENALTY);
              p.xp = Math.max(0, p.xp - kcalPenalty);
          }

          // –í—ã–¥–∞—á–∞ —Å—É–Ω–¥—É–∫–æ–≤
          let awardedChest: ChestType | null = null;
          if (p.daily_xp >= 600) awardedChest = ChestType.EPIC;
          else if (p.daily_xp >= 300) awardedChest = ChestType.RARE;
          else if (p.daily_xp >= 100) awardedChest = ChestType.COMMON;
          if (awardedChest) p.chest_inventory.push(awardedChest);
          
          p.daily_xp = 0;
          p.last_daily_reset = todayStr;
          
          this.save();
      }
  }
 
  processChestReward(chestIndex: number, type: RewardType, amount: number) {
      const p = this.data.userProfile;
      if (chestIndex >= 0 && chestIndex < p.chest_inventory.length) p.chest_inventory.splice(chestIndex, 1);
      if (type === RewardType.COINS) p.coins += amount;
      else if (type === RewardType.FREEZE) p.has_freeze = true;
      else if (type === RewardType.LIGHTNING) {
          const currentExpires = p.golden_hour_expires && p.golden_hour_expires > Date.now() ? p.golden_hour_expires : Date.now();
          p.golden_hour_expires = currentExpires + (24 * 60 * 60 * 1000);
      }
      this.save();
  }

  checkStreak() {
    this.checkDailyReset();
    const today = new Date().toISOString().split('T')[0];
    const yesterdayDate = new Date();
    yesterdayDate.setDate(yesterdayDate.getDate() - 1);
    const yesterday = yesterdayDate.toISOString().split('T')[0];
    const p = this.data.userProfile;
    if (p.last_active === today) return;
    if (p.last_active === yesterday) p.streak += 1;
    else {
      if (p.has_freeze) { p.has_freeze = false; p.streak += 1; }
      else p.streak = 1;
    }
    p.last_active = today;
    this.save();
  }
}

export const repo = new Repository();
</file>

<file path="start.bat">
@echo off
:: –¢–µ–ø–µ—Ä—å –Ω–∞–º –Ω–µ –Ω—É–∂–µ–Ω –ø—É—Ç—å, —Ç–∞–∫ –∫–∞–∫ —Ñ–∞–π–ª —É–∂–µ –≤ –ø–∞–ø–∫–µ
start /b npm run dev
timeout /t 5 /nobreak > nul
start chrome --app=http://localhost:3000
</file>

<file path="start.txt">

</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}
</file>

<file path="types.ts">
export interface Task {
  id: number;
  title: string;
  t_hhmm: string;
  days_mask: number; 
  enabled: boolean;
  notes: string;
  last_notified: string | null;
  last_completed?: string | null; // <-- –ù–û–í–û–ï –ü–û–õ–ï
}

export interface FoodEntry {
  id: number;
  date_str: string;
  phase: 'morning' | 'day' | 'evening';
  name: string;
  kcal: number;
  p: number;
  f: number;
  c: number;
}

export interface SportEntry {
  id: number;
  date_str: string;
  name: string;
  details: string;
  weight: string;
}

export interface UserProfile {
  weight: number;
  body_fat: number;
  avatar_path: string;
  xp: number;
  coins: number;
  streak: number;
  has_freeze: boolean;
  golden_hour_expires: number | null;
  last_active: string;
  last_seen_rank_index: number;
  daily_xp: number;          
  last_daily_reset: string;  
  chest_inventory: ChestType[]; 
}

export interface PurchaseEntry {
  id: number;
  date_str: string;
  item_name: string;
  cost: number;
  category: 'bonus' | 'food' | 'dopamine';
}

export interface Achievement {
  code: string;
  name: string;
  desc: string;
}

export interface AppData {
  tasks: Task[];
  foodEntries: FoodEntry[];
  sportEntries: SportEntry[];
  waterEntries: Record<string, number>; 
  userProfile: UserProfile;
  weightLog: Record<string, number>; 
  habitEntries: { date_str: string; name: string }[];
  achievements: Record<string, string>; 
  purchaseHistory: PurchaseEntry[];
}

export enum ChestType {
  COMMON = 'COMMON',
  RARE = 'RARE',
  EPIC = 'EPIC',
}

export enum RewardType {
  COINS = 'COINS',
  FREEZE = 'FREEZE',
  LIGHTNING = 'LIGHTNING',
}

export const RANKS = [
  { threshold: 0, title: "ü™µ –î–µ—Ä–µ–≤–æ I", color: "from-amber-800 to-amber-600", cardBg: "bg-amber-900", cardBorder: "border-amber-800" },
  { threshold: 500, title: "ü™µ –î–µ—Ä–µ–≤–æ II", color: "from-amber-700 to-amber-500", cardBg: "bg-amber-950", cardBorder: "border-amber-900" },
  { threshold: 1500, title: "üî© –ñ–µ–ª–µ–∑–æ I", color: "from-slate-500 to-slate-400", cardBg: "bg-slate-700", cardBorder: "border-slate-600" },
  { threshold: 3000, title: "üî© –ñ–µ–ª–µ–∑–æ II", color: "from-slate-400 to-slate-300", cardBg: "bg-slate-800", cardBorder: "border-slate-700" },
  { threshold: 6000, title: "ü•â –ë—Ä–æ–Ω–∑–∞", color: "from-orange-700 to-orange-500", cardBg: "bg-orange-900", cardBorder: "border-orange-800" },
  { threshold: 12000, title: "ü•à –°–µ—Ä–µ–±—Ä–æ", color: "from-gray-300 to-gray-100", cardBg: "bg-zinc-700", cardBorder: "border-zinc-600" },
  { threshold: 25000, title: "ü•á –ó–æ–ª–æ—Ç–æ", color: "from-yellow-500 to-yellow-300", cardBg: "bg-yellow-900", cardBorder: "border-yellow-800" },
  { threshold: 50000, title: "üí† –ê–ª–º–∞–∑", color: "from-cyan-500 to-cyan-300", cardBg: "bg-cyan-900", cardBorder: "border-cyan-800" },
  { threshold: 100000, title: "üëë –ú–∞—Å—Ç–µ—Ä", color: "from-purple-600 to-purple-400", cardBg: "bg-purple-900", cardBorder: "border-purple-800" },
  { threshold: 250000, title: "üíé Global Elite", color: "from-rose-600 to-rose-400 shadow-[0_0_20px_rgba(225,29,72,0.6)]", cardBg: "bg-rose-900", cardBorder: "border-rose-800" }
];

export const ACHIEVEMENTS_LIST: Achievement[] = [
  { code: "monk_mode", name: "–ú–æ–Ω–∞—Ö", desc: "–°—Ç—Ä–∏–∫ 30 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥" },
  { code: "giga_chad", name: "–ì–∏–≥–∞—á–∞–¥", desc: "–ù–∞–±—Ä–∞—Ç—å 50 000 XP" },
  { code: "burnout", name: "–¢–æ–ø–∫–∞", desc: "–°—ä–µ—Å—Ç—å 4000+ –∫–∫–∞–ª –∑–∞ –¥–µ–Ω—å" },
  { code: "hydro_homie", name: "–í–æ–¥–æ–∫–∞—á–∫–∞", desc: "–í—ã–ø–∏—Ç—å 4 –ª–∏—Ç—Ä–∞ –≤–æ–¥—ã" },
  { code: "iron_temple", name: "–•—Ä–∞–º –∂–µ–ª–µ–∑–∞", desc: "5 –∑–∞–ø–∏—Å–µ–π —Å–ø–æ—Ä—Ç–∞ –∑–∞ –¥–µ–Ω—å" },
  { code: "habit_god", name: "–ë–æ–≥ –ø—Ä–∏–≤—ã—á–µ–∫", desc: "–í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∑–∞ –¥–µ–Ω—å" },
  { code: "early_riser", name: "5 —É—Ç—Ä–∞", desc: "–í—ã–ø–æ–ª–Ω–∏—Ç—å —É—Ç—Ä–µ–Ω–Ω—é—é —Ä—É—Ç–∏–Ω—É –¥–æ 6:00" },
  { code: "night_watch", name: "–ù–æ—á–Ω–æ–π –¥–æ–∂–æ—Ä", desc: "–ü–æ–µ—Å—Ç—å –ø–æ—Å–ª–µ 23:00" },
  { code: "marathon", name: "–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü", desc: "–°—Ç—Ä–∏–∫ 100 –¥–Ω–µ–π" },
  { code: "completionist", name: "–ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç", desc: "–í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –¥–µ–Ω—å" }
];

export const HABITS = [
  "–ó–æ–ª–æ—Ñ—Ç", "CS 2", "Clash Royale", "–°–∞–º–æ–∞–Ω–∞–ª–∏–∑", "–î–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏—è",
  "–ß–∏—Å—Ç–∫–∞ –∑—É–±–æ–≤", "–°—Ç–∏–∫–µ—Ä", "–†–∞—Ä–∏ –ë—Ä–∏–∫", "–ê–π—Å–±–µ—Ä–≥–∏", "–ö—Ä–µ–∞—Ç–∏–Ω",
  "–¶–∏—Ç—Ä—É–ª–ª–∏–Ω", "–£–∑–Ω–∞—Ç—å –Ω–æ–≤–æ–µ", "–û–±—â–µ–Ω–∏–µ", "–ì–∏—Ç–∞—Ä–∞", "–°–∫–æ—Ä–æ–≥–æ–≤–æ—Ä–∫–∏"
];

export enum AppState {
  MENU = 'MENU',
  IDLE = 'IDLE',
  OPENING = 'OPENING',
  OPENED = 'OPENED'
}

export interface Reward {
  type: RewardType;
  amount: number;
}

export interface CoinData {
  position: [number, number, number];
  rotation: [number, number, number];
  scale: number;
}
</file>

<file path="vite.config.ts">
import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');
    return {
      server: {
        port: 3000,
        host: '0.0.0.0',
      },
      plugins: [react()],
      define: {
        'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY)
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      }
    };
});
</file>

</files>
